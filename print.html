<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js rust">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Head First Java Web</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="preface.html">Preface</a></li><li class="chapter-item expanded "><a href="ch1/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch1/1.1.html"><strong aria-hidden="true">1.1.</strong> Jakarta EE Overview</a></li><li class="chapter-item expanded "><a href="ch1/1.2.html"><strong aria-hidden="true">1.2.</strong> Your First Java Web Project</a></li><li class="chapter-item expanded "><a href="ch1/1.3.html"><strong aria-hidden="true">1.3.</strong> A Brief Introduction To HTML</a></li><li class="chapter-item expanded "><a href="ch1/1.4.html"><strong aria-hidden="true">1.4.</strong> A Brief Introduction To HTTP</a></li><li class="chapter-item expanded "><a href="ch1/1.5.html"><strong aria-hidden="true">1.5.</strong> Revisit The First Java Web Project</a></li><li class="chapter-item expanded "><a href="ch1/exercise.html"><strong aria-hidden="true">1.6.</strong> Exercise</a></li></ol></li><li class="chapter-item expanded "><a href="ch2/index.html"><strong aria-hidden="true">2.</strong> Web App Architecture And Mini MVC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch2/2.1.html"><strong aria-hidden="true">2.1.</strong> Servlet And Container</a></li><li class="chapter-item expanded "><a href="ch2/2.2.html"><strong aria-hidden="true">2.2.</strong> Search: The Way To Self-learning</a></li><li class="chapter-item expanded "><a href="ch2/2.3.html"><strong aria-hidden="true">2.3.</strong> A Brief Introduction To MVC</a></li><li class="chapter-item expanded "><a href="ch2/2.4.html"><strong aria-hidden="true">2.4.</strong> Hands On MVC (1)</a></li><li class="chapter-item expanded "><a href="ch2/2.5.html"><strong aria-hidden="true">2.5.</strong> Hands on MVC (2)</a></li><li class="chapter-item expanded "><a href="ch2/exercise.html"><strong aria-hidden="true">2.6.</strong> Exercise</a></li></ol></li><li class="chapter-item expanded "><a href="ch3/index.html"><strong aria-hidden="true">3.</strong> In-depth Servlet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch3/3.1.html"><strong aria-hidden="true">3.1.</strong> Servlet: From Birth To Death</a></li><li class="chapter-item expanded "><a href="ch3/3.2.html"><strong aria-hidden="true">3.2.</strong> Request And Response</a></li><li class="chapter-item expanded "><a href="ch3/3.3.html"><strong aria-hidden="true">3.3.</strong> More About Request</a></li><li class="chapter-item expanded "><a href="ch3/3.4.html"><strong aria-hidden="true">3.4.</strong> Upload Files In Servlets</a></li><li class="chapter-item expanded "><a href="ch3/3.5.html"><strong aria-hidden="true">3.5.</strong> More About Response (1)</a></li><li class="chapter-item expanded "><a href="ch3/3.6.html"><strong aria-hidden="true">3.6.</strong> More About Response (2)</a></li><li class="chapter-item expanded "><a href="ch3/exercise.html"><strong aria-hidden="true">3.7.</strong> Exercise</a></li></ol></li><li class="chapter-item expanded "><a href="ch4/index.html"><strong aria-hidden="true">4.</strong> In-depth Web</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch4/4.1.html"><strong aria-hidden="true">4.1.</strong> Init parameters</a></li><li class="chapter-item expanded "><a href="ch4/4.2.html"><strong aria-hidden="true">4.2.</strong> Attributes</a></li><li class="chapter-item expanded "><a href="ch4/4.3.html"><strong aria-hidden="true">4.3.</strong> Session Management (1)</a></li><li class="chapter-item expanded "><a href="ch4/4.4.html"><strong aria-hidden="true">4.4.</strong> Session Management (2)</a></li><li class="chapter-item expanded "><a href="ch4/exercise.html"><strong aria-hidden="true">4.5.</strong> Exercise</a></li></ol></li><li class="chapter-item expanded "><a href="ch5/index.html"><strong aria-hidden="true">5.</strong> JSP And Scriptless JSP</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch5/5.1.html"><strong aria-hidden="true">5.1.</strong> Facts About JSP</a></li><li class="chapter-item expanded "><a href="ch5/5.2.html"><strong aria-hidden="true">5.2.</strong> Expression Language</a></li><li class="chapter-item expanded "><a href="ch5/5.3.html"><strong aria-hidden="true">5.3.</strong> JSTL</a></li><li class="chapter-item expanded "><a href="ch5/exercise.html"><strong aria-hidden="true">5.4.</strong> Exercise</a></li></ol></li><li class="chapter-item expanded "><a href="ch6/index.html"><strong aria-hidden="true">6.</strong> Database</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch6/6.1.html"><strong aria-hidden="true">6.1.</strong> Introduction To Database</a></li><li class="chapter-item expanded "><a href="ch6/6.2.html"><strong aria-hidden="true">6.2.</strong> SQL (1)</a></li><li class="chapter-item expanded "><a href="ch6/6.3.html"><strong aria-hidden="true">6.3.</strong> SQL (2)</a></li><li class="chapter-item expanded "><a href="ch6/6.4.html"><strong aria-hidden="true">6.4.</strong> Accessing Databases From Java (1)</a></li><li class="chapter-item expanded "><a href="ch6/6.5.html"><strong aria-hidden="true">6.5.</strong> Accessing Databases From Java (2)</a></li><li class="chapter-item expanded "><a href="ch6/exercise.html"><strong aria-hidden="true">6.6.</strong> Exercise</a></li></ol></li><li class="chapter-item expanded "><a href="ch7/index.html"><strong aria-hidden="true">7.</strong> Thymeleaf</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ch7/7.1.html"><strong aria-hidden="true">7.1.</strong> Get Started With Thymeleaf</a></li><li class="chapter-item expanded "><a href="ch7/7.2.html"><strong aria-hidden="true">7.2.</strong> Standard Expression Syntax</a></li><li class="chapter-item expanded "><a href="ch7/exercise.html"><strong aria-hidden="true">7.3.</strong> Exercise</a></li></ol></li><li class="chapter-item expanded "><a href="ch9/index.html"><strong aria-hidden="true">8.</strong> Get Started With Spring</a></li><li class="chapter-item expanded "><a href="appendix/index.html"><strong aria-hidden="true">9.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="appendix/tomcat.html"><strong aria-hidden="true">9.1.</strong> A.1 Tomcat</a></li><li class="chapter-item expanded "><a href="appendix/idea.html"><strong aria-hidden="true">9.2.</strong> A.2 IntelliJ IDEA</a></li><li class="chapter-item expanded "><a href="appendix/jdk.html"><strong aria-hidden="true">9.3.</strong> A.3 JDK</a></li><li class="chapter-item expanded "><a href="appendix/gradle.html"><strong aria-hidden="true">9.4.</strong> A.4 Gradle</a></li><li class="chapter-item expanded "><a href="appendix/sqlite.html"><strong aria-hidden="true">9.5.</strong> A.5 SQLite</a></li><li class="chapter-item expanded "><a href="appendix/cloud.html"><strong aria-hidden="true">9.6.</strong> A.6 Cloud (1)</a></li><li class="chapter-item expanded "><a href="appendix/cloud2.html"><strong aria-hidden="true">9.7.</strong> A.7 Cloud (2)</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Head First Java Web</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="preface"><a class="header" href="#preface">Preface</a></h1>
<blockquote>
<p>This book is intended to serve as the textbook for real beginners (i.e., freshman or sophomore students) at <code>SWUFE</code>.</p>
</blockquote>
<p>If you have any suggestions, please feel free to contact me via email (zpchen@swufe.edu.cn).</p>
<p><img src="logo.png" alt="" title=":size=30%" /></p>
<p>Web development has evolved from a single plain page to a central component which supports a variety of applications for virtually all enterprises, and as a result, knowledge about web development techniques has become an essential part of an education in computer science, software engineering and information management. In this text, we present the fundamental concepts and techniques of web development in Java.</p>
<p>We assume only a familiarity with basic programming skills in Java. As a matter of fact, you may further pick up other popular programming languages, such as PHP, Python, Ruby, C#, or Go to develop a website in your future career. But please do no worry: <strong>all efforts would pay-off</strong>, as the concepts and techniques learned in this book will definitely enhance your understanding about programming, especially web development, and you will get comfortable when switching to an alternative platform.</p>
<p>This book is mainly inspired by <strong>Head First Servlets and JSP, 2nd Edition</strong> (short for <code>HFBook</code> in this text). Speaking of <code>HFBook</code>, we would take off our hat to it and admit that it is a fantastic hand-on book for real beginners, but it was written in 2008 based on J2EE 1.5[1], and during the last 13 years, the web development in Java has been progressed dramatically. Therefore, we think it is necessary to write a new book covering the state-of-the-art and best practices for people who are looking to grasp the latest skills for web development in Java.</p>
<p>In addition to the knowledge in the Java web domain, we also bring some material and basic tutorials with respect to <strong>tools</strong> into this book. Quoted from <em>The Missing Semester of Your CS Education</em> in MIT:</p>
<blockquote>
<p>Classes teach you all about advanced topics within CS, from operating systems to machine learning, but there’s one critical subject that’s rarely covered, and is instead left to students to figure out on their own: proficiency with their tools[2].</p>
</blockquote>
<p>Therefore, tools and tricks that are commonly used among modern developers in their daily coding routines will emphasized in this book.</p>
<h2 id="who-is-the-book-for"><a class="header" href="#who-is-the-book-for">Who is the book for?</a></h2>
<p>If you can answer &quot;yes&quot; to all of these:</p>
<ol>
<li>Do you know how to <strong>program in Java</strong> (you don't need to be a guru)?</li>
<li>Do you want to write a website on your own?</li>
</ol>
<p>this book is for you.</p>
<h2 id="what-is-missing-from-this-book"><a class="header" href="#what-is-missing-from-this-book">What is missing from this book?</a></h2>
<p>Similar to <code>HFBook</code>, in this text, we only focus on <code>Servlet</code>, an essential component in Java web profile [3]. Therefore, topics like <code>Jakarta XML</code>, <code>WebSocket</code>, <code>EJB</code> and <code>JMS</code> will not be covered in this book.</p>
<hr />
<p>[1] J2EE has renamed to Jakarta EE in 2018, and the latest version is Jakarta EE 9.</p>
<p>[2] The Missing Semester of Your CS Education, https://missing.csail.mit.edu/.</p>
<p>[3] Web profile is a subset of the full profile in Jakarta Enterprise Edition (Jakarta EE).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-1-introduction"><a class="header" href="#chapter-1-introduction">Chapter 1: Introduction</a></h1>
<p>Welcome to Java web! Virtually, websites have become the indispensable elements in our daily lives: you may glance at the news website (e.g., <code>bbc.com</code>) in the morning, and then share your memorable moments at the social website (e.g., <code>twitter.com</code>); after submitting your homework to your university website (e.g., <code>swufe.edu.cn</code>), you start to take a break and watch a cartoon at a stream video website (e.g., <code>netflix.com</code>). We have also witnessed the great success of various IT enterprises (e.g., Taobao, JD, and Amazon) as well as the overwhelming popularity of their services, and we may even imagine that one day we could build another world-class website. Well, it is absolutely possible. Facemash, the origin name of Facebook, was launched by Mark Zuckerberg in his Harvard dorm room. After reading this book, you should gain the same ability to build your own website.</p>
<p>Beside the websites, applications in smart phones, mainly Android and iOS, are in the limelight in recent years. Well, they are, in fact, sharing a common component (we usually call it <code>back-end</code>[1] in programming jargon). In other words, you are able to build such <code>back-end</code> using Java web techniques and then provide services for different platforms, such as web pages, Android, iOS, and even mini-programs[2]. As illustrated in Figure 1.1, the <code>back-end</code> is deployed in the remote server, so you can use one piece of Java code to support users with heterogeneous devices and systems by some prior agreement in terms of back-and-forth communications.</p>
<p><img src="ch1/image/chp1.png" alt="Figure 1.1 One back-end, multiple front-ends." title=":size=50%" /></p>
<p>In a nutshell, web technologies are so important and widely-used. This chapter briefly introduces the overview of Java web and basic concepts of web programming.</p>
<hr />
<p>[1] What we can see and interact (e.g., the buttons and textbox in the screen) is called <code>front-end</code>, and its counterpart (i.e., servers in the remote) is called <code>back-end</code>.</p>
<p>[2] Mini-programs are “sub-applications” within the WeChat ecosystem.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="11-jakarta-ee-overview"><a class="header" href="#11-jakarta-ee-overview">1.1 Jakarta EE Overview</a></h1>
<p>As we mentioned early, Java web, or formally Java web profile, is a subset of the full profile in Jakarta Enterprise Edition (Jakarta EE). To understand what exactly EE is, let's revisit Java Standard Edition (Java SE) firstly.</p>
<p>Here is a simple Java SE code snippet:</p>
<pre><code class="language-java">public class JavaSEHello {
    public static void main(String args[]) {
        System.out.println(&quot;Hello World&quot;);
    }
}
</code></pre>
<p>Clearly, when this program is executed in your own computer, you are the <em>only</em> user of it. Suppose you are
building a system for a large business organization (e,g., a bank), and you must extend the program to support concurrent users, say more than 10 thousand people, as shown in Figure 1.2. Because those people are often geographically dispersed, the extended program should be a <em>network</em> application. To distinguish from the simple applications, such complex application is called <em>enterprise application</em>, and Jakarta EE is designed for developing it under the guidance of the Java Community Process (JCP). Typical contexts in which Jakarta EE runtimes are used include  e-commerce, accounting, and banking information systems.
<img src="ch1/image/se_ee.png" alt="Figure 1.2 Jakarta EE supports concurrent users." title=":size=50%" /></p>
<p>Generally speaking, enterprise applications also often provide the following features:</p>
<ul>
<li>Support for synchronous and asynchronous communication using different protocols.</li>
<li>Ability to handle transactional workloads that coordinate between data repositories such as queues and databases.</li>
<li>Support for scalability to handle future growth.</li>
<li>A resilient and distributed platform to ensure high availability.</li>
<li>Support for highly secure access control for different types of users.</li>
<li>Ability to integrate with back-end systems and web services.</li>
</ul>
<p>You must feel puzzled and even drowsy while reading those arcane words. There is no panic, and please be relaxed. What you need to know is that Jakarta EE can empower you to build a <em>large scale</em> system as complex as <code>Taobao.com</code>.</p>
<h2 id="from-java-to-jakarta"><a class="header" href="#from-java-to-jakarta">From Java to Jakarta</a></h2>
<p>At the birth of Java, there was not concept of EE. In 1999, J2EE was broken out from standard JDK, and it was renamed to Java EE in 2006. Java EE 8 was released in 2017, and it is the <em>last</em> version of Java EE. On September 12, 2017, Oracle Corporation announced that it would submit Java EE to the Eclipse Foundation, and Java EE was renamed to Jakarta EE due to the copyright issue. Note that Jakarta EE 8 essentially equals to Java EE 8 since they have the same functionalities, and the latest version is Jakarta EE 9.</p>
<blockquote>
<p>[!NOTE]
Geographically, Java is a volcano-dotted island of Indonesia, while Jakarta is the capital and largest city of Indonesia. See the <a href="https://www.lonelyplanet.com/maps/asia/indonesia/">map of Indonesia</a>.</p>
</blockquote>
<h3 id="myths-about-jakarta-ee"><a class="header" href="#myths-about-jakarta-ee">Myths about Jakarta EE</a></h3>
<p>Many beginners may have some myths with respect to Java SE and Java EE.</p>
<ol>
<li>Is Jakarta EE more advanced compared to Java SE?</li>
</ol>
<p>No. Although Java SE is a prerequisite when learning Jakarta EE, it makes no sense to say <em>one is more advanced than another</em>. It is true that the Jakarta EE platform is built on top of the Java SE platform, but can you claim that cola is more advanced than water? Please meditate the analogy in Figure 1.3.</p>
<ol start="2">
<li>Is Jakarta EE a new programming language?</li>
</ol>
<p>No. When most people think of the Java programming language, they think of the Java SE application programming interface (API)[1]. As for common developers, the difference between them mainly lies on API, and Jakarta EE provides more functionalities than Java SE. In short, all code written on Java SE is still valid on Jakarta EE, and they are indeed using the <em>same</em> programming language (i.e., Java)[2].</p>
<p><img src="ch1/image/colo_java.png" alt="Figure 1.3 Jakarta EE is not more advanced than Java SE[3], it just does more." title=":size=40%" /></p>
<h2 id="jakarta-ee-full-profile-and-web-profile"><a class="header" href="#jakarta-ee-full-profile-and-web-profile">Jakarta EE full profile and web profile</a></h2>
<blockquote>
<p>[!TIP]
<strong>TL;DR</strong> Jakarta EE web profile, as its name implies, handles web related stuff, and it is a subset of Jakarta EE full profile. A Jakarta EE program has to be within a container.</p>
</blockquote>
<p>One important thing to know is that <em>Jakarta EE is a set of specifications</em>. Broadly speaking, a specification describe a system in an abstract way by defining APIs and their interactions, and it leaves detailed implementations to vendors. To put it in another way, a specification tells <em>what</em> to do, while vendors care about <em>how</em> to do, and they must meet certain conformance requirements in order to declare their products as <em>Jakarta EE compliant</em>.</p>
<p>Jakarta EE includes several specifications that serve different purposes, like generating web pages, reading and writing from a database in a transactional way, managing distributed queues. Jakarta EE <em>profile</em> represents a configuration of the platform suited
to a particular class of applications. A product may implement two or more Jakarta EE profiles, or the full platform and one or more Jakarta EE profiles, as long as their combined requirements do not give rise to conflicts. In this book, we will focus on a subset of web profile, which is targeted at developers of modern web applications.</p>
<p>The Jakarta EE application cannot execute out of thin air, and it has to run within some runtime, just like water drop should be put in a bottle. In Jakarta EE's terminologies, such referencing runtime is called <em>container</em>. As for Jakarta EE web profile, not surprisingly, the specific subset one is <em>web container</em>, and there are abundant products available as the referencing runtimes, such as GlassFish, JBoss, Tomcat, and Open Liberty. </p>
<h2 id="a-note-for-version"><a class="header" href="#a-note-for-version">A note for version</a></h2>
<p>It is worth mentioning that many people still like to use the term Java EE instead of Jakarta EE in their writings and speakings, and we would also use Java EE consistently throughout this book if the context is clear.</p>
<p>As we have mentioned, Java EE has been renamed to Jakarta EE, but the documentation of Jakarta EE is not complete yet in the year of 2021, and this would pose many burdens to beginners. Therefore, we still use <code>Java EE 8</code> throughout this textbook. As for the container, we choose the lightweight Tomcat[4], which is only servlet container (i.e., <em>web-profile</em> only) and does not support Java EE features like EJB, JMS etc.</p>
<hr />
<p>[1] If you have some trouble understanding API, it is fine that you can simply replace it with &quot;<em>something that helps you program</em>&quot; in your mind. <code>ArrayList</code> can help you manage a list of items, so it is an API of Java; <code>size()</code> method can help you determine the length of an <code>ArrayList</code>, so it is an API of <code>ArrayList</code>.</p>
<p>[2] There are other alternative JVM programming languages, such as Kotlin, Scala and Groovy for Java EE.</p>
<p>[3] The Java (SE) logo depicts a blue coffee cup with red steam above it, while Jakarta EE logo prominently features a tri-colored boat. Do you know who the Java mascot is? See more at <a href="https://wiki.openjdk.java.net/display/duke/Main">OpenJDK Wiki</a>.</p>
<p>[4] Don't get confused with <code>Tomcat EE</code>, which is a certified Java EE container, this supports all Java EE technologies.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="12-your-first-java-web-project"><a class="header" href="#12-your-first-java-web-project">1.2 Your First Java Web Project</a></h1>
<p>In this section, you will get your hands dirty by building a simple <code>Hello World</code> application using Jakarta EE technologies in IntelliJ IDEA. Detailed instructions on how to download and install necessary softwares can be found in <a href="ch1/appendix/index.html">Appendix</a>.</p>
<p>Here what you will need[1]:</p>
<ul>
<li>Java SE Development Kit (JDK) version 11 or later. You can get the JDK directly from IntelliJ IDEA or download and install it manually.</li>
<li>Tomcat 9.</li>
<li>A modern web browser (e.g., Edge, Chrome, Firefox and Safari) to view your web application.</li>
</ul>
<h2 id="create-a-new-java-enterprise-project"><a class="header" href="#create-a-new-java-enterprise-project">Create a new Java Enterprise project</a></h2>
<p>Click <code>New Project</code> button in the welcome screen of IntelliJ IDEA, or <em>File | New | Project</em> at the menu if you have already opened a project. In the <code>New Project</code> dialog, select <code>Java Enterprise</code>. </p>
<p><img src="ch1/image/new-project.png" alt="Figure 1.4 Create a Java web project." title=":size=50%" /></p>
<p>A short notes on the settings:</p>
<ul>
<li><code>Location</code>: The location this project locates, and it has to be an <em>empty</em> folder. If it does not exist, IntelliJ IDEA will create it for you. </li>
<li><code>Name</code> and <code>Artifact</code>: They have the same name with the selected folder by default.</li>
<li><code>Group</code>: To denote <em>who</em> builds this application, and it is fine to leave the default name <em>com.example</em>.</li>
<li><code>Project template</code>, <code>Language</code>, <code>Build system</code>, and <code>Test framework</code>: Select <em>Web application</em>, <em>Java</em>, <em>Gradle</em>, and <em>JUnit</em>, respectively.</li>
<li><code>Project SDK</code>: Use JDK 11 in this book[2].</li>
<li><code>Application server</code>: Click <em>New | Tomcat Server</em> (NOT <em>TomEE Server</em>),  and then select the path you extracted the Tomcat (a.k.a, <code>Tomcat Home</code>, or formally <code>Catalina Home</code>), and Intellij IDEA is able to detect its version. Then click <em>OK</em>.</li>
</ul>
<p><img src="ch1/image/tomcathome.png" alt="Figure 1.5 Tomcat home." title=":size=50%" /></p>
<p>Then click <em>Next</em>. Select <em>Java EE 8</em> in <code>Version</code> field. Then click <em>Finish</em>. Depending on the network condition and CPU performance, you have to wait a dozen of seconds for Intellij IDEA doing some pre-processing work[3].  After the progress bar at the bottom of Intellij IDEA disappears, click the green right triangle button (<span style='color: green'>▶</span>) on the upper-right in Intellij IDEA to <em>run</em> this web application, and it will be launched in your default browser automatically.</p>
<p><img src="ch1/image/sarafi.png" alt="Figure 1.6 The web application is shown in the browser." title=":size=50%" /></p>
<p>Well done! You have created your first Java web project successfully. Feel free to click the hyperlink and explore your own website as depicted in Figure 1.6. And you can click the red square button (🟥) on the upper-right in Intellij IDEA to <em>stop</em> this web application. </p>
<h2 id="explore-the-default-structure"><a class="header" href="#explore-the-default-structure">Explore the default structure</a></h2>
<p>IntelliJ IDEA creates a project with some boilerplate code that you can build and deploy successfully. In the left sidebar, a list of files and folders are displayed:</p>
<pre><code>├── .gradle ①
├── .idea   ②
├── build   ③
├── gradle  ④ 
├── src 
│   ├── main
|   |   └── java   ⑤
|   |   └── resources   ⑥
|   |   └── webapp
|   |       └── WEN-INF  ⑦
|   |       └── index.jsp  ⑧
│   └── test      ⑨
├── build.gradle  ⑩           
├── gradlew ⑪  
├── gradlew.bat ⑪ 
├── settings.gradle ⑫
</code></pre>
<p>It may seems quite complicate at the first glance, but this structure is easy to understand, and shared by many standard Java projects. Here are short notes on each file and folder listed above, and it does not matter even if you are unfamiliar with <em>Gradle</em> related stuff. </p>
<ul>
<li>① A <em>hidden</em> folder for project specific Gradle library.</li>
<li>② A <em>hidden</em> folder generated by IntelliJ IDEA, containing IntelliJ’s project specific settings files.</li>
<li>③ A generated folder after you build or run the project, containing <code>.class</code> and <code>libs</code> files.</li>
<li>④ A generated folder for Gradle wrapper files.</li>
<li>⑤ Default Java source folder, containing <code>.java</code> files.</li>
<li>⑥ Default Java resource folder where many Java libraries store their configuration files, or static files like <code>image</code>, <code>.mp3</code>, etc.</li>
<li>⑦ A folder inside <code>webapp</code> that are accessible to the resource loader of your web application and not directly visible for the public. The well-known <code>web.xml</code> can be found there.</li>
<li>⑧ Jakarta server page (JSP) file, roughly identical to the web pages we see in the browser[4].</li>
<li>⑨ Default Java test source folder.</li>
<li>⑩ Build script of this project, specifying the tasks like how to build, and package. Particularly, it can help us to handle dependencies management.</li>
<li>⑪ Gradle wrapper start scripts, for Unix-like platforms and Windows, respectively.</li>
<li>⑫ Settings file to define build name and sub-project.</li>
</ul>
<p>If you would like to distribute your project as source code, for example, using <code>Git</code>, then ①, ② and ③ can be safely ignored, because they will be re-generated again when this project is imported.</p>
<blockquote>
<p>[!NOTE]
Gradle and IntelliJ IDEA (as well as the related files) are not necessary to develop a Java EE project, but they make our lives easier. You can use other alternatives (e.g., Maven), and even do not rely on any extra tools by writing the code from scratch using a plain text editor.</p>
</blockquote>
<h2 id="write-your-first-line-of-code"><a class="header" href="#write-your-first-line-of-code">Write your first line of code</a></h2>
<p>Due to the boilerplate code generated by IntelliJ IDEA, you can launch the web application directly without writing a single line code. Now, let's get started to make the web page different.</p>
<p>Open <code>src | main | webapp | index.jsp</code>, and update Line 8 and 9 to:</p>
<pre><code class="language-jsp">&lt;h1&gt;&lt;%= &quot;Hello World, My First Java Web Application!&quot; %&gt;
&lt;/h1&gt;
</code></pre>
<p>Stop the web application first by clicking red square button (🟥) in the toolbar of IntelliJ IDEA, if it is running, and then click the green right triangle button (<span style='color: green'>▶</span>) to <em>run</em> it. See what happens in your web browser? The title becomes <code>Hello World, My First Java Web Application!</code>, and that is what you just updated in <code>index.jsp</code>.</p>
<p>You may notice what is displayed in the address bar of your browser is quite long, and the following is what was shown in our computers:</p>
<blockquote>
<p>http://localhost:8080/Gradle___com_swufe_javaee___first_java_ee_1_0_SNAPSHOT_war/</p>
</blockquote>
<p>Let's make some magic to shorten it! From the main menu, select <code>Run | Edit Configurations</code>. As the name implies, it is the location to configure how this program runs.</p>
<p><img src="ch1/image/tomcat-config.png" alt="Figure 1.7 Tomcat: run/debug configurations" title=":size=60%" /></p>
<p>In <code>Deployment</code> tab, update <code>Application context</code> text box at the bottom to a shorter one, say <code>/first_java_ee_1_0_SNAPSHOT_war</code>[5], then Click <code>OK</code> button. As we did just now, stop the web application and then start it again. Alternatively, you can also re-deploy this web application by clicking the re-start button which is converted from <span style='color: green'>▶</span>, and then select <code>Redeploy</code>.</p>
<p><img src="ch1/image/redeploy.png" alt="Figure 1.8 Redeploy" title=":size=30%" /></p>
<p>By the way, some beginners might want to know what <em>deployment</em> is exactly. Quotes from <em>Oxford Languages</em>:</p>
<blockquote>
<p>the action of bringing resources into effective action.</p>
</blockquote>
<p>Similar to the meaning in the dictionary, <em>deployment</em> in programming means the action that converts codes into executable programs.</p>
<hr />
<p>[1] This section is adapted from <a href="https://www.jetbrains.com/help/idea/creating-and-running-your-first-java-ee-application.html">Tutorial: Your first Java EE application</a>.</p>
<p>[2] At the time we wrote this book (of October, 2021), Java 17 and later versions were not yet supported for <em>Gradle</em>.</p>
<p>[3] IntelliJ IDEA would build index for your project, and as for a new project with <em>Gradle</em> building system, it would also download the Gradle library and dependencies. But from the second time on, the pre-processing time will be much shorter.</p>
<p>[4] JSPs cannot be displayed in the browser directly, and they must be translated into servlets at runtime in the web container.</p>
<p>[5] It must be started with a slash (<code>/</code>).</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="13-a-brief-introduction-to-html"><a class="header" href="#13-a-brief-introduction-to-html">1.3 A Brief Introduction To HTML</a></h1>
<p>When you are surfing on the Internet, and seeing all sorts of web pages from different websites, including the one we built in <a href="ch1/1.2.html">Section 1.2</a>, a natural question is: <strong>how is an web page displayed</strong>? Well, to answer this question, let's run the previous web application again. Once the <code>Hello World</code> web page is opened in the web browser, right-click to display the pop-up menu, and then select <code>Show Page Source</code> (in Safari) or <code>View Page Source</code> (in Edge, Firefox and Chrome). The following is what you will see:</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;JSP - Hello World&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Hello World!
&lt;/h1&gt;
&lt;br/&gt;
&lt;a href=&quot;hello-servlet&quot;&gt;Hello Servlet&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>These lines of code are written in <code>HTML</code>, the standard markup language for web pages, short for <em>HyperText Markup Language</em>. HTML is probably the least complex and most worth-learning web skill, and five minutes are enough for you to become an experienced HTML developer. We are not kidding: <em>FIVE</em> minutes.</p>
<p>Here what you will need[1]:</p>
<ul>
<li>A text editor. Here, we highly recommend <a href="https://code.visualstudio.com/">Visual Studio Code</a>.</li>
<li>A modern web browser (e.g., Edge, Chrome, Firefox and Safari) to view HTML pages.</li>
</ul>
<h2 id="get-started-with-html"><a class="header" href="#get-started-with-html">Get started with HTML</a></h2>
<blockquote>
<p>[!TIP]
<strong>TL;DR</strong> HTML consists of a series of <em>elements</em>, controlling how contents on web pages appear or act. Elements can be <em>nested</em>, and elements can also have <em>attributes</em>. </p>
</blockquote>
<p>HTML (Hypertext Markup Language) is not a programming language. It is a markup language that tells web browsers how to structure the web pages you visit. HTML consists of a series of <em>elements</em>, which you use to enclose, wrap, or mark up different parts of content to make it appear or act in a certain way. The process of the web browser interpreting HTML code for a display is <em>rendering</em>.</p>
<p>For example, consider the following line of text:</p>
<pre><code class="language-text">My cat is very grumpy.
</code></pre>
<p>If we wanted the text to stand by itself, we could specify that it is a paragraph by enclosing it in a paragraph (<code>&lt;p&gt;</code>) element:</p>
<pre><code class="language-html">&lt;p&gt;My cat is very grumpy&lt;/p&gt;
</code></pre>
<blockquote>
<p>[!NOTE]
Tags in HTML are not case-sensitive. However, it is best practice to write all tags in lowercase for consistency and readability.</p>
</blockquote>
<p>In this example, we can notice that our element includes <em>opening tag</em>, and <em>content</em>, and <em>closing tag</em>, as illustrated in Figure 1.9.</p>
<p><img src="https://developer.mozilla.org/en-US/docs/Learn/HTML/Introduction_to_HTML/Getting_started/grumpy-cat-small.png" alt="Figure 1.9 Three parts of an HTML element." title=":size=50%" /></p>
<p>Elements can be placed within other elements. This is called <em>nesting</em>. Notice that the tags have to open and close in a way that they are inside or outside one another. For example, </p>
<pre><code class="language-html">&lt;!-- Correct nesting --&gt;
&lt;p&gt;My cat is &lt;strong&gt;very&lt;/strong&gt; grumpy.&lt;/p&gt;

&lt;!-- Wrong nesting --&gt;
&lt;p&gt;My cat is &lt;strong&gt;very grumpy.&lt;/p&gt;&lt;/strong&gt;
</code></pre>
<p>is a correct and wrong way of nesting, respectively, where</p>
<ul>
<li>
<p><code>&lt;!-- --&gt;</code> is the comment sign in HTML, just like <code>//</code> in Java.</p>
</li>
<li>
<p><code>&lt;strong&gt;</code> is to wrap the word and make it look strong(er) in text formatting.</p>
<blockquote>
<p>[!NOTE]
Some elements consist of a single tag, without content and classing tag. For example <code>&lt;img src=&quot;cat.png&quot;&gt;</code> alone can embed an image file <code>cat.png</code> onto a page, and you don't have to write <code>&lt;img src=&quot;cat.png&quot;&gt;&lt;/image&gt;</code>.</p>
</blockquote>
</li>
</ul>
<p>In the note above, we can find that elements can also have <em>attributes</em>. An attribute should have an <em>attribute name</em>, followed by an equal sign, and an <em>attribute value</em>, wrapped with opening and closing quote marks. So, <code>src</code> is the attribute name to donate the image <em>source</em>. In Figure 1.10, the <code>&lt;p&gt;</code> element has an attribute name <code>class</code> with value <code>editor-note</code>.</p>
<p><img src="https://developer.mozilla.org/en-US/docs/Learn/HTML/Introduction_to_HTML/Getting_started/grumpy-cat-attribute-small.png" alt="Figure 1.10 Attribute of an HTML element" title=":size=70%" /></p>
<p>Basically, you have learnt all grammar knowledge of HTML[2], and what you need to enhance is to grasp more elements as well as their attributes. If you encounter some unfamiliar elements or attributes, please refer to many great resources available for learning HTML, such as <a href="https://www.w3schools.com/html/">HTML Tutorial</a> by <em>W3School</em>.</p>
<h2 id="anatomy-of-a-complete-example"><a class="header" href="#anatomy-of-a-complete-example">Anatomy of a complete example</a></h2>
<p>Let's revisit the <code>HTML</code> code in the beginning of this section. Copy the code into a document and save it as <code>test.html</code>. Double click <code>test.html</code>, and then your default web browser will open it.</p>
<blockquote>
<p>[!NOTE]
The file suffix of HTML can be either <code>.htm</code> or <code>.html</code>. But it is a good practice to use the latter one.</p>
</blockquote>
<ul>
<li>The <code>&lt;!DOCTYPE html&gt;</code> declaration defines that this document is an HTML5[3] document.</li>
<li>The <code>&lt;html&gt;</code> element is the root element of an HTML page.</li>
<li>The <code>&lt;head&gt;</code> element contains <em>meta</em> information about the HTML page.</li>
<li>The <code>&lt;title&gt;</code> element specifies a title for the HTML page (which is shown in the browser's title bar or in the page's tab).</li>
<li>The <code>&lt;body&gt;</code> element defines the document's body, and is a container for all the <em>visible</em> contents, such as headings, paragraphs, images, hyperlinks, tables, lists, etc.</li>
<li>The <code>&lt;h1&gt;</code> element defines a large heading.</li>
<li>The <code>&lt;br&gt;</code> element inserts a single line break.</li>
<li>The <code>&lt;a&gt;</code> element defines a <em>hyperlink</em>.</li>
</ul>
<p>As a minimal web page, you should at least include <code>&lt;html&gt;</code> and <code>&lt;body&gt;</code>. </p>
<p><img src="ch1/image/html.png" alt="Figure 1.11 Anatomy of an HTML page" title=":size=40%" /></p>
<p>You can click on <code>&lt;a&gt;</code> and jump to another document. The most important attribute of <code>&lt;a&gt;</code> is the <code>href</code> attribute, which indicates the link's destination. Try to append <code>&lt;a href=&quot;https://wwww.bing.com&quot;&gt;Bing&lt;/a&gt;</code> before <code>&lt;/body&gt;</code> tag, and the refresh <code>index.html</code> in the web browser. A new link <code>Bing</code> colored in blue appears, right? And see what happens when you click it. Congratulations! You are already an HTML guru now.</p>
<hr />
<p>[1] This section is adapted from <a href="https://developer.mozilla.org/en-US/docs/Learn/HTML">Structuring the web with HTML</a> by <em>Mozilla</em>.</p>
<p>[2] To write <em>workable</em> (practical) web pages, you need also to understand more advanced topics like <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS">CSS</a> and <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript">JavaScript</a>.</p>
<p>[3] The current version of HTML is HTML5.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="14-a-brief-introduction-to-http"><a class="header" href="#14-a-brief-introduction-to-http">1.4 A Brief Introduction To HTTP</a></h1>
<p>The server of <code>taobao.com</code> may be located in Hangzhou, so how does it <em>deliver</em> the web pages to your web browser by travelling thousands of miles? Figure 1.12 illustrates the whole process when you input an address or click a link in the web browser.</p>
<blockquote>
<p>[!NOTE]
To see what are delivered, you can select <code>Show Page Source</code> or <code>View Page Source</code> to inspect the HTML source code of any website just like what we did in <a href="ch1/1.3.html">Section 1.3</a>.</p>
</blockquote>
<p><img src="ch1/image/request-response.png" alt="Figure 1.12 Request-response model." title=":size=60%" /></p>
<p>In a nutshell, it can be described as a <em>request-response</em> model between the client[1] and server[2].</p>
<ul>
<li>The client sends a request containing the name and address of the thing (e.g., web pages) the client is looking for.</li>
<li>The server usually has lots of &quot;content&quot;, so it has to locate the desired one according to the request.</li>
<li>The server's response contains the actual document that the client requested.</li>
<li>The client receives the response for processing (e.g., rendering)[3].</li>
</ul>
<h2 id="http-overview"><a class="header" href="#http-overview">HTTP: overview</a></h2>
<p>In the previous section, we know that HTML tells the browser how to display the content to the user. Clearly, we also need a set of &quot;rules&quot; for the communication between the client and server, and such rule is called <em>HTTP</em>.</p>
<blockquote>
<p>Hypertext Transfer Protocol (HTTP) is an application-layer protocol for transmitting hypermedia documents, such as HTML.</p>
</blockquote>
<p>HTTP is an application layer protocol that is sent over TCP (<code>http</code>), or over a TLS-encrypted TCP connection (<code>https</code>), though any reliable transport protocol could theoretically be used[4]. If you are not familiar with this networking protocol, here is the crash course: TCP is responsible for making sure that a file sent from one network node to another ends up as a complete file at the destination, even if the file is split into chunks when it is sent. </p>
<blockquote>
<p>[!NOTE]
<em>Computer Networking</em> is one of the core courses of Computer Science, but only a handful of knowledge is used in this book. You can refer to [5] (for general networking) and [6] (for HTTP) to gain an in-depth understanding.</p>
</blockquote>
<p>The structure of an HTTP conversation is a simple <strong>Request/Response</strong> sequence; a client <em>requests</em>, and a server <em>responds</em>. Figure 1.13 shows the key components of <em>request</em> and <em>response</em>.</p>
<p><img src="ch1/image/request-response2.png" alt="Figure 1.13 Key elements of the request and response stream." title=":size=50%" /></p>
<blockquote>
<p>[!TIP]
We will revisit <em>request</em> and <em>response</em> in <a href="ch1/ch3/3.2.html">Section 3.2</a>.</p>
</blockquote>
<h3 id="response"><a class="header" href="#response">Response</a></h3>
<p>When it comes to response, it includes a <code>status code</code> indicating whether the request has been successfully completed. For example, <code>200</code> means <em>OK</em>, and <code>404</code> means <em>Not Found</em>. A complete list can be found in <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">HTTP response status codes</a>.</p>
<p>The response also include a <code>content-type</code> field, a.k.a. a MIME type. The MIME type tells the browser what kind of data the client is about to receive so that the client will know to process it[7]. The simplest MIME type consists of a type (the general category into which the data type falls, such as <code>video</code> or <code>text</code>) and a subtype (he exact kind of data of the specified type the MIME type represents); these are each strings which, when concatenated with a slash (/) between them, comprise a MIME type. </p>
<pre><code>type/subtype
</code></pre>
<p>For example, <code>text/html</code> is the MIME type for HTML files, and <code>image/png</code> is the MIME type for PNG files. A list of common MIME types can be found at <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types">Common MIME types</a>.</p>
<p>The third key element is the data itself (e.g., the HTML document).</p>
<p>Notice that the three key elements mentioned above are only parts of an HTTP response. An HTTP response has both a header and a body. The header info tells the browser about the protocol being used, whether the request was successful, and what kind of content is included in the body. The body is identical to the third key element. The following shows the response header of our <code>HelloWorld</code> web application, and we can find that HTTP is human-readable, providing easier testing for developers, and reduced complexity for newcomers.</p>
<pre><code>HTTP/1.1 200 OK
Server: Eclipse GlassFish  6.2.2 
X-Powered-By: JSP/2.3
Content-Type: text/html;charset=UTF-8
Content-Length: 169
</code></pre>
<blockquote>
<p>[!TIP]
You can view both the header and body in the web browser. Right-click to display the pop-up menu, and then select <code>Inspect Element</code> (in Safari) or <code>Inspect</code> (in Edge, Firefox and Chrome), and at last click <code>Network</code> tab.</p>
</blockquote>
<p><img src="ch1/image/network.png" alt="Figure 1.14 Network tab in Edge." title=":size=50%" /></p>
<h3 id="request"><a class="header" href="#request">Request</a></h3>
<p>The first thing you need to know about HTTP request is the <em>request method</em>, indicating the desired action to be performed for a given resource. The HTTP protocol defines several methods, but the ones most often are <em>GET</em> and <em>POST</em>. And you can find a complete list at <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods">HTTP request methods</a>.</p>
<ul>
<li>The <code>GET</code> method requests a representation of the specified resource. Requests using GET should only retrieve data.</li>
<li>The <code>POST</code> method submits an entity to the specified resource, often causing a change in state or side effects on the server.</li>
</ul>
<p>Notice that the core difference between <em>GET</em> and <em>POST</em> is the semantic: <em>GET</em> is used for retrieve data, and <em>POST</em> often changes the state of server. Let's look at some examples: When you input an address and then press <em>Enter</em> in the browser, it is a <em>GET</em> request; When you input the username and password and then click <em>Login in</em>, it is a <em>POST</em> request.</p>
<p>The seconds key element is the <code>URL</code>, short for Uniform Resource Locator. URL is a text string that specifies where a resource (such as a web page, image, or video) can be found on the Internet. In the context of HTTP, URLs are called &quot;Web address&quot; or &quot;link&quot;. Your browser displays URLs in its address bar, for example: https://www.bing.com. Some browsers display only the part of a URL after the &quot;//&quot;, that is, the <em>domain name</em>. Remember what it is in the address bar of the <code>HelloWorld</code> application? It is http://localhost:8080/demo-1.0-SNAPSHOT/. Here, <code>localhost</code> is a special host name of the computer where the web app is running, and you can also access it by the IP address <code>127.0.0.1</code>[8]. <em>demo-1.0-SNAPSHOT</em> is our application name, and in the URL, it is a <em>resource</em> path.</p>
<p>What is <em>8080</em> here? It is a <code>port</code>, designated by a number[9]. For a computer connected to a network with an IP address, a port is a communication endpoint, and below 1024 each port is associated by default with a specific protocol. For example, the default port for the HTTP protocol is 80 and the default port for the HTTPS protocol is 443.</p>
<p>Like the response, there is also a request header. Figure 1.15 shows the content of a request, and you can also view it in <code>Network</code> tab. Notice that the headers in HTTP/2 is slightly different. </p>
<p><img src="ch1/image/get.png" alt="Figure 1.15 Anatomy of an HTTP GET request." title=":size=60%" /></p>
<p>Let's have a practical experimental. Try to input &quot;Java Web&quot; in Bing, and what can you see in the address bar after pressing <em>Enter</em>? It should be a long string starting with &quot;https://www.bing.com/search?q=Java+Web&amp;&quot;, and surely it is a <em>GET</em> request. Now we are in a position to discuss the next major difference between <em>GET</em> and <em>POST</em> when sending data (parameters) to the server, and this is also the third key element of a request.</p>
<p>For <em>GET</em>, all the parameters sent to server (if there are any) are appended to the URL starting with a &quot;?&quot;, and parameters are separated with am ampersand &quot;&amp;&quot;. So, it has several limitations:</p>
<ul>
<li><code>GET</code> can only send textural parameters. If you need to upload a multimedia file (e.g., an image), you have to use <code>POST</code>.</li>
<li><code>GET</code> shows what you sent in the address bar. In some cases, you might keep them private (e.g., the password), and again you have to use <code>POST</code>.</li>
<li>The length of contents in the address bar is limited[10]. If you want to send a very large parameter, even if it is textural, you still have to use <code>POST</code>.</li>
</ul>
<p>It seems that <code>POST</code> is an advanced <code>GET</code>. It is true. At the time the HTTP was invented, <code>GET</code> was the only method, and other methods were added later due to the increasingly complicated Internet requirements. So, should we always use <code>POST</code>? The answer is <em>NO</em>. Recall the core difference between them: the semantic. If your intention is simply to retrieve resource, then <em>GET</em> is the right choice.</p>
<p>We still have one question to be answered. The parameters of <code>POST</code> is <em>NOT</em> found in the URL, then where is it? Unlike <code>GET</code>, there is another part called &quot;message body&quot;, also known as <em>payload</em> in a <code>POST</code> request, and parameters can down here in the body. </p>
<h2 id="back-to-our-web-application"><a class="header" href="#back-to-our-web-application">Back to our web application</a></h2>
<p>Create an HTML file named <code>test.html</code> inside <code>webapp</code> folder, and write anything you learned in the last section. Then copy an PNG image, say <code>test.png</code>, into <code>webapp</code> folder. If all goes well, you should access those two resources in the web browser via URL http://localhost:8080/demo-1.0-SNAPSHOT/test.html and http://localhost:8080/demo-1.0-SNAPSHOT/test.png, respectively. Some students may have the following questions:</p>
<ol>
<li>Why would http://localhost:8080/demo-1.0-SNAPSHOT go to <code>index.jsp</code>?</li>
</ol>
<p>By default, the web application would look for resources named <code>index</code>, such as <em>index.html</em> and <em>index.jsp</em>.</p>
<ol start="2">
<li>What is difference between <code>HTML</code> and <code>JSP</code>?</li>
</ol>
<p>The answer, by a large extent, serves the purpose why this course exists. Those resources, like an HTML document and an image, are <em>static</em>, while their counterpart are <em>dynamic</em>. Static resources are pre-created documents, and they are the same every time people <em>get</em> them; dynamic are generated by computing on demand. In our example, the web browser, in fact, cannot render a JSP directly, and it is the Tomcat who translates the JSP to HTML code, and wraps it into the response.</p>
<p>Here are more examples with respect to the <em>dynamic</em>. When you search a book at <code>amazon.com</code>, the specific web page is generated by retrieving the data from database, rather than pre-created. In addition, some contents (e.g., book recommendation) are computed according to the user's profile <em>dynamically</em>. And we could claim that, every enterprise website relies on the dynamic web technologies.</p>
<p><img src="ch1/image/book.png" alt="Figure 1.16 Book web page is dynamic at Amazon." title=":size=50%" /></p>
<hr />
<p>[1] The term <em>client</em> is a counterpart of <em>server</em>, referring to the software that knows how to communicate with the server. When we use the term <em>client</em>, we usually won't care whether we're talking about the human user or the specific application (e.g., a web browser, an Android app).</p>
<p>[2] When we say &quot;server&quot;, we mean <em>either</em> the physical machine (hardware) or the web server application (software). For example, the machine equipped with GlassFish is a server.</p>
<p>[3] For files like <em>HTMLs</em>, <em>images</em>, <em>pdfs</em>, and even <em>videos</em>, the web browser is able to render for a display, while other files (e.g., <em>zip</em>, <em>exe</em>) often would trigger a <em>download</em>.</p>
<p>[4] While the HTTP/1.1 and HTTP/2 are mainstream now, HTTP/3 protocol, upcoming major version of the HTTP, uses <a href="https://en.wikipedia.org/wiki/QUIC">QUIC</a> rather than TCP.</p>
<p>[5] Computer Networking: A Top-Down Approach, by James Kurose, Keith Ross.</p>
<p>[6] HTTP: The Definitive Guide, by Brian Totty, David Gourley.</p>
<p>[7] Besides the MIME type, <code>Content-Type</code> also has a <code>charset</code>, indicating the character encoding standard (i.e., UTF-8).</p>
<p>[8] Every machine that can be accessed is assigned an IP address in the digital form (e.g., 13.107.21.200). But it is hard for people to remember, so domain names (e.g., bing.com) emerge. The Domain Name System (DNS) is able to translate a domain to the IP address. </p>
<p>[9] The designated port <code>8080</code> is set by IntelliJ IDEA, and you can use a new one above 1024 as long as it is available. </p>
<p>[10] <code>GET</code> is limited by the URL length (about 2KB), and the maximum POST request body size is configured on the HTTP server and typically ranges from 1MB to 2GB.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="15-revisit-the-first-java-web-project"><a class="header" href="#15-revisit-the-first-java-web-project">1.5 Revisit The First Java Web Project</a></h1>
<p>In the <code>index.jsp</code>, we notice the following:</p>
<pre><code class="language-html">&lt;a href=&quot;hello-servlet&quot;&gt;Hello Servlet&lt;/a&gt;
</code></pre>
<p>According to what we have learned, the <code>&lt;a&gt;</code> element defines a hyperlink, and the <code>href</code> attribute means the link's destination, so what is the <code>hello-servlet</code>? Please go to the <code>HelloServlet.java</code> in the <code>com.example.demo</code> package under <code>src/main/java</code>.</p>
<pre><code class="language-java">@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)
public class HelloServlet extends HttpServlet
</code></pre>
<p>People with sharp eyes may notice the <em>value = &quot;/hello-servlet&quot;</em>. A-ha, <code>hello-servlet</code>, twice. This is not coincidence, and we will investigate this observation in the next chapter.</p>
<p>If we have a close look at this Java file, we should find something acquainted. To be specific, in the <code>doGet</code> method, it outputs the HTML code. So, a <code>servlet</code> is able to generate HTML to the response. </p>
<blockquote>
<p>[!TIP]
Again, <code>doGet</code>, as its name implies, will handle the <em>GET</em> request, and we will investigate this observation in the next chapter.</p>
</blockquote>
<h2 id="anatomy-of-a-java-web-application"><a class="header" href="#anatomy-of-a-java-web-application">Anatomy of a Java web application</a></h2>
<p>Under the <code>build/libs</code> folder, you can find the <code>first_java_ee-1.0-SNAPSHOT.war</code>, the final web application package. A WAR file (Web Application Resource or Web application ARchive) is a file used to distribute a collection of JAR-files, JavaServer Pages, Java classes, XML files, static web pages (HTML and related files) and other resources that together constitute a web application. In a nutshell, a WAR is a compressed package (like <code>zip</code> and <code>rar</code>), and you can extract the included files from it. The default name of a WAR file is illustrated in Figure 1.17. Notice that you can rename it if you like no matter what the project settings are.</p>
<p><img src="ch1/image/war.png" alt="Figure 1.17 The default name of a WAR file." title=":size=60%" /></p>
<p>Then how does Tomcat recognize and make use of this file? Please go to the home of Tomcat, under the <code>webapps</code>, then you can find a folder named <code>first_java_ee_1_0_SNAPSHOT_war</code>:</p>
<pre><code>├── index.jsp
├── META-INF 
│    └── MANIFEST.MF
|    └── war-tracker 
├── WEB-INF
|    └── web.xml
|    └── classes
|      └── com
|        └── example
|          └── demo
|            └── HelloServlet.class
</code></pre>
<p>The whole story can be described as follows: When we run the application in IntelliJ IDEA, IntelliJ IDEA will build the project and package it to a WAR file, and then copy the WAR file to the <code>webapps</code> folder. Finally, the Tomcat deploys this WAR for serving.</p>
<blockquote>
<p>[!NOTE]
We can also notice the file structure of developing in IntelliJ IDEA is different from that of running in Tomcat. In fact, you can also this WAR file on any Jakarta EE complaint container (e.g., WildFly and GlassFish).</p>
</blockquote>
<p>We can also deploy our web application manually. Make sure you have stopped the application in IntelliJ IDEA , and then copy <code>first_java_ee-1.0-SNAPSHOT.war</code> to your desktop. In case of name conflict, please rename it to <code>test.war</code>. </p>
<blockquote>
<p>[!NOTE]
It is fine to skip the manual deployment if you are unfamiliar with command line. Also make <code>Java Home</code> has been appended into <code>PATH</code> environment variables.</p>
</blockquote>
<ul>
<li><strong>Step 1</strong>: Move <code>test.war</code> to the <code>webapps</code> folder under Tomcat home.</li>
<li><strong>Step 2</strong>: Go to the Tomcat home in the terminal, and then</li>
</ul>
<pre><code class="language-sh"># for Linux/MacOS
./bin/startup.sh
# for Windows
.\bin\startup.bat
</code></pre>
<p>It shall display the information similar to the following if everything goes well:</p>
<pre><code class="language-sh">Using CATALINA_BASE:   /Users/zhongpu/devs/apache-tomcat-9.0.56
Using CATALINA_HOME:   /Users/zhongpu/devs/apache-tomcat-9.0.56
Using CATALINA_TMPDIR: /Users/zhongpu/devs/apache-tomcat-9.0.56/temp
Using JRE_HOME:        /Users/zhongpu/.sdkman/candidates/java/current
Using CLASSPATH:       /Users/zhongpu/devs/apache-tomcat-9.0.56/bin/bootstrap.jar:/Users/zhongpu/devs/apache-tomcat-9.0.56/bin/tomcat-juli.jar
Using CATALINA_OPTS:
Tomcat started.
</code></pre>
<p>See, Tomcat started. Then you can access the welcome page by accessing http://localhost:8080/. </p>
<p><img src="ch1/image/tomcat-welcome.png" alt="Figure 1.17 The welcome page of Tomcat." title=":size=60%" /></p>
<p>Also you can also notice that the <code>test.war</code> has been extracted to a <code>test</code> folder inside the <code>webapps</code>. How can we access this <code>test</code>? It is application under Tomcat, so according to the URL structure, just append <code>test</code> after http://localhost:8080/.</p>
<p>Now let's shutdown the Tomcat server,</p>
<pre><code class="language-sh"># for Linux/MacOS
./bin/shutdown.sh
# for Windows
.\bin\shutdown.bat
</code></pre>
<h2 id="revisit-jsp"><a class="header" href="#revisit-jsp">Revisit JSP</a></h2>
<p>When you take a close look at <code>index.jsp</code>, you will find that the JSP is nearly the same with HTML. At this point, you can think JSP is what happened when somebody introduced Java to HTML. Now you put the following code into <code>index.jsp</code>,</p>
<pre><code class="language-jsp">&lt;h2&gt;&lt;%= java.time.LocalDate.now() %&gt;&lt;/h2&gt;
</code></pre>
<p>and it will display the current date in the web page. </p>
<blockquote>
<p>[!TIP]
The syntax <code>&lt;%= %&gt;</code>, known as <em>JSP expression tag</em>, can output the result of the expression between the brackets[1].</p>
</blockquote>
<p>Both JSP and servlets can generate web page dynamically, and this is why they and other similar techniques can be categorized into <em>dynamic web pages</em>. In this example, every time you access <code>index.jsp</code>, what you see can be different. To put it another way, what you see in the web pages are generated by codes. So as a counterpart, the resources, including HTMLs and images, which are written in advance, are called <em>static</em>.</p>
<p>As we have already seen, <em>servlets</em> alone are capable of outputting HTML code as their responses, then why is JSP introduced in Jakarta EE? Generally speaking, the reason lies in two aspects:</p>
<ul>
<li><strong>Not all HTML page designers know Java</strong>. With JSP, Java developers can do Java, and HTML developers can do web pages. Further, Jakarta EE also provides the JSP tags that look like common HTML tags, so HTML developers are able to work the complete JSP work.</li>
<li><strong>Formatting HTML into a String is really ugly</strong>. Putting even marginally complex HTML into the argument to a <code>println()</code> is error-prone. You might have to do a ton of work to get the HTML formatted properly in a way that still works in the client’s browser, yet satisfies Java rules for what’s allowed in a String literal[2]. In addition, too many string literals is a bad coding style which every experienced developer needs to avoid.</li>
</ul>
<p>Although the benefits of JSP are tremendous, the pitfalls are also obvious. For example, it is impossible to view the content of a JSP in a web browser directly, and this imposes difficulties for the collaboration between front-end and back-end. Besides, the syntax of JSP is inflexible and lack of expressiveness (e.g., built-in multi-language support). To this end, JSP is no longer the desired technology in modern web developing, and other alternatives, such as <a href="https://www.thymeleaf.org/">Thymeleaf</a>, are in vogue.</p>
<h2 id="you-own-computer-can-be-a-server"><a class="header" href="#you-own-computer-can-be-a-server">You own computer can be a server</a></h2>
<p>In the first Java web application, your computer is a server running Tomcat, and of course, then your computer is also the client. In what follows, let's try to make the server and client run on different machines. Since it is unlikely for students to get a static public IP address in a campus, we can use the <em>internal</em> IP address (IPv4).</p>
<p>Firstly, make sure two machines are in the same network segment[3], and one machine must be the one running the Java web application (i.e., server).</p>
<p>Secondly, start the Java web application on the server and check the internal IP address of the server. If you are using Windows, please refer to <a href="https://support.microsoft.com/en-us/windows/find-your-ip-address-in-windows-f21a9bbc-c582-55cd-35e0-73431160a1b9#Category=Windows_10">Find your IP address in Windows</a>. If you are using MacOS, please go to <code>System Preferences | Network | Wi-Fi</code>, and you can see the information:</p>
<blockquote>
<p>Wi-Fi is connected to ... and has the IP address 192.168.xx.xx.</p>
</blockquote>
<p>Here <code>192.168.xx.xx</code> is your internal IP address, and we will use <code>192.168.3.1</code> as the example. Depending on the network, it can also be </p>
<ul>
<li>10.0.0.0—10.255.255.255</li>
<li>172.16.0.0—172.31.255.555</li>
<li>192.168.0.0—192.168.255.255</li>
</ul>
<p>Finally, we assume that you can access this Java web application via <code>http://localhost:8080/test</code>, then try to replace <code>localhost</code> with <code>192.168.3.1</code> in the web browser of the client. </p>
<p>If everything goes well, you shall access your website from another machine. So how can you make your website be accessed by people all over the world? The code remains unchanged, and the only and minimal requirement is a public IP address. </p>
<hr />
<p>[1] Note that you cannot <code>System.out.println</code> to display the text on the web page.</p>
<p>[2] Try to view the source of <code>https://book.douban.com</code>, and you will find there are nearly 4000 lines of HTML code. Could you really write it in a Java file?</p>
<p>[3] If they connect to the same router, then they are in the same network segment. If you are not sure, then you can set up a hotpot in your phone, and let the two machines connect to the hotpot. Note that the phone setting up a hotpot itself can also be the client.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise"><a class="header" href="#exercise">Exercise</a></h1>
<p><strong>1.1</strong>. Create a new Java Enterprise project named <code>ex1.1</code>, and modify <code>index.jsp</code> to enable it to </p>
<ul>
<li>display current month.</li>
<li>display the day of the week.</li>
</ul>
<hr />
<p><strong>1.2</strong>. Create an HTML page <code>me.html</code> as your personal page to introduce your name, age, hobbies, and avatar.</p>
<hr />
<p><strong>1.3</strong>. Copy <code>me.html</code> to the <code>webapp</code> folder of <code>ex1.1</code>, and then access this page after starting the server.</p>
<hr />
<p><strong>1.4</strong>. Try to add your personal introduction into <code>index.jsp</code>. You can use as many kinds of elements as you can.</p>
<hr />
<p><strong>1.5</strong>. Like plain Java class, we could import packages in JSP to simplify code. For example,</p>
<pre><code class="language-jsp">&lt;h2&gt;&lt;%= java.time.LocalDate.now() %&gt;&lt;/h2&gt;
</code></pre>
<p>can be shortened into</p>
<pre><code class="language-jsp">&lt;h2&gt;&lt;%= LocalDate.now() %&gt;&lt;/h2&gt;
</code></pre>
<p>if <code>java.time.LocalDate</code> is imported. Try to add import statements in <code>index.jsp</code>.</p>
<hr />
<p><strong>1.6</strong>. Please summarize the differences between the files that you see in IntelliJ IDEA (<code>developing</code> stage) and those that you see in Tomcat (<code>deploying</code> stage).</p>
<hr />
<p><strong>1.7</strong>. Let's try to add a classical <code>for-loop</code> into JSP, and display a list of <code>String</code>s on the web page.</p>
<pre><code class="language-java">List&lt;String&gt; list = new ArrayList&lt;&gt;();
list.add(&quot;java&quot;); 
list.add(&quot;ee&quot;);
list.add(&quot;is&quot;);
list.add(&quot;fun&quot;);
for (String s : list) {
    System.out.println(s);
}
</code></pre>
<p>In JSP, all plain-old Java codes should be put between <code>&lt;%</code> and <code>&gt;%</code>. For example,</p>
<pre><code class="language-jsp">&lt;%
    List&lt;String&gt; list = new ArrayList&lt;&gt;();
    list.add(&quot;java&quot;);
    list.add(&quot;ee&quot;);
    list.add(&quot;is&quot;);
    list.add(&quot;fun&quot;);
    for (String s : list) {
        System.out.println(s);
    }
%&gt;
</code></pre>
<p>Unluckily, you will never see output on the web page because <code>System.out.println</code> will display the text on the standard output. One solution is to use <em>JSP expression tag</em>:</p>
<pre><code class="language-jsp">&lt;%= s %&gt;
</code></pre>
<p>Based on the above, try to output the content of <code>list</code> object in <code>index.jsp</code>.</p>
<hr />
<p><strong>1.8</strong>. You may notice a small image shown displayed next to the page title in the browser tab when you visit a website. Formally, it is a <a href="https://www.w3schools.com/html/html_favicon.asp">favicon</a>. Try to add your own <em>favicon</em> for your personal home page.</p>
<hr />
<p><strong>1.9</strong>. Try to rename your first Java web project's URL to <code>first-&lt;your name initials&gt;</code> in IntelliJ IDEA such that you can access the welcome page via a shorter URL. For example, suppose you are <em>Li Xiaohua</em>, the renamed one should be http://localhost:8080/first-lxh.</p>
<hr />
<p><strong>1.10</strong>. Based on Ex 1.7, try to output the <code>ArrayList</code> using a servlet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-2-web-app-architecture-and-mini-mvc"><a class="header" href="#chapter-2-web-app-architecture-and-mini-mvc">Chapter 2: Web App Architecture and Mini MVC</a></h1>
<p>What is the minimal runnable Java program? Most people probably are able write a simple <code>Hello World</code> application in handwritten code. Is there a <code>main()</code> method, right? It is the entry point of a program. Interestingly, <strong>servlets don't have a <code>main()</code> method</strong>. They’re under the control of another Java application called a <code>Container</code>.</p>
<p>We have briefly mentioned the <em>container</em> in <a href="ch2/../ch1/1.1.html">Section 1.1</a>, which is the referencing runtime in Jakarta EE, and Tomcat is an example of a container. To be specific, Tomcat is an Application Server which can also be used as a Web Server. It may be a little obscure for beginners to distinguish between <em>server</em> and <em>container</em>. </p>
<ul>
<li>Server, commonly used in our daily language, mainly refers to <a href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/What_is_a_web_server">web server</a> (i.e., HTTP server). It is capable of receiving HTTP requests and sending HTTP responses.</li>
<li>Container, mainly in Jakarta EE context, refers to the runtime for servlets, JSP, EJBs, etc. </li>
</ul>
<p>When your server gets a request for a <em>servlet</em> (as opposed to, say, a plain old static HTML page[1]), the server hands the request not to the servlet itself, but to the container, in which the servlet is <em>deployed</em>. It is the container that gives the servlet the HTTP request and response, and it's the container that calls the servlet's methods (like <code>doPost()</code> and <code>doGet()</code>).</p>
<p>In this chapter, we will discuss the web app architecture in a high-level overview, and then introduce MVC, a useful and well-tested model when developing user interface related applications.</p>
<p>We will also have a taste of CSS and modern web UI framework, and learn to how to beautify the bare web page.</p>
<hr />
<p>[1] In real world settings, people tend to use other application servers (e.g., <em>NGINX</em>) to send static files like images (.jpg, .png, .gif), stylesheets (.css) and JavaScript (.js) directly for better performance.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="21-servlet-and-container"><a class="header" href="#21-servlet-and-container">2.1 Servlet And Container</a></h1>
<p>What if you had Java, but no servlets or containers? Well, you can still use Java SE to handle the HTTP request. But, it would require overwhelming efforts. Basically, some key functions you would have to implement in plain old Java on your own if no container existed:</p>
<ul>
<li>Create a socket connection with the server, and create a listener for the socket.</li>
<li>Create a thread manager.</li>
<li>Implement security.</li>
<li>Convent a JSP to a Servlet.</li>
<li>...</li>
</ul>
<p>Thanks to the container. You get to concentrate more on your own business logic instead of worrying about writing code for threading, security, and networking. </p>
<blockquote>
<p>[!TIP]
Tomcat is the <em>container</em> we are using in the textbook.</p>
</blockquote>
<h2 id="how-the-container-handles-a-request"><a class="header" href="#how-the-container-handles-a-request">How the container handles a request</a></h2>
<p>As you have already known, <code>String</code> is a Java class used to manage a sequence of characters; <code>Date</code> is a Java class used to provide the ability to manipulate time; <code>Math</code> is Java class used to extend the capabilities that handle mathematical operations...</p>
<p>What is <code>Servlet</code> essentially? From the point of view of code, a servlet is no exception: it is a Java class that is used to extend the capabilities of servers that host applications accessed by means of a request-response programming model. </p>
<blockquote>
<p>[!TIP]
A servlet is a small Java program that runs within a Web server[1].</p>
</blockquote>
<pre><code class="language-java">public class HelloServlet extends HttpServlet {
    ...
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        ...
    }
}
</code></pre>
<p>Let's take a closer look at the <code>HelloServlet.java</code>. As the name implies, the <code>doGet()</code> method is to handle the HTTP GET request and then make a response. In the plain old Java code, there must another Java class to create an instance of <code>HelloServlet</code>, <code>HttpServletRequest</code> and <code>HttpServletResponse</code>. Without any doubt, it is the container's responsibility. The pseudo code[2] can be described as following:</p>
<pre><code class="language-java">// what happens in the container
HelloServlet servlet = new HelloServlet();
HttpServletRequest request = new HttpServletRequest();
HttpServletResponse response = new HttpServletResponse();
servlet.doGet(request, response);
</code></pre>
<p>Here's a quick overview about how the container handles a request, and it illustrates what happens behind the scene of Fig.1.12. We assume that the request is an HTTP GET.</p>
<ul>
<li><strong>Step 1</strong>: User clicks a link that has a URL to a servlet instead of a static page. The clicking behavior would generate an HTTP request sent to the container.</li>
</ul>
<p><img src="ch2/image/ch2-container-1.png" alt="Figure 2.1 Step 1: User sends a request." title=":size=70%" /></p>
<ul>
<li><strong>Step 2</strong>: The container &quot;sees&quot; that the request is for a servlet, so the container creates two objects: 1) HttpServletResponse and 2) HttpServletRequest.</li>
</ul>
<p><img src="ch2/image/ch2-container-2.png" alt="Figure 2.2 Step 2: Container creates request and response." title=":size=70%" /></p>
<ul>
<li><strong>Step 3</strong>: The container finds the correct servlet based on the URL in the request, creates or allocates a thread for that request, and passes the request and response objects to the servlet thread[3]. Note that different accesses to the same servlet are isolated threads.</li>
</ul>
<blockquote>
<p>[!TIP]
We will revisit the <em>thread</em> related issues in <a href="ch2/ch3/3.1">Section 3.1</a>.</p>
</blockquote>
<p><img src="ch2/image/ch2-container-3.png" alt="Figure 2.3 Step 3: Container passes request and response to servlet thread." title=":size=70%" /></p>
<ul>
<li><strong>Step 4</strong>: The container calls the servlet's <code>doGet()</code>, which generates a dynamic page and dumps the page into the response object. Remember, the container still has a reference to the response object.</li>
</ul>
<p><img src="ch2/image/ch2-container-4.png" alt="Figure 2.3 Step 4: Container calls doGet()." title=":size=70%" /></p>
<ul>
<li><strong>Step 5</strong>: The thread completes, and the container converts the response into an HTTP response, sends it back to the client, then deletes the request and response objects[4]. </li>
</ul>
<p><img src="ch2/image/ch2-container-5.png" alt="Figure 2.3 Step 5: Container sends back HTTP response." title=":size=70%" /></p>
<h2 id="what-makes-servlet-a-servlet"><a class="header" href="#what-makes-servlet-a-servlet">What makes servlet a servlet</a></h2>
<p>Back to the servlet itself, let's revisit how it looks in code line by line (<code>ch1/HelloServlet.java</code>).</p>
<pre><code class="language-java">// lines 1-6
package com.swufe.javaee.first_java_ee;

import java.io.*;

import javax.servlet.http.*;
import javax.servlet.annotation.*;
</code></pre>
<p>Every Java programmer should know what <code>package</code> and <code>import</code> are: <code>package</code> is to organize Java files into different modules or folders in your file systems, and importing a package allows you to access classes in the package in current Java file. Here <code>java.io.*</code> is the package of Java SE (under <code>java</code> namespace), while the remaining two belong to Jakarta EE (under <code>jakarta</code> namespace).</p>
<blockquote>
<p>[!NOTE]
In Java EE 8 or below, the namespace is <code>javax</code>, and it has been changed to <code>jakarta</code> since Jakarta EE 8.</p>
</blockquote>
<p>We leave the explanation of line 8 for the next subsection <strong>How the container finds the correct servlet</strong>.</p>
<pre><code class="language-java">// line 9
public class HelloServlet extends HttpServlet {
</code></pre>
<p>Here we have a Java class named <code>HelloServlet</code> extending <code>jakarta.servlet.http.HttpServlet</code>, so this self-defined class can reuse many methods as well fields from <code>HttpServlet</code>. As we mentioned above, the main purpose of a servlet is to handle requests and then make responses. Although there are other alternative communication protocols (e.g., FTP, SMTP), Jakarta EE only provides supports for HTTP(S) which are the most widely used in web era. As its name implies, <code>HttpServlet</code> is to used to create an HTTP servlet suitable for a Web site.</p>
<blockquote>
<p>[!NOTE]
99.999% of all servlets are HttpServlets.</p>
</blockquote>
<p>What about the next 0.001%? Well, in rare cases, you can even implement your own servlet to handle other network protocols in addition to HTTP(S). The following is a simple UML class diagram[5] to illustrate the servlet families.</p>
<p><img src="ch2/image/ch2-uml.png" alt="Figure 2.4 Servlet class diagram." title=":size=55%" /></p>
<p>As we can see, <code>Servlet</code> is an interface, and <code>GenericServlet</code>, an abstract class, is protocol-independent servlet. Implementation in UML is a hollow triangle shape on the interface end of the <em>dashed</em> line (----▻). <code>HttpServlet</code> is also an abstract class extending <code>GenericServlet</code>. Inheritance in UML is a hollow triangle shape on the superclass end of the line. It is important to understand the class diagram in a system if you want to have a quick overview in a high level.</p>
<pre><code class="language-java">// lines 16-24
public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException { // 16
    response.setContentType(&quot;text/html&quot;); // 17
    String message = &quot;Hello World!&quot;; // 18
    // Hello
    PrintWriter out = response.getWriter(); // 20
    out.println(&quot;&lt;html&gt;&lt;body&gt;&quot;); // 21
    out.println(&quot;&lt;h1&gt;&quot; + message + &quot;&lt;/h1&gt;&quot;); // 22
    out.println(&quot;&lt;/body&gt;&lt;/html&gt;&quot;); // 23
}
</code></pre>
<p>Slightly different from <code>HelloServlet.java</code>, we move the <code>message</code> variable into <code>doGet()</code> for the ease of explanation. First of all, <code>doGet()</code> is inherited from <code>HttpServlet</code> class, and it is used to handle HTTP GET method. To put it in another way, it is a method overriding, and to make it explicit, it is recommended to add <code>@Override</code> annotation before the method signature. As we discussed before, both <code>request</code> and <code>response</code> are created by the container, and they are interfaces to provide request and response information for HTTP servlets, respectively.</p>
<ul>
<li>Line 17: <code>setContentType()</code> is a method of <code>HttpServletResponse</code>, specifying the content-type, a.k.a MIME type of a response. You may refer to <a href="ch2/ch1/1.4.html">Section 1.4</a> if you are lost.</li>
<li>Line 19: Generally speaking, there are two kinds of data types, character text (e.g., <code>.html</code>, <code>.txt</code>) and non-plain text (e.g., <code>.jar</code>, <code>.png</code>), respectively, and <code>getWrite()</code> method of a response returns a <code>PrinterWriter</code> object that can send <strong>character text</strong> to the client.</li>
<li>Lines 21-22: Write some HTML elements into the <code>PrinterWriter</code>. Different from <code>System.out.println()</code>, which is to display some texts into the standard output[7], <code>println()</code> of <code>java.io.PrinterWriter</code> is to display texts into a a text-output stream[8], and you can simply image that a response object wraps a text stream.</li>
</ul>
<p><img src="ch2/image/ch2-response-writer.png" alt="Figure 2.5 Response and PrinterWriter." title=":size=60%" /></p>
<p>After <code>doGet()</code> is called, the container will convert this response object wrapped with contents into a real HTTP response and send it back to the client (i.e., a web browser in our case).</p>
<h2 id="how-the-container-finds-the-correct-servlet"><a class="header" href="#how-the-container-finds-the-correct-servlet">How the container finds the correct servlet</a></h2>
<p>In a real system, there is a large number of servlets. So, a natural question is: how does the container the correct servlet? </p>
<p>Consider you are writing a letter to your friend Bob, which information can help postman deliver your letter to Bob? Well, you may asked to write down Bob's address and name in the envelope. Similarly, the container also needs each servlet's &quot;address&quot; and &quot;name&quot;. Recall in the Step 3 of <strong>How the container handles a request</strong>:</p>
<blockquote>
<p>The container finds the correct servlet based on the URL in the request.</p>
</blockquote>
<p>The &quot;address&quot; (or &quot;name&quot;) of a servlet corresponds to the resource name in a URL that people input in the address bar of a web browser.</p>
<p><img src="ch2/image/ch2-url.png" alt="Figure 2.6 URL anatomy." title=":size=70%" /></p>
<p>In the last subsection, we omit line 8 of <code>HelloServlet.java</code> on purpose.</p>
<pre><code class="language-java">// line 8
@WebServlet(name = &quot;helloServlet&quot;, value = &quot;/hello-servlet&quot;)
</code></pre>
<p>It is a Java annotation introduced by Jakarta EE, which make it possible to map URLs to servlets[9], and it must be located before the class declaration. The key component of this annotation is <code>value = &quot;/hello-servlet&quot;</code>, implying the resource named <code>hello-servlet</code> will be routed to this servlet, while <code>name = &quot;helloServlet</code> is optional, and it does not really make sense in this example. You can also use <code>urlPatterns</code> to specify such mapping:</p>
<pre><code class="language-java">@WebServlet(urlPatterns = &quot;/hello-servlet&quot;)
</code></pre>
<blockquote>
<p>[!TIP]
Both <code>value</code> and <code>urlPatterns</code> in <code>@WebServlet</code> can map URLs, and <code>urlPatterns</code> is more powerful. More rules and usages will be covered later in this book.</p>
</blockquote>
<p>It is also fine to map several URLs to this servlet by specifying a list of values in <code>value</code> or <code>urlPatterns</code>.</p>
<pre><code class="language-java">@WebServlet(urlPatterns = {&quot;/a&quot;, &quot;/b&quot;})
</code></pre>
<p>Then you can access this servlet via either <code>/a</code> or <code>/b</code>. By the way, like variable naming, you should provide meaningful values for servlet, so  Since url mapping in the most important information of a servlet, there is a shorthand:</p>
<pre><code class="language-java">@WebServlet(&quot;/c&quot;)
</code></pre>
<h2 id="once-upon-a-time-a-servlets-name"><a class="header" href="#once-upon-a-time-a-servlets-name">Once upon a time: A servlet's name</a></h2>
<p>Before Servlet API 3.0, setting up the URL mappings is a bit overwhelming, and you have to use the deployment descriptor (DD) to tell the container how to run your servlets and JSPs. DD is a fairly simple XML document (<code>src | main | webapp | WEB-INF | web.xml</code>)[10], and annotations can replace equivalent XML configuration in DD such as servlet declaration and servlet mapping.</p>
<p>First of all, let's have glance at the <code>web.xml</code>. Basically, its syntax is similar with HTML as we have studied previously. The default DD is nearly empty, except a root element <code>&lt;web-app&gt;</code>. DD provides a &quot;declarative&quot; mechanism for customizing you web applications without touching source code, and this flexibility is sometimes preferred because any changes of source code will result in extra re-compiling (i.e., converting <code>.java</code> to <code>.class</code>) and re-packaging.</p>
<p>There is no essential difference between annotation and DD in terms of servlet mapping. The main idea is the same: create a connection between a servlet and a URL. When it comes to a servlet, it is a Java class with a fully-qualified name (i.e, package name + class name). For example, <code>HelloServlet</code>'s fully-qualified class name in <code>ch2</code> is <code>com.swufe.javaee.ch2.HelloServlet</code>. Firstly, you have to map an internal name, which is optional in annotations but necessary in DD, to the fully-qualified class name using <code>&lt;servlet&gt;</code> element. Note that internal name is only visible to developers not to end users.</p>
<pre><code class="language-xml">&lt;servlet&gt;
    &lt;servlet-name&gt;Some Name&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.swufe.javaee.ch2.HelloServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
</code></pre>
<p>As we can see, <code>&lt;servlet-name&gt;</code> and <code>&lt;servlet-class&gt;</code>, nested inside <code>&lt;servlet&gt;</code>, are used to specify the internal name and fully-qualified name, respectively.</p>
<p>Next, you also have to further map the internal name to URLs using <code>&lt;servlet-mapping&gt;</code> element. The value inside <code>&lt;servlet-name&gt;</code> is what we have defined in <code>&lt;servlet&gt;</code>, and <code>&lt;url-pattern&gt;</code> has the same functionality with the <code>value</code> or <code>urlPatterns</code> in annotations. </p>
<pre><code class="language-xml">&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;Some Name&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/hello-servlet&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre>
<p>To sum up, there are <em>THREE</em> names of a servlet, and <code>servlet-name</code> is the bridge mapping the servlet to URLs:</p>
<ul>
<li><strong>servlet-name</strong>: the internal name, which is logical.</li>
<li><strong>servlet-class</strong>: the fully-qualified class name, which is physical.</li>
<li><strong>url-pattern</strong>: the URL name, which is visible to end users.</li>
</ul>
<p><img src="ch2/image/ch2-three-names.png" alt="Figure 2.6 Three names of a servlet." title=":size=80%" /></p>
<p>Clearly, annotations make our lives easier, and they are also widely used in many popular frameworks, including Java's Spring and Python's Flask, so it is recommended to use annotations if possible. </p>
<hr />
<p>[1] In linguistics, <code>-let</code> often means <em>small</em>. For example, <em>booklet</em> is a small book or group of page; <em>tablet</em> is a small, solid piece of medicine. So <em>servlet</em>, literally, means a small program running in the server.</p>
<p>[2] The pseudo code <em>doesn't</em> really exist in Jakarta EE, and it only serves for the illustration purpose here.</p>
<p>[3] Process means any program is in execution, and thread means segment of a process. Since the servlet may be accessed by thousands of people simultaneously, there are many threads to create servlet instances. Creating threads can be a time consuming task, so many systems would maintain a thread pool, and therefore when a new request comes, an existing thread and instance will be allocated and reused for better performance.</p>
<p>[4] All objects in Java are references, so when passing an object to a function, any changes of the object can be observed by anyone who holds a reference to that object.</p>
<p>[5] Deletions are happened in an inexplicit way, and they are under the control of Java's garbage collection.</p>
<p>[6] UML, short for Unified Model Language, is a general-purpose, developmental, modeling language in the field of software engineering that is intended to provide a standard way to visualize the design of a system. A class diagram in UML is a type of static structure diagram that describes the structure of a system by showing the system's classes, their attributes, operations (or methods), and the relationships among objects. However, the class diagram used in this textbook is a simplified version, not the standard one.</p>
<p>[7] That default destination of the standard output is the display screen on the computer that initiated the program.</p>
<p>[8] I/O and networking operations are often abstracted as <em>streams</em>. Like water flow in a stream, we often emphasize data flow in program which has a destination.</p>
<p>[9] Such mapping from URLs to codes (i.e., methods, classes) is often called <code>routing</code>.</p>
<p>[10] XML, short of Extensible Markup Language, is similar to HTML, but without predefined tags to use. Instead, you define your own tags designed specifically for your needs.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="22-search-the-way-to-self-learning"><a class="header" href="#22-search-the-way-to-self-learning">2.2 Search: The Way To Self-learning</a></h1>
<p>When people start to learn a course or read a textbook, the first question that they may put forward to is probably: <em>what is the key point</em>? Now we would like to answer this question: <strong>this section is of great importance throughout this textbook, even throughout the journal of your programming learning</strong>.</p>
<p>Real beginners who start to learn programming often get lost when they are encountering something new, including new terms, new classes, and new methods. More or less, most people are afraid of things they are not familiar with, and this phenomenon is quite common even among expects. Technologies, especially the information technologies, are undergoing rapid changes, therefore it is impossible to rely on one book or one course if you would like to catch up with the state-of-the-art. How can you renew yourself? Well, perhaps the only way is to self-learning. And there is no doubt that a large number of &quot;new&quot;s would be the obstacles on your way to self-promotion. So how to escape from the vicious circle? The definite answer is short yet inspiring: <strong>search</strong>! <strong>search</strong>! <strong>search</strong>! </p>
<p>There are many awesome tools you can trust: search engines (e.g., Google, Bing), IDEs (e.g., Intellij IDEA), and websites (e.g., StackOverFlow). In this section, we will show you some practical skills of searching, and we believe it would be a lifelong benefit if you keep practicing.</p>
<h2 id="java-doc"><a class="header" href="#java-doc">Java Doc</a></h2>
<p>Reading documentation is a basic skill while learning programming. For example, some students may find it difficult to understand this following code in <a href="ch2/ch1/1.5.html">Section 1.5</a> because <code>java.time.LocalDate</code> is a strange API.</p>
<pre><code class="language-jsp">&lt;h2&gt;&lt;%= java.time.LocalDate.now() %&gt;&lt;/h2&gt;
</code></pre>
<p>Don't worry. Oracle provides the complete documentation for JDK (Java SE) API, often referred as Java Doc, according to which JDK version you are using, and it provides a user-friendly searching box. For example, in this textbook, we are using <a href="https://docs.oracle.com/en/java/javase/11/docs/api/index.html">JDK 11</a>. It is recommended to add this website into your bookmark.</p>
<p><img src="ch2/image/ch2-java-doc.png" alt="Figure 2.8 JDK documentation searching." title=":size=60%" /></p>
<p>After clicking the matching result, you will see the detailed API descriptions, including what this class does, what (public) methods and fields it has, and how to use its (public) methods and fields. </p>
<blockquote>
<p>A date without a time-zone in the ISO-8601 calendar system, such as 2007-12-03.</p>
</blockquote>
<p>For example, if you would like to convert a string <code>&quot;2008-8-8&quot;</code> (when Beijing Olympic was held) to the <code>LocalDate</code> object, please move to the <em>Method Summary</em> part, and after a quick glancing, you will notice </p>
<blockquote>
<p>static LocalDate	parse​(CharSequence text)	
Obtains an instance of LocalDate from a text string such as 2007-12-03.</p>
</blockquote>
<blockquote>
<p>[!NOTE]
All good APIs are generally intuitive, and it is straightforward to grasp what it does through its name.</p>
</blockquote>
<p>Based on its summary, this method probably meets your requirement. But wait a moment, it seems that it only supports strings like <code>&quot;2008-08-08&quot;</code> with padding zero. Please don't be overly concerned. Just take a brave try, and let Java compiler tells you the result. Remember: <em>talk is cheap, show me the code</em>[1].</p>
<p>You can create a simple Java project (or file) using your favorite IDE (or editor) to conduct an experiment. To keep consistency, here we adopt IntelliJ IDEA. Click <code>New Project</code> button in the welcome screen of IntelliJ IDEA, or <code>File | New | Project</code> at the menu if you have already opened an project. In the <code>New Project</code> dialog, select <code>Java</code>, and then click <code>Next</code> button. It is fine to leave all options as default, and input an appropriate project name (default is <code>untitled</code>) in your desired location, and then click <code>Finish</code> button. Now it is time to crate a new Java class by right clicking the <code>src</code> folder.</p>
<p><img src="ch2/image/ch2-java-project.png" alt="Figure 2.9 Create a Java class." title=":size=60%" /></p>
<p>Add a <code>main()</code> method:</p>
<pre><code class="language-java">import java.time.LocalDate;

public class Main {
    public static void main(String[] args) {
        LocalDate time = LocalDate.parse(&quot;2008-8-8&quot;);
        System.out.println(time);
    }
}
</code></pre>
<p>Click the green right triangle button (<span style='color: green'>▶</span>) on the left side of <code>public class Main</code>. Oops! An error, or technically, an exception, will be complained by Java compiler, and it is your task to fix this error. Go for it!</p>
<p>Sometimes it may be a bit cumbersome to crate a Java project for a simple API testing, and luckily, since Java 9, JShell, a Java read-eval-print loop (REPL)[2], has been introduced. Assume Java's path has been added into the <em>PATH environment variable</em>[3], you can open the terminal on Unix-like systems or CMD on Windows, and then input <code>jshell</code>:</p>
<p><img src="ch2/image/ch2-jshell.png" alt="Figure 2.10 JShell interface." title=":size=60%" /></p>
<p>And try to type <code>System.out.println(&quot;Hello World!&quot;);</code> after the <code>jshell&gt;</code> prompt. As usual Java code, type the following code:</p>
<p><img src="ch2/image/ch2-jshell-date.png" alt="Figure 2.11 LocalDate in JShell." title=":size=60%" /></p>
<p>If you want to exit from JShell, you can type <code>/exit</code>.</p>
<p>Back to the main focus, let's continue to learn how to use the Java Doc. Here are more examples:</p>
<ul>
<li>If you want to extract the days of the year from a <code>LocalDate</code> object (e.g., 33 days of <code>2022-02-02</code>), you will notice</li>
</ul>
<blockquote>
<p>int	getDayOfYear()	
Gets the day-of-year field.</p>
</blockquote>
<ul>
<li>If you want to determine whether a <code>LocalDate</code> object is a leap year[4], you will notice</li>
</ul>
<blockquote>
<p>boolean	isLeapYear()	
Checks if the year is a leap year, according to the ISO proleptic calendar system rules.</p>
</blockquote>
<p>As you can see, you will easily add many powerful weapons into your programming tool box if you get comfortable with Java Doc. Last but not least, many beginners may also ask this question: should I memorize those classes and methods as I recite English words? The answer can be &quot;yes or no&quot;. To begin with, like English words, never recite them by rote without their context. Secondly, remember the basic syntax is necessary and as for the remaining, just keep in mind that <em>no secret, I just have much experience</em>[5]. As long as you can find the right place to search APIs to solve your problem, forgetting is not a big deal, especially when you have to switch between different programming languages regularly.</p>
<h2 id="java-ee-api"><a class="header" href="#java-ee-api">Java EE API</a></h2>
<p>Similar to JDK document as well as any other frameworks and libraries, the ability to search Java EE API can be of great help. Similarly, based on which version you are using, you shall refer to the corresponding API documentations. For example, in this textbook, we are using <a href="https://tomcat.apache.org/tomcat-9.0-doc/servletapi/index.html">Tomcat 9</a>. It is also recommended adding this website into your bookmark.</p>
<blockquote>
<p>[!NOTE]
The skills discussed here is essentially the same with those in the last subsection.</p>
</blockquote>
<p>Recall the code in <code>HelloServlet.java</code>, and some beginners might get lost when they see <code>response.getWriter()</code>. Again, ask the API documentation for help. Luckily, the number of classes introduced by Tomcat is limited, and we can easily locate <code>HttpServletResponse</code> under <code>All Classes</code> panel. By the way, you can use the shortcut (<code>Ctrl + F</code> in Windows/Linux, and <code>Cmd + F</code> in MacOS) to locate a specific word quickly.</p>
<p><img src="ch2/image/ch2-response-api.png" alt="Figure 2.12 HttpServletResponse." title=":size=30%" /></p>
<p>And soon you will also find that <code>getWriter()</code> is not defined by <code>HttpServletResponse</code>, and instead, it is inherited from the interface <code>javax.servlet.ServletResponse</code>. Then follow this hint by clicking the hyperlink, and we shall find some information important:</p>
<blockquote>
<p>(ServletResponse) Defines an object to assist a servlet in sending a response to the client. ... To send character data, use the <code>PrintWriter</code> object returned by <code>getWriter()</code>.</p>
</blockquote>
<p>Still want to know about <code>PrintWriter</code>? Just ask the documentation for help, again! So, learning programming, especially when looking up API documentations, is much like looking up a dictionary.</p>
<h2 id="intellij-idea"><a class="header" href="#intellij-idea">IntelliJ IDEA</a></h2>
<p>Modern IDEs, such as IntelliJ IDEA and Eclipse, provide built-in supports for API documentations looking-up, and they are often the main entry-point if you would like to inspect the source code. In this textbook, we will take IntelliJ IDEA, the most popular IDE among Java developers, as the running example.</p>
<p>Firstly, when you move the cursor to a <em>Class</em>, <em>Interface</em>, or <em>method</em>, the corresponding description of the API. For instance, the following illustrates what will pop up when you move the cursor to <code>String</code>.</p>
<p><img src="ch2/image/ch2-string.png" alt="Figure 2.13 API summary of String." title=":size=50%" /></p>
<p>You can practice this useful skill by moving the cursor to <code>setContentType</code> and <code>HttpServlet</code>, respectively.</p>
<p>Secondly, when you move the cursor and please keep pressing-down the Ctrl in Windows/Linux and Cmd in MacOS, you will notice that <em>Class</em>, <em>Interface</em>, <em>method</em>, and <em>variables</em> are becoming hyperlinks. So you could jump among Java codes and locate their implementations. FOr example, if you are curious about how <code>println</code> of <code>PrinterWriter</code> is implemented, you could see the following (don't worry if you cannot get grasp of the code itself):</p>
<pre><code class="language-java">public void println(String x) {
    synchronized (lock) {
        print(x);
        println();
    }
}
</code></pre>
<p>Anyway, all classes, interfaces and methods are not in a black-box now, and you can inspect them clearly.</p>
<hr />
<p>[1] It is a famous quote by Linus Torvalds, the father of Linux.</p>
<p>[2] REPL is an interactive tool for leaning programming language, mostly found in scripting languages such as Python, JavaScript and Ruby, which enables users to write codes on the command line and see the results immediately.</p>
<p>[3] PATH is an environment variable that is used by Operating System to locate the executive programs (e.g., <code>.exe</code> on Windows) or java binaries (e.g., <code>java</code> or <code>javac</code> command). Instruction on how to set environment path for Java can be found <a href="https://www.geeksforgeeks.org/how-to-set-java-path-in-windows-and-linux/">here</a>.</p>
<p>[4] Leap years are years where an extra, or intercalary, day is added to the end of the shortest month, February. For example, in the Gregorian calendar, each leap year has 366 days instead of 365.</p>
<p>[5] A Chinese old saying: 无他，但手熟尔.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="23-a-brief-introduction-to-mvc"><a class="header" href="#23-a-brief-introduction-to-mvc">2.3 A Brief Introduction To MVC</a></h1>
<p>In our simple <code>first_java_ee</code> project, we have presented servlets and JSP, two of the most essential components in Java EE's web profile. Both can generate web pages dynamically through a request-response model. And we also briefed discussed the importance of introducing JSP in <a href="ch2/ch1/1.5.html">Section 1.5</a>.</p>
<p>Now let's move forward, and consider the case that you are going to design and develop a large web site. When it comes to <em>large</em>, it mainly means that it provides many functionalities, and therefore, many web pages. For example, for a book-selling website like Amazon, it must meet the basic requirements as the following:</p>
<ul>
<li>User sign up and login</li>
<li>Admin add/delete/modify books</li>
<li>Display the books</li>
<li>Search the books</li>
<li>Purchase books</li>
<li>Track the delivering of books</li>
<li>...</li>
</ul>
<p>Will you create a servlet for each single functionality point?[1] If so, it would result in a mess. The reasons are several-folds, and the advantages of JSP can be the pitfalls of servlets. Then, can we replace all servlets with JSP? Well, technically, it is possible, and it would result in a bigger mess. No one really likes to write Java code inside HTML, and it is quite <em>UGLY</em>.</p>
<h1 id="combine-servlets-and-jsp"><a class="header" href="#combine-servlets-and-jsp">Combine servlets and JSP</a></h1>
<p>To answer such vexed question, we can use both servlets and JSP at the time, and the two messes together can magically be a harmony. Why can it be? Well, the basic idea is simple: <em>make each one shoulder a different responsibility</em>. To be specific, servlets deal with the business logic, such as retrieving data from database[2], while JSP only cares about how to display the data (i.e., presentation)[3]. Take a restaurant an example. In the restaurant industry, some parts of a restaurant are referred to as front of house and others as back of house. Front of house is where customers are. Back of house is where the chefs work in the kitchen[4]. Dishes (like data) are made by chefs (<code>back-end</code>, like servlets) and delivered to customers by waiters (<code>front-end</code>, like JSP). Note that waiters themselves do not make dishes directly, and chefs do not contact with customers directly either. Of course, this analogy is not completely technically correct, because the dishes delivered to customers are exactly what chefs made, however the data presented to the client can be different from what servlets generated.</p>
<p><img src="ch2/image/ch2-restaurant.png" alt="Figure 2.14 How dishes moved in a restaurant." title=":size=50%" /></p>
<p>Let's consider the case of user login in a book-selling website. When a user sends her name and password by making an HTTP request, the destination servlet would authenticate her by further retrieving data from the database to determine whether this name exits, and whether password is matched. Suppose both the name and password are correct, the servlet mostly would send data wrapped with the user's profile in a Java object or simply JSON[5], or simply with an OK message, such as <code>&quot;Login success&quot;</code>, to JSP. And suppose either the name and password is wrong, the servlet mostly send data wrapped with an error message, such as <code>&quot;Login failed&quot;</code>, to JSP.</p>
<p>Before we move on, let's have a warm-up to figure out how a servlet is forwarded to JSP, without considering the extra data transferred. Recall that in <code>index.jsp</code>, the HTML <code>&lt;a href=&quot;hello-servlet&quot;&gt;Hello Servlet&lt;/a&gt;</code> can create a clickable hyperlink to <code>hello-servlet</code>, and that happens in the browser. However, the process that a servlet is forwarded to JSP happens in the server through the same request. Sound a little obscure? Let the code talk. First of all, create <code>a.jsp</code> under <code>webapp</code>, and add anything you like inside it. Then create <code>ForwardServlet.java</code> under <code>src | main | java | com.swufe.javaee.ch2</code>, and add the following code inside <code>doGet()</code> of <code>ForwardServlet.java</code>:</p>
<pre><code class="language-java">RequestDispatcher dispatcher = request.getRequestDispatcher(&quot;a.jsp&quot;);
dispatcher.forward(request, response);
</code></pre>
<p>The default URL name of <code>ForwardServlet</code> is <code>/ForwardServlet</code>, and try to access it. If everything goes well, you shall see the content of <code>a.jsp</code>. Aha! The servlet successfully forward a request to another JSP. Please note that it is to <strong>forward a request</strong>. To put it another way, both servlet and JSP are using the same request object, and the forwarding happens in the server. People who are with shape eyes might notice that although the display content is from <code>a.jsp</code>, the URL remains <code>/ForwardServlet</code>. </p>
<p><img src="ch2/image/ch2-forward.png" alt="Figure 2.15 Servlet forwards request to JSP." title=":size=60%" /></p>
<p>Let's have a coffee and take a break as information is overloaded in the last paragraph. Don't get depressed if you have troubles in understanding what it means. We will talk about <code>RequestDispatcher</code> again in the latter of this book, and you can also explore this API on your own by applying the skills you learned in the last section.</p>
<h2 id="mvc"><a class="header" href="#mvc">MVC</a></h2>
<p>Now it is time to introduce <code>MVC</code>, a commonly used software design pattern. In the subsection, we separated the roles of servlets and JSP, and in fact, we can further take some responsibilities out of servlets.</p>
<p>Let's revisit the business logic, which is mainly related with the database. In the book-selling website example, it may include:</p>
<ul>
<li>User authentication.</li>
<li>Retrieve a user's profile.</li>
<li>Add/delete book.</li>
<li>Predicate &quot;Guess you like&quot; from the recommendation system.</li>
<li>...</li>
</ul>
<p>A simple question is: must those business logics be in servlets? Or, what are the advantages if we can take them out of servlets? The benefits of the further separating are mainly tremendous. Not every Java programmer needs to know Java EE, and they would like to write plain old Java code[6]. Also, plain code Java code with Java EE runtime will occur in less performance overhead. And most importantly, it paves the way to reuse existing awesome Java libraries. For example, the recommendation system may be written in plain old Java code, and it can used not only by the web applications, but also by Android, iOS and desktop applications. You should never assume that your business logic will be accessed <em>only</em> from the web.</p>
<p>Therefore, we can take the business logic out of the servlet, and put it in a &quot;Model&quot; (i.e., a reusable plain old Java class). The model is a combination of the business data (like the profile of a book) and that methods (rules) operate on that data. The role of a JSP remains the same. It acts as a &quot;View&quot; and is responsible for the presentation. In the same time, the servlet degrades to a &quot;Controller&quot;, and it mainly takes user input from the request and figures out what it means to the model. It also tells the model to update itself, and makes the new model state available for the view.</p>
<p><img src="ch2/image/ch2-mvc.png" alt="Figure 2.16 MVC architecture." title=":size=55%" /></p>
<p>To put them together, the whole web application is divided into three parts: Model, View and Controller (a.k.a., MVC). MVC is a pattern in software design commonly used to implement user interfaces, data, and controlling logic. It emphasizes a separation between the software’s business logic and display. This &quot;separation of concerns&quot; provides for a better division of labor and improved maintenance. Also note that, MVC is not specific to servlets and JSPs. The clean separation of business logic and presentation is just as valid in any other kind of application.</p>
<p>Understanding MVC is important when developing a web application, and we will stick with this design pattern throughout this book from now on. We also will discuss how to improve this MVC design in the latter of this book.</p>
<hr />
<p>[1] Separating different functionality points into different classes/methods is a common and well-tested approach in developing software, because no one would like to maintain a giant class/method.</p>
<p>[2] Database means the location where data is stored literally. In fact, it is one of the core courses in Computer Science, and is also of importance for web developing. Some fundamental introduction to database will be covered in the later of this book.</p>
<p>[3] The component that cares about the business logic is also known as <code>back-end</code>. As the counterpart, the one that cares about the presentation is also known as <code>front-end</code>. For example, people who develops HTML, CSS and JS are <em>front-end developers</em>.</p>
<p>[4] This example is adapted from <a href="https://doc.rust-lang.org/book/ch07-02-defining-modules-to-control-scope-and-privacy.html">Rust Book</a>.</p>
<p>[5] JSON, short for JavaScript Object Notation, is a lightweight data-interchange format, and it is &quot;self-describing&quot; and easy to understand. For example, the JSON String <code>{&quot;name&quot;:&quot;John&quot;, &quot;age&quot;:30}</code> defines an object with 2 properties, and each property has a value. JSON is widely used in web, and we will cover it in the later.</p>
<p>[6] In software engineering, plain old Java code means ordinary Java code, not bound by any special restriction.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="24-hands-on-mvc-1"><a class="header" href="#24-hands-on-mvc-1">2.4 Hands On MVC (1)</a></h1>
<p>In the last section, we have studied the basic principles about MVC, and it is time to get your hands dirty to write a practical web application with MVC design. Particularly, you will learn a large number of modern web developing knowledge. Although this app is very small, the main principle remains the same even if you are going to build something huge. By the way, today's small app is tomorrow's dot-com success. Keep going!</p>
<p>We will use the book-selling website as our running example. Firstly, let's summarize the requirements. User can select the genre of books in the web page, and send an HTTP request to the server. Then the destination servlet would retrieve book recommendation from a model, and then send back the result to a JSP for display. All code in this section can be found in <code>mini-mvc</code>.</p>
<h2 id="front-end-design"><a class="header" href="#front-end-design">Front-end design</a></h2>
<p>Although it is possible to put HTML elements into both JSP and HTML, a plain HTML is always preferable if no dynamic content is required. So let's get started with the front-end design with a plain HTML. First of all, let's try to figure out why <code>index.jsp</code> is launched automatically when you start the web app. This is because the default start page of most web servers and containers is <em>index</em>, including <code>index.html</code>, <code>index.htm</code>, and <code>index.jsp</code>. </p>
<blockquote>
<p>[!NOTE]
By default, Tomcat would locate and display the <em>index</em> page (e.g., <code>index.html</code>, <code>index.jsp</code>). If it is not found, there will be a 404 error. Suppose your entry page is another file, say <code>form.html</code>, and <strong>you can still visit it by its URL explicitly</strong>. For example, http://localhost:8080/myapp/form.html.</p>
</blockquote>
<p>In order to build a website from scratch, we delete the auto-generated <code>HelloServlet.java</code> and <code>index.jsp</code>, and create an empty <code>index.html</code> under <code>webapp</code> folder as the entry point of our web app.</p>
<p>The UI interface of our book-selling website only contains:</p>
<ul>
<li>A descriptive title (clearly it is <code>&lt;h1&gt;</code> element)</li>
<li>A select box</li>
<li>A button</li>
</ul>
<p><img src="ch2/image/ch2-select.png" alt="Figure 2.17 Book-selling web UI." title=":size=40%" /></p>
<p>Let's recall the expected behavior in this web page: a user selects a genre of books and sends an HTTP request by clicking the <code>submit</code> button. </p>
<blockquote>
<p>[!NOTE]
In HTML, we shall use the <code>&lt;form&gt;</code> tag to send an HTTP request.</p>
</blockquote>
<p>Those elements which are capable of shipping with <em>input data</em> can be used inside <code>&lt;form&gt;</code>, and they are usually called <em>form element</em>. <code>&lt;select&gt;</code> is the one that is able to create a drop-down list with several options. The full HTML code is as what follows:</p>
<pre><code class="language-html">&lt;form&gt;
    &lt;label for=&quot;books&quot;&gt;Choose a genre:&lt;/label&gt;
    &lt;select name=&quot;books&quot; id=&quot;books&quot;&gt;
        &lt;option value=&quot;novel&quot;&gt;novel&lt;/option&gt;
        &lt;option value=&quot;history&quot;&gt;history&lt;/option&gt;
        &lt;option value=&quot;math&quot;&gt;math&lt;/option&gt;
        &lt;option value=&quot;programming&quot;&gt;programming&lt;/option&gt;
    &lt;/select&gt;
    &lt;br&gt;&lt;br&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;
&lt;/form&gt;
</code></pre>
<blockquote>
<p>[!TIP]
If you have some troubles in understanding various HTML tags, please visit <a href="https://www.w3schools.com/html/default.asp">HTML Tutorial</a>.</p>
</blockquote>
<p>The <code>&lt;label&gt;</code> here is optional, and is used to represent a caption for an item in a user interface. Otherwise, users may have no idea of what <code>&lt;select&gt;</code> is going to do. The attribute <code>for</code> is to specify the <code>id</code> of the form element the label should be bound to.</p>
<p><img src="ch2/image/ch2-label.png" alt="Figure 2.17 &lt;label&gt; element." title=":size=60%" /></p>
<p>Let's take a closer look at <code>&lt;select&gt;</code>. Its <code>id</code> attribute serves a unique identifier, as all HTML tags do, and <code>id</code> here also used to bind to the <code>&lt;label&gt;</code> element as we have discussed. What is <code>name</code> attribute used for? We will leave this problem to the latter. </p>
<p>We can notice that four <code>&lt;option&gt;</code> elements are nested inside <code>&lt;select&gt;</code>, and this is used to define an option in a select list. The <code>&lt;option&gt;</code> tag can be used without any attributes, but you usually need the <code>value</code> attribute, which indicates what is sent to the server on form submission. Some beginners might find it difficult to distinguish between the <code>value</code> and the element content. In fact, they have nothing to do with each other, and Fig 2.18 illustrates the differences.</p>
<p><img src="ch2/image/ch2-option.png" alt="Figure 2.18 &lt;option&gt; element." title=":size=50%" /></p>
<p>You can either open <code>index.html</code> via a web browser directly in the file manager (such as <code>Finder</code> on MacOS, <code>Explorer</code> on Windows, <code>Nautilus</code> on Ubuntu), or open it via built-in preview in IntelliJ IDEA. Now we have finished the front-end design, but an important question emerges: <strong>how can HTML, or more specific, <code>&lt;form&gt;</code> send data to the server</strong>? Not surprisingly, it is specified by a <code>&lt;form&gt;</code> attribute.</p>
<pre><code class="language-html">&lt;form action=&quot;some_servlet&quot;&gt;
    ...
&lt;/form&gt;
</code></pre>
<p>As the code shows, the value of <code>action</code> is the destination servlet's URL name. In other words, a servlet whose URL name is <code>some_servlet</code> is going to handle this HTTP request. By the way, HTTP also defines a set of request methods to indicate the desired action to be performed for a given resource, and the default method in <code>&lt;form&gt;</code> is <code>GET</code>. You can also specify the HTTP method using <code>method</code> attribute explicitly.</p>
<p><code>&lt;input&gt;</code> can be in various forms given different <code>type</code> attribute. For example, <code>submit</code> would render it as a button, and it shall send an HTTP request (i.e., <code>submit</code> a form) after clicking. It can also be replaced with a <code>&lt;button&gt;</code> tag:</p>
<pre><code class="language-html">&lt;button type=&quot;submit&quot;&gt;Submit&lt;/button&gt;
</code></pre>
<p>And two ways are equivalent. You can try out <a href="https://www.w3schools.com/html/html_form_input_types.asp">different input types</a> if you are interested, such as:</p>
<ul>
<li><code>&lt;input type=&quot;text&quot;&gt;</code></li>
<li><code>&lt;input type=&quot;color&quot;&gt;</code></li>
<li><code>&lt;input type=&quot;date&quot;&gt;</code></li>
<li><code>&lt;input type=&quot;password&quot;&gt;</code></li>
<li>...</li>
</ul>
<h2 id="back-end-design"><a class="header" href="#back-end-design">Back-end design</a></h2>
<p>Let's create a servlet <code>BookServlet.java</code>, with the URL name <code>/book</code>, to receive the data from the front-end. First of all, make sure the <code>action</code> attribute of <code>&lt;form&gt;</code> is set to <code>book</code>.</p>
<p><img src="ch2/image/ch2-action.png" alt="Figure 2.19 The action attribute and URL name." title=":size=50%" /></p>
<blockquote>
<p>[!TIP]
You will encounter some new APIs. Don't panic, and be brave to look up them using the skills in <a href="ch2/ch2/2.2.html">Section 2.2</a>.</p>
</blockquote>
<p>Based on the introduction to HTTP in <a href="ch2/ch1/1.4.html">Section 1.4</a>, the data is wrapped in the HTTP request, and they are usually called <em>parameters</em>*. Then how to extract parameters from the request? Luckily, <code>HttpServletRequest</code> has an API called <code>getParameter()</code>.</p>
<blockquote>
<p>String	getParameter(String name)	
Returns the value of a request parameter as a String, or null if the parameter does not exist.</p>
</blockquote>
<p>Remember the <code>name</code> attribute of <code>&lt;select&gt;</code>? It is actually the <em>name</em> of a parameter. </p>
<p><img src="ch2/image/ch2-form-name.png" alt="Figure 2.20 name attribute and getParameter()." title=":size=50%" /></p>
<p>And the following is our first version of <code>doGet()</code>:</p>
<pre><code class="language-java">PrintWriter out = response.getWriter();
response.setContentType(&quot;text/html&quot;);
String book = request.getParameter(&quot;books&quot;);
out.println(&quot;Book Selection:&quot;);
out.println(book);
</code></pre>
<p>(Note that we don't output HTML tags, but output the content directly. It still works because the web browser is smart enough to detect out intention.)</p>
<p>Stop here and try to start this web app, and observe what you see when you click the button in <code>index.html</code>. Note that such iterative <em>test-driven</em> approach is very common in software developing. Write some code and then test if it works well. If so, keep going and write more code. Otherwise, go back to fix the bug.</p>
<p>Now it is time to write code for models. In this web app, the <em>Model</em> is to make books recommendations, and it is plain old Java code. We firstly create a <code>model</code> package, and then create a <code>Recommendation</code> class:</p>
<pre><code class="language-java">public class Recommendation {
    public List&lt;String&gt; getBooks(String genre) {
        List&lt;String&gt; result = new ArrayList&lt;&gt;();
        if (genre.equals(&quot;novel&quot;)) {
            result.add(&quot;The Great Gatsby&quot;);
            result.add(&quot;Gone with the Wind&quot;);
        } else if (genre.equals(&quot;history&quot;)) {
            result.add(&quot;1587, a Year of No Significance&quot;);
        } else if (genre.equals(&quot;math&quot;)) {
            result.add(&quot;The Linear Algebra Survival Guide&quot;);
        } else if (genre.equals(&quot;programming&quot;)) {
            result.add(&quot;Head First Java Web&quot;);
            result.add(&quot;Effective Java&quot;);
        }
        return result;
    }
}
</code></pre>
<p>Then <code>BookServlet</code>, as the <em>Controller</em>, obtains the model from <code>Recommendation</code>. Here is our second version of <code>doGet()</code> (repeating code is omitted).</p>
<pre><code class="language-java">List&lt;String&gt; books = new Recommendation().getBooks(book);
for (String b : books) {
    out.println(b);
}
</code></pre>
<p>(Again, keep the <code>design-code-test</code> cycle in mind.)</p>
<p>Lastly, we need a <em>View</em> for this web app, and take the presentation role out of <code>BookServlet</code>. So, let's create a <code>result.jsp</code>. In the last section, we have learned how to forward a request to JSP using <code>RequestDispatcher</code>, and there is still unsolved issue: <strong>how to send data back to JSP</strong>? Understanding such data share mechanism is an essential part in web developing, and we will cover in detail in the later of the book. Now we only introduce one of the methods. </p>
<p>Recall that when forwarding, both the servlet and JSP share the same <em>request</em> object, so <strong>any changes to the request by the servlet shall also be observed by the JSP</strong>. Intuitively, the main idea is to <code>request.setXXX()</code> in <code>BookServlet.java</code>, and then <code>request.getXXX()</code> in <code>result.jsp</code>[1]. And this is exactly how the servlet's API is designed. The following is our third (and final) version of this web application.</p>
<pre><code class="language-java">String book = request.getParameter(&quot;books&quot;);
List&lt;String&gt; books = new Recommendation().getBooks(book);
request.setAttribute(&quot;books&quot;, books);
RequestDispatcher dispatcher = request.getRequestDispatcher(&quot;result.jsp&quot;);
dispatcher.forward(request, response);
</code></pre>
<p>As we can see, the <code>setAttribute()</code> method does what we really want! Its second parameter is the object we store, and its first parameter is the <em>name</em> of the object. Note that the exact name is not important, as long as we can keep it consistent when retrieving this object.</p>
<blockquote>
<p>void	setAttribute(String name, Object o)	
Stores an attribute in this request.</p>
</blockquote>
<p>And then we can use <code>getAttribute()</code> in <code>result.jsp</code> expectedly. Note that this method would return an <code>Object</code>, so we shall convert it back to <code>List&lt;String&gt;</code> first.</p>
<pre><code class="language-jsp">&lt;%
    List&lt;String&gt; books = (List&lt;String&gt;) request.getAttribute(&quot;books&quot;);
    for (String b : books) {
%&gt;
&lt;%= b %&gt;
&lt;% } %&gt;
</code></pre>
<p>Standard Java code in JSP is put inside <code>&lt;% %&gt;</code> tags, and this is known as <em>scriptlet code</em>.
The <code>&lt;%= %&gt;</code> is <em>JSP expression tag</em>, which was introduced in <a href="ch2/ch1/1.5.html">Section 1.5</a>.</p>
<p><img src="ch2/image/ch2-request.png" alt="Figure 2.21 request's getAttribute()." title=":size=50%" /></p>
<p>Some beginners may ask, where does the variable <code>request</code> come from? Good question. It is one of implicit objects in JSP, and we will introduce more implicit objects in the latter of this book. For example, <code>request</code> is an instance of <code>HttpServletRequest</code>, <code>out</code> is another implicit object (an instance of <code>PrintWriter</code>) for the ease of output. So the code above can be rewritten as:</p>
<pre><code class="language-jsp">&lt;%
    List&lt;String&gt; books = (List&lt;String&gt;) request.getAttribute(&quot;books&quot;);
    for (String b : books) {
        out.println(b);
    }
%&gt;
</code></pre>
<p>Congratulations! You have built your first mini MVC web application! Although there are still some pitfalls in its design and code, it can be a good prototype for any complex projects based on serlvets. </p>
<h2 id="a-caution-before-moving-on"><a class="header" href="#a-caution-before-moving-on">A caution before moving on</a></h2>
<p>Understanding this mini MVC project is very important for later more advanced topics, So please be patient, slow down and learn it by doing again and again. In particular, some beginners may be confused about the repeated names, such as <code>&quot;books&quot;</code> and <code>&quot;book&quot;</code>, because those names have different meanings in different contexts. If you have the similar doubt, please refer to Fig 2.17-2.21.</p>
<p>In addition, although it is possible to sent HTTP requests to JSPs directly, please avoid do this if possible, because it would break the MVC design.</p>
<hr />
<p>[1] Such code paradigm is called <em>setter/getter</em>, and it is widely used in many object-oriented programmings, such as Java, C#.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="25-hands-on-mvc-2"><a class="header" href="#25-hands-on-mvc-2">2.5 Hands On MVC (2)</a></h1>
<p>In this section, we are going to enhance the mini MVC project by introducing CSS. It is not mandatory for Java developers to master front-end technologies, but enriching your developing toolbox is always welcome if the input-output ratio is relatively small[1]. And strictly speaking, when it comes the front-end, both CSS and JS are essential. However, in this textbook, we only focus on basic CSS, a practical skill with small input-output ratio, and further self-learning is welcomed.</p>
<blockquote>
<p>[!NOTE]
You can jump to the next chapter directly if you are not interested in the front-end skills.</p>
</blockquote>
<h2 id="a-brief-introduction-to-css-2"><a class="header" href="#a-brief-introduction-to-css-2">A brief introduction to CSS [2]</a></h2>
<p>Cascading Stylesheets — or CSS — is the first technology you should start learning after HTML. While HTML is used to define the structure and semantics of your content, CSS is used to style it and lay it out[3]. For example, you can use CSS to alter the font, color, size, and spacing of your content, split it into multiple columns, or add animations and other decorative features.</p>
<p>Fist of all, let's have a look at CSS syntax. CSS is a rule-based language — you define rules specifying groups of styles that should be applied to particular elements or groups of elements on your web page. For example &quot;<em>I want the main heading on my page to be shown as large red text.</em>&quot;</p>
<p>The following code shows a very simple CSS rule that would achieve the styling described above:</p>
<pre><code class="language-css">h1 {
    color: red;
    font-size: 5em;
}
</code></pre>
<p>The rule opens with a <code>selector</code> . This selects the HTML element that we are going to style. In this case we are styling level one headings (<code>&lt;h1&gt;</code>). We then have a set of curly braces <code>{ }</code>. Inside those will be one or more <strong>declarations</strong>, which take the form of <strong>property</strong> and <strong>value</strong> pairs. In our example, we have the <code>color</code> property, which can take various <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Values_and_units#color">color values</a>. We also have the <code>font-size</code> property. This property can take various <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Building_blocks/Values_and_units#numbers_lengths_and_percentages">size units</a> as a value.</p>
<p>The CSS code above can be put in the <code>&lt;style&gt;</code> tag nested in <code>&lt;head&gt;</code>, and you can find the complete code in <code>index2.html</code> under <code>mini-mvc | src | main | webapp</code>.</p>
<p><img src="ch2/image/ch2-css-1.png" alt="Figure 2.22 A simple CSS style." title=":size=50%" /></p>
<p>Of course, this new HTML page is far away from beauty, but it is a good start for <em>styling</em>. In practice, we often write CSS code in a single file (<code>.css</code>) for the ease of reuse[4], and then <em>link</em> to that CSS file in HTML via <code>&lt;link&gt;</code> tag nested in <code>&lt;head&gt;</code>. You can find the complete code in <code>index3.html</code> under <code>mini-mvc | src | main | webapp</code>.</p>
<pre><code class="language-html">&lt;link href=&quot;index.css&quot; rel=&quot;stylesheet&quot;&gt;
</code></pre>
<h2 id="the-key-to-css-selector"><a class="header" href="#the-key-to-css-selector">The key to CSS: selector</a></h2>
<blockquote>
<p>CSS selectors define the elements to which a set of CSS rules apply.</p>
</blockquote>
<p>When learning CSS, people often have to understand how to use a <strong>selector</strong> as well as the supported properties and values given a <em>selector</em>. Generally speaking, a <em>selector</em> is used to select the element(s) you want to style. Here is a complete <a href="https://www.w3schools.com/cssref/trysel.asp">selector sheet</a>. In our example, the selector <code>h1</code> is to select all <code>&lt;h1&gt;</code> elements.</p>
<p>Each CSS rule starts with a selector — or a list of selectors — in order to tell the browser which element or elements the rules should apply to. All the examples below are valid selectors or lists of selectors.</p>
<pre><code class="language-css">h1
a:link
.manythings
#onething
.box p
.box p:first-child
h1, h2, .intro
</code></pre>
<p>It seems a bit obscure. Calm down. As for basic selectors, there are only three forms:</p>
<ul>
<li><strong>Type selector</strong>. Selects all elements that have the given node name. For example, <code>h1</code> will match any <code>&lt;h1&gt;</code> element. </li>
<li><strong>Class selector</strong>. Selects all elements that have the given class attribute. For example, <code>.index</code> will match any element that has a class of &quot;index&quot;.</li>
<li><strong>ID selector</strong>. Selects an element based on the value of its id attribute. There should be only one element with a given ID in a document. For example, <code>#toc</code> will match the element that has the ID &quot;toc&quot;.</li>
</ul>
<p>In <code>index3.html</code>, we define two classes, <code>foo</code> and <code>bar</code>, respectively.</p>
<pre><code class="language-html">&lt;h2 class=&quot;foo&quot;&gt;Class foo is #568900&lt;/h2&gt;
&lt;h2 class=&quot;bar&quot;&gt;Class bar is rgb(10, 20, 100)&lt;/h2&gt;
</code></pre>
<p>The following is CSS with <em>class selector</em>:</p>
<pre><code class="language-css">.foo {
    color: #568900;
}

.bar {
    color: rgb(10, 20, 100);
}
</code></pre>
<p>Recall the <code>&lt;select&gt;</code>'s id attribute is <code>books</code>, and the following is CSS with <em>ID selector</em>:</p>
<pre><code class="language-css">#books {
    background-color: cadetblue;
}
</code></pre>
<p>As a final exercise, we firstly add <code>class=&quot;button&quot;</code> for the submit button, then in <code>index.css</code>. Preview <code>index3.html</code>, and try to understand how it works.</p>
<pre><code class="language-css">.button {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
}
</code></pre>
<h2 id="ui-framework-bootstrap"><a class="header" href="#ui-framework-bootstrap">UI framework: Bootstrap</a></h2>
<p>Mastering CSS and JS is important if you would like to have a deep understanding about the front-end. However, due to the time limit of a one-semester course, we won't focus on them. In addition, the main aim of this book is to train yourself as a qualified back-end Java web developer. So, how can you write a modern web page with very limited front-end skills? Well, it is possible as there are many awesome UI frameworks (e.g., <a href="https://getbootstrap.com/">Bootstrap</a>) available that help you build elegant web pages like playing lego games.</p>
<p>Bootstrap, the world’s most popular front-end open source toolkit, is directed at responsive, mobile-first web development. What does Bootstrap do for you exactly? Well, it has extensive prebuilt CSS rules for commonly used UI components, including <em>buttons</em>, <em>forms</em>, <em>navbar</em>, so you can apply those rules without writing them manually. Recall the stylish button above. Bootstrap also includes several predefined button styles (such as <code>btn-primary</code>), each serving its own semantic purpose.</p>
<pre><code class="language-html">&lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot;&gt;Primary&lt;/button&gt;
&lt;button type=&quot;button&quot; class=&quot;btn btn-secondary&quot;&gt;Secondary&lt;/button&gt;
&lt;button type=&quot;button&quot; class=&quot;btn btn-success&quot;&gt;Success&lt;/button&gt;
&lt;button type=&quot;button&quot; class=&quot;btn btn-danger&quot;&gt;Danger&lt;/button&gt;
&lt;button type=&quot;button&quot; class=&quot;btn btn-warning&quot;&gt;Warning&lt;/button&gt;
&lt;button type=&quot;button&quot; class=&quot;btn btn-info&quot;&gt;Info&lt;/button&gt;
&lt;button type=&quot;button&quot; class=&quot;btn btn-light&quot;&gt;Light&lt;/button&gt;
&lt;button type=&quot;button&quot; class=&quot;btn btn-dark&quot;&gt;Dark&lt;/button&gt;

&lt;button type=&quot;button&quot; class=&quot;btn btn-link&quot;&gt;Link&lt;/button&gt;
</code></pre>
<p>And the following is what will display:</p>
<p><img src="ch2/image/ch2-buttons.png" alt="Figure 2.23 Buttons in Bootstrap." title=":size=70%" /></p>
<p>As long as you get used to those built-in CSS classes, you are able to create modern web pages as you wish. For example, you can use the <a href="https://getbootstrap.com/docs/5.1/components/card/">card</a> to introduce cats in HTML. And we also adapt an album example based on <em>card</em> component. The complete code can be found at <code>card.html</code> and <code>animals.html</code>, respectively, under <code>mini-mvc | src | main | webapp</code>. </p>
<pre><code class="language-html">&lt;div class=&quot;card text-white bg-secondary mb-3&quot; style=&quot;width: 18rem;&quot;&gt;
  &lt;img src=&quot;cat.png&quot; class=&quot;card-img-top&quot; alt=&quot;cat&quot;&gt;
  &lt;div class=&quot;card-body&quot;&gt;
    &lt;h5 class=&quot;card-title&quot;&gt;Cat&lt;/h5&gt;
    &lt;p class=&quot;card-text&quot;&gt;The cat is a domestic species of small carnivorous mammal.&lt;/p&gt;
    &lt;a href=&quot;#&quot; class=&quot;btn btn-primary&quot;&gt;Find more&lt;/a&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>With the help of Bootstrap, you are able to build a non-trivial web page like this easily:</p>
<p><img src="ch2/image/ch2-cats.png" alt="Figure 2.23 Cats example in Bootstrap." title=":size=70%" /></p>
<h2 id="client-side-frameworks"><a class="header" href="#client-side-frameworks">Client-side frameworks</a></h2>
<p>Now, JavaScript is an essential part of the web, used on 95% of all websites[5], and the web is an essential part of modern life. The advent of modern JavaScript frameworks has made it much easier to build highly dynamic, interactive applications. A framework is a library that offers opinions about how software gets built. </p>
<p>There are many frameworks out there, but currently the &quot;big three&quot; are considered to be the following.</p>
<ul>
<li><strong>Angular</strong>: <a href="https://angular.io/">Angular</a> is an open-source web application framework led by the Angular Team at Google and by a community of individuals and corporations.</li>
<li><strong>Vue</strong>: <a href="https://vuejs.org/">Vue</a> is an open-source model–view–viewmodel front end JavaScript framework for building user interfaces and single-page applications.</li>
<li><strong>React</strong>: <a href="https://reactjs.org/">React</a> itself is not technically a framework; it's a library for rendering UI components. React is used in combination with other libraries to make applications.</li>
</ul>
<p>Those frameworks are beyond the scope of this book. People who are interested in front-end skills can explore any of them through self-learning.</p>
<hr />
<p>[1] Input-output ratio is mainly used in material control, which indicates the relation between the quantity of material used in the production and the quantity of final output. In general, the smaller input-output ratio, the bigger benefits in a given time/cost.</p>
<p>[2] This subsection is adapted from <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS">Learn to style HTML using CSS</a>.</p>
<p>[3] Since JSP will finally output an HTML page, CSS can be also used to style JSP.</p>
<p>[4] CSS code can also be specified in the <code>style</code> attribute of the targeted element. For example, <code>&lt;h1 style=&quot;color: red; font-size: 5em;&quot;&gt;Find the book you love.&lt;/h1&gt;</code>. But this <strong>inline</strong> style is infrequent, since it would make a chaos for the HTML structure and result in troubles for maintenance. Anyway, avoid using CSS in this way, when possible.</p>
<p>[5] https://w3techs.com/technologies/details/cp-javascript</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-1"><a class="header" href="#exercise-1">Exercise</a></h1>
<p><strong>2.1</strong>. In fact, the container calls the servlet's <code>service()</code> method, rather than <code>doGet()</code> directly. Please explain the functionality of <code>service()</code>.</p>
<hr />
<p><strong>2.2</strong>. Please draw the UML class diagram for <code>HttpServletRequest</code> and <code>HttpServletResponse</code>.</p>
<hr />
<p><strong>2.3</strong>. Create a new Java Enterprise project named <code>ex2.3</code>. Then delete the annotation in <code>HelloServlet.java</code> and map this servlet to <code>/hello</code> and <code>/hi</code> in DD.</p>
<hr />
<p><strong>2.4</strong>. Based on <code>ex2.3</code>, crate a new servlet <code>MeServlet.java</code>, and output the content of your personal page in Exercise 1.2 through <code>PrinterWriter</code>.</p>
<hr />
<p><strong>2.5</strong>. Please find the appropriate API from <code>java.lang.Double</code> by searching Java Doc, which is capable of converting a string to <code>double</code> (not the boxed <code>Double</code>). </p>
<hr />
<p><strong>2.6</strong>. Please find the appropriate API from <code>java.util.Arrays</code> by searching Java Doc, which is capable of converting an array to an <code>ArrayList</code>.</p>
<hr />
<p><strong>2.7</strong>. Based on <code>ex2.3</code>, add the line</p>
<pre><code class="language-java">LocalDateTime time = LocalDateTime.now();
</code></pre>
<p>into <code>doGet()</code> method, and then output this object to the web page through <code>PrinterWriter</code>.</p>
<hr />
<p><strong>2.8</strong>. How is the <code>isEmpty()</code> method of <code>ArrayList</code> implemented? Use IntelliJ IDEA to tickle your curiosity.</p>
<hr />
<p><strong>2.9</strong>. In <code>Recommendation.java</code> of project <code>mini-mvc</code>, can we replace <code>genre.equals(&quot;novel&quot;)</code> with <code>genre == &quot;novel&quot;</code>?</p>
<hr />
<p><strong>2.10</strong>. Please refactor <code>Recommendation.java</code> by replacing <code>if</code> structure with <code>switch</code>.</p>
<hr />
<p><strong>2.11</strong>. Please add proper break line for our second version of <code>mini-mvc</code> in <code>BookServlet.java</code>. (Hint: using <code>&lt;br&gt;</code> element)</p>
<hr />
<p><strong>2.12</strong>. The second parameter's type of <code>setAttribute()</code> is <code>Object</code>. Try to explain why.</p>
<hr />
<p><strong>2.13</strong>. Please use <code>&lt;ol&gt;</code> and <code>&lt;li&gt;</code> element in <code>result.jsp</code> for our final version of <code>mini-mvc</code> to define an ordered HTML list for the recommended books.</p>
<hr />
<p><strong>2.14</strong>. Try to add <code>method=&quot;POST&quot;</code> in <code>&lt;form&gt;</code> for our final version of <code>mini-mvc</code>, and then make some corresponding changes in <code>BookServlet.java</code>.</p>
<hr />
<p><strong>2.15</strong>. Add <code>&lt;p&gt;I am a paragraph&lt;/p&gt;</code> in an HTML file, and then add two CSS rules:</p>
<pre><code class="language-css">p {
  color: red;
}

p {
  color: blue;
}
</code></pre>
<p>Which color is the <code>&lt;p&gt;</code>? We may notice there is a conflict in CSS rules, and can you draw any conclusion?</p>
<hr />
<p><strong>2.16</strong>. Add <code>&lt;p class=&quot;special&quot;&gt;What color am I?&lt;/p&gt;</code> in an HTML file, and then add two CSS rules:</p>
<pre><code class="language-css">.special {
  color: red;
}

p {
  color: blue;
}
</code></pre>
<p>Which color is the <code>&lt;p&gt;</code>? Again, there is a conflict, and can you draw any conclusion?</p>
<hr />
<p><strong>2.17</strong>. Try to stylish your personal home page in Exercise 1.2 by integrating with Bootstrap framework.</p>
<hr />
<p><strong>2.18</strong>. <a href="https://codepen.io/">CodePen</a> is an online community for testing and showcasing user-created HTML, CSS and JavaScript code snippets. Try to adapt <a href="https://codepen.io/gerozayas/pen/rNWvKez">CV Gero Zayas</a> to create your own CV.</p>
<hr />
<p><strong>2.19</strong>. Try to crate an HTML page to display the same content with <a href="http://jwc.swufe.edu.cn/jsfw.htm">Office of Academic Affairs</a> by integrating with Bootstrap framework. Note that it should contain a <a href="https://getbootstrap.com/docs/5.1/components/navbar/">Navbar</a>.</p>
<hr />
<p><strong>2.20</strong>. Read Chapter 3 <em>Mini MVC Tutorial</em> of <code>HFBook</code>, and then create a new project called <code>beer</code> to implement all code in MVC design. (Hint: the final code looks like <strong>Code for Servlet version three</strong> in page 89)</p>
<p><em>Optional</em>: you can even integrate with Bootstrap framework to beautify the web pages.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-3-in-depth-servlet"><a class="header" href="#chapter-3-in-depth-servlet">Chapter 3: In-depth Servlet</a></h1>
<p>In this chapter, we study the most important component in Java EE' web profile, servlet. As we have learned in the last chapter,</p>
<blockquote>
<p>Servlet is a Java class that is used to extend the capabilities of servers that host applications accessed by means of a request-response programming model.</p>
</blockquote>
<p>A servlet's job is to take a client's <em>request</em> and send back a <em>response</em>. The request might be simple: &quot;get me the welcome page.&quot; Or it might be complex: &quot;Complete my shopping cart check-out&quot;. It is not our intention to provide a complete users' guide for servlet usage. Rather, we focus on servlet's <em>request and response</em> in depth. Again, please make your hands dirty through extensive programming exercises.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="31-servlet-from-birth-to-death"><a class="header" href="#31-servlet-from-birth-to-death">3.1 Servlet: from Birth to Death</a></h1>
<p>In Chapter 2, we looked at the Container's overall role in a servlet's life: it creates the request and response objects, creates or allocates a new thread for the servlet, and calls the servlet's <code>service()</code> method, passing the request and response references as arguments. Please review the whole process in <a href="ch3/ch2/2.1">Section 2.1</a>. </p>
<p>Note that we previously mentioned &quot;the container calls the servlet's <code>doGet()</code>&quot;, but technically, it calls <code>service()</code> instead. </p>
<blockquote>
<p>void	service(HttpServletRequest req, HttpServletResponse resp)	
Receives standard HTTP requests from the public service method and dispatches them to the <em>doMethod</em> methods defined in this class.</p>
</blockquote>
<p>As there are several HTTP methods (e.g., GET, PUT, DELETE), <code>service()</code> can dispatch the received request to the matches <code>doXXX()</code>, and such API design provides extra flexibility.</p>
<p>In what follows, we need to investigate several questions with respect to a servlet's life:</p>
<ul>
<li><em>when was the servlet class loaded?</em> </li>
<li><em>when did the servlet's constructor run?</em></li>
<li><em>when should your servlet initialize resources?</em> </li>
<li><em>when should it clean up its resources?</em></li>
</ul>
<p>Those questions may look trivial at first, but solving them is of importance when developing some critical web applications.</p>
<h2 id="servlet-lifecycle"><a class="header" href="#servlet-lifecycle">Servlet lifecycle</a></h2>
<p>The servlet lifecycle is simple; there's only one main state: <strong>initialized</strong>. When it is <em>initialized</em>, it is able to handle requests through <code>service()</code>. If the servlet is not <em>initialized</em>, then it is either <em>being initialized</em>, <em>being destroyed</em>, or it simply <strong>does not exist</strong>.</p>
<p><img src="ch3/image/ch3-life.png" alt="Figure 3.1 Servlet lifecycle." title=":size=30%" /></p>
<blockquote>
<p>[!NOTE]
<code>init()</code> is NOT constructor. See more at <a href="https://stackoverflow.com/questions/9381356/">Why we use init() rather Constructor</a>.</p>
</blockquote>
<p>In Java, an object is usually crated through its <em>constructor</em>, such as <code>String s = new String()</code>. Then should we write a constructor for our self-defined servlet (e.g., <code>HelloServlet.java</code>)? Then answer is <em>NO</em>, because the container would use the complier supplied default constructor which is no-argument[1]. After that, the <code>init()</code> method is called to initialize some resources required by the servlet. When finished, the servlet is <em>initialized</em>, and this is where the servlet spend most of its life. Also, the container gives the servlet to clean up using <code>destroy()</code> before the servlet is killed (i.e., made ready for garbage collection).</p>
<p>Note that both <code>init()</code> and <code>destroy()</code> are called only once throughout a servlet's life. In <code>HelloServlet.java</code>, we already saw the usage of <code>init()</code>, and it simply initialized a <em>String</em> object.</p>
<pre><code class="language-java">private String message;

public void init() {
    message = &quot;Hello World!&quot;;
}
</code></pre>
<p>We can design a small test to verify that <code>init()</code> is called only once: we add an unassigned <code>int</code> member variable in a servlet, increment it by one in <code>init()</code>, and them display this variable in <code>doGet()</code>. You will notice that no matter how many times this servlet is accessed, the value of variable remains <em>1</em>. The detailed implementation leaves for an exercise.</p>
<p>So, when do we need to initialize something for a servlet? It could be a little abstract without detailed scenarios. For example, the database connection is required to query a database, and code of <em>opening</em> the connection object can be put inside <code>init()</code>. Similarly, in case of resource leak, <em>closing</em> the connection object can be in <code>destroy()</code>[2].</p>
<p>Like <code>doGet()</code> and <code>doPost()</code>, your servlet inherits those lifecycle methods from parent classes or interfaces. And Fig 3.2 shows some essential inherited methods from a bird's-eye view, and it is also a verbose version of Fig 2.4[3]. </p>
<blockquote>
<p>[!NOTE]
Do not try to memorize all fo these methods! Just get a feel for how the API works.</p>
</blockquote>
<p><img src="ch3/image/ch3-uml.png" alt="Figure 3.2 Servlet's methods." title=":size=70%" /></p>
<ul>
<li><strong>Servlet interface</strong>: It says that all servlets have these five methods, and the three in bold are lifecycle method.</li>
<li><strong>GenericServlet class</strong>: It is an abstract class where most of your servlet's &quot;servlet behavior&quot; comes from.</li>
<li><strong>HttpServlet class</strong>: It is also an abstract class implements the <code>service()</code> method to deal with HTTP related issues.</li>
</ul>
<p>Do not get depressed when you see too many inherited methods because in most (more than 99.999%) cases, you need only to override <code>doGet()</code> and/or <code>doPost()</code> for your own servlet. And this is the method responsible for your web application is supposed to do.</p>
<h2 id="servlet-and-thread"><a class="header" href="#servlet-and-thread">Servlet and thread</a></h2>
<p>Before we move on, we have to introduce the background of <code>thread</code>, an importance concept in operating systems. </p>
<blockquote>
<p>Process means any program is in execution. Thread means segment of a process.</p>
</blockquote>
<p>A single Java program, like a servlet, is a process. A thread is like a virtual CPU that can execute your Java code - inside your Java application. For example, in a downloading program, it may contain several <em>threads</em> to fetch the data from the server concurrently to achieve a higher speed. In Java, there is at least one thread, <em>main thread</em> that every Java application has.</p>
<p>To demonstrate the current execution, we design a multi-threads program in the following[4]:</p>
<pre><code class="language-java">class Servlet {
    public void service() throws InterruptedException {
        System.out.println(&quot;start to service...&quot;);
        for (int i = 0; i &lt; 10; i++) {
            System.out.println(i);
            Thread.sleep(500);
        }
        System.out.println(&quot;end of service...&quot;);
    }
}
</code></pre>
<p>The <code>Servlet</code> class is used to mimic a servlet, and it has a <code>service()</code> method to output values from 1 to 10. Note the <code>Thread.sleep(500)</code> is used to cause the currently executing thread to sleep for 500 milliseconds, and this is to mimic a consuming task in a servlet.</p>
<pre><code class="language-java">class Container implements Runnable {
    private final Servlet servlet;
    public Container() {
        servlet = new Servlet();
    }
    @Override
    public void run() {
        try {
            servlet.service();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>The <code>Container</code> class is used to mimic the container, and for simplicity, we add a <code>Servlet</code> as its member variable. <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Runnable.html">Runnable</a> is an interface that is to be implemented by a class whose instances are intended to be executed by a thread. When an object implementing interface <code>Runnable</code> is used to create a thread, starting the thread causes the object's <code>run()</code> method to be called in that separately executing thread.</p>
<pre><code class="language-java">public class Main {
    public static void main(String[] args) {
        Container container = new Container();
        Thread t1 = new Thread(container);
        Thread t2 = new Thread(container);
        t1.start();
        t2.start();
    }
}
</code></pre>
<p>In the <code>main()</code> method, we firstly crate a <code>Container</code> instance, and therefore, a <code>Servlet</code> instance, and then start two threads to <code>service()</code>. As you expected, the output from 1 to 10 of the two threads are concurrently executed. It is worthwhile to observe the output on your own, and it is left as an exercise for the reader.</p>
<p>Now it is time for <em>REAL</em> servlets: suppose <code>HelloServlet</code> is accessed by two people at the same time, then how many <code>HelloServlet</code> instances are there in the server? Will the container create <em>TWO</em> servlet objects? In general, there are not multiple instances of any servlet. If so, how can the container guarantee that the two requests won't affect each other? For example, in the book-selling website, there is a <code>Checkout</code> servlet. The system shall make sure that Bob won't pay for what Alice bought.</p>
<p>To achieve this goal, <strong>the container runs multiple threads to process multiple requests to a single servlet</strong>. Therefore, every client request generates a new pair of request and response objects, and they shall not affect each other.</p>
<p><img src="ch3/image/ch3-thread.png" alt="Figure 3.3 Servlet and thread." title=":size=70%" /></p>
<hr />
<p>[1] Technically, the container would load the class (i.e., <em>bytecode</em>) of the servlet at the run time, and then use the technology called <em>reflection</em> to find and call its no-argument constructor.</p>
<p>[2] Don't worry if you have some troubles in understanding this example, and we will illustrate it using real code in the later of this book.</p>
<p>[3] Some readers may cannot get the point why interfaces and abstract classes are introduced here. It is a matter of design choice, and such <em>interface</em>-first design is very common is object oriented programming.</p>
<p>[4] Note that the code here is only used to demonstrate the usage of <em>thread</em>, and it is <em>NOT</em> how the container is implemented.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="32-request-and-response"><a class="header" href="#32-request-and-response">3.2 Request And Response</a></h1>
<p>In the last section, we studied the lifecycle of a servlet. But a servler's real job is to handle requests. That is when a servlet's life has meaning. In the mini MVC project, we can send an HTTP request to a servlet, and then the servlet is able to get parameters from the request, and finally make a response. In this section, we look at the fundamentals of the request and response again.</p>
<h2 id="api-revisited"><a class="header" href="#api-revisited">API revisited</a></h2>
<p>As we can see, <em>request</em> and <em>response</em> are the arguments to <code>service()</code>[1], and they are the key to everything in daily programming.</p>
<pre><code class="language-java">protected void service(HttpServletRequest req, HttpServletResponse resp)
</code></pre>
<p>In Exercise 2.2, you are asked to draw UML for <code>HttpServletRequest</code> and <code>HttpServletResponse</code>, and the following is the answer:</p>
<p><img src="ch3/image/ch3-req_res_uml.png" alt="Figure 3.3 Request and response UML" title=":size=80%" /></p>
<p>The <code>HttpServletRequest</code> and <code>HttpServletResponse</code> methods are about HTTP things like <em>cookies</em>, <em>headers</em> and <em>sessions</em>. Again, you don't have to memorize these APIs. Note that both <code>HttpServletRequest</code> and <code>HttpServletResponse</code> are also interfaces. Are there concrete classes there in the API? The answer is no because they are left to the vendor (e.g., <code>Tomcat</code>, <code>GlassFish</code>) to implement. The good news is that you don't worry about it; you should never care about the actual implementation class name or type[2].</p>
<h2 id="http-methods"><a class="header" href="#http-methods">HTTP methods</a></h2>
<p>Another key point is to understand HTTP methods, which we have studied in <a href="ch3/ch1/1.4">Section 1.4</a>. In the real servlet world, you only care about <em>GET</em> and <em>POST</em>. And in what follows, we revisit the two HTTP methods using <code>mini-mvc</code>, and suppose we always select <em>novel</em>.</p>
<blockquote>
<p>[!TIP]
Open the <code>Network</code> tab to inspect the HTTP related information.</p>
</blockquote>
<p>By default, a form's method is <em>GET</em>, so we can notice the sent parameters is found in the URL by appending a query string <code>?books=novel</code>. In general, <em>GET</em> is idempotent[3]; you can refresh the web browser safely, because an identical idempotent request can be made once or several times in a row with the same effect.</p>
<p>The query string, <strong>starting with a question mark <code>?</code>, is make of parameters in the form of <em>name=value</em></strong>. What about parameters more than one? We add another input element in <code>ch3/request</code>.</p>
<pre><code class="language-html">&lt;form action=&quot;book&quot;&gt;
    &lt;label for=&quot;age&quot;&gt;Input your age:&lt;/label&gt;
    &lt;input type=&quot;text&quot; id=&quot;age&quot; name=&quot;age&quot;&gt;
    &lt;br&gt;&lt;br&gt;
    &lt;label for=&quot;books&quot;&gt;Choose a genre:&lt;/label&gt;
    &lt;select name=&quot;books&quot; id=&quot;books&quot;&gt;
        &lt;option value=&quot;novel&quot;&gt;novel&lt;/option&gt;
        &lt;option value=&quot;history&quot;&gt;history&lt;/option&gt;
        &lt;option value=&quot;math&quot;&gt;math&lt;/option&gt;
        &lt;option value=&quot;programming&quot;&gt;programming&lt;/option&gt;
    &lt;/select&gt;
    &lt;br&gt;&lt;br&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Submit&quot;&gt;
&lt;/form&gt;
</code></pre>
<p>Suppose we input <em>9</em>, the query string becomes <code>?age=9&amp;books=novel</code>. As we can see, <strong>multiple query parameters are separated by the ampersand <code>&amp;</code></strong>.</p>
<p>By contrast, if the form's method is set to <em>POST</em>, as in Exercise 2.14, then the parameters(or <em>payload</em>) is invisible in the URL. Rather, they are wrapped in the message body. So, <em>POST</em> is preferred due to its security when you would like to send parameters like passwords. Fig 3.4 shows an anatomy of an HTTP POST request sending from <code>chp3 | request | ... | index_post.html</code>. Another difference between them is that <em>POST</em> can send larger size of parameter. Besides, when you would like to send <em>non-text</em> data, such as an image, <em>POST</em> is the only choice. </p>
<p><img src="ch3/image/ch3-post.png" alt="Figure 3.4 Anatomy of an HTTP POST request." title=":size=80%" /></p>
<p>Remember, there is another crucial difference between <em>GET</em> and <em>POST</em> in terms of semantics: <strong>the way they are supposed to be used</strong>. <em>GET</em> is meant to be used for <em>getting</em> things. Sure, you might use parameters to help figure out what to send back, but the point is that you are not making any changes on the server[4]! As for <em>POST</em>, it would <em>change something on the server</em>[5].</p>
<p>When it comes to <em>idempotency</em>, <em>POST</em> is non-idempotent. Try to refresh the page after submitting a <code>POST</code> form <code>index_post.html</code>, and the web browser would show you a warning because repeating the same <em>POST</em> request can be dangerous sometimes. For example, when you purchase a book on the website, the payment action, say <code>Checkout</code> servlet, shall update the state of the server, including adding a record in order, decreasing the book's stock, and decreasing your account balance, so it should be <em>POST</em>. What if you refresh the page after payment? Will it duplicate the transaction? Will it cost you twice of the money? Anyway, <code>POST</code> has side effect, so you have to be careful with your <code>doPost()</code> functionality[6].</p>
<p><img src="ch3/image/ch3-post_warn.png" alt="Figure 3.5 Post is non-idempotent." title=":size=50%" /></p>
<h2 id="in-depth-parameter1"><a class="header" href="#in-depth-parameter1">In-depth parameter(1)</a></h2>
<p>In the last subsection, we discussed the difference between <em>GET</em> and <em>POST</em>. But the code is nearly the same when it comes to coding. Now let's revisit <code>getParameter()</code>.</p>
<blockquote>
<p>String	getParameter(String name)	
Returns the value of a request parameter as a String, or null if the parameter does not exist.</p>
</blockquote>
<p>Some students may ask: why does it always return <code>String</code> object? Well, it is a design choice. Application protocols, like HTTP, are human readable, as we can see in Fig 1.15 and 3.4. So representing them in <em>text</em> (i.e., <code>String</code> in Java) is reasonable. Then, what if the intended parameter is not <code>String</code>? Programmers can convert it to any desired data type according to the application logic. For example, in <code>ch3 | request</code>, the age shall be <code>int</code>,</p>
<pre><code class="language-java">int age = Integer.parseInt(request.getParameter(&quot;age&quot;));
</code></pre>
<p>Note that the code above may throw exceptions:</p>
<ul>
<li><strong>Case 1</strong>: the name <code>&quot;age&quot;</code> does not exist.</li>
<li><strong>Case 2</strong>: the value of <code>&quot;age&quot;</code> cannot be converted to <code>int</code>. For example, <em>&quot;abc&quot;</em>, <em>&quot;3.14&quot;</em>.</li>
</ul>
<p>Therefore, to make sure the application is robust, programmers need to consider such edge cases in case of evil and careless users. In <code>ch3 | request | ... | index.html</code>,</p>
<pre><code class="language-html">&lt;input type=&quot;text&quot; id=&quot;age&quot; name=&quot;age&quot;&gt;
</code></pre>
<p>But what if the user forget to input? Or input &quot;abc&quot;? Generally speaking, there are two ways to prohibit something bad happening: front-end (client-side) and back-end (server-side). </p>
<h3 id="front-end-checking"><a class="header" href="#front-end-checking">Front-end checking</a></h3>
<p>Front-end mainly relies on JavaScript. And modern HTML also provides specific input elements to alleviate such problem.</p>
<pre><code class="language-html">&lt;input type=&quot;number&quot; id=&quot;age&quot; name=&quot;age&quot;&gt;
</code></pre>
<p>This input element forces us to input a number. But what if the user input <em>-1</em> or <em>200</em>? Clearly, the age cannot be less than 1 or greater than 150[7]. We can add more restriction:</p>
<pre><code class="language-html">&lt;input type=&quot;number&quot; id=&quot;age&quot; name=&quot;age&quot; min=&quot;1&quot; max=&quot;150&quot;&gt;
</code></pre>
<p>So far so good, but what if the user forget to input? Then the parameter age would be an empty, and the query string is <code>?age=&amp;book=novel</code>. Luckily, HTML can add <em>required</em> restriction for an input element:</p>
<pre><code class="language-html">&lt;input type=&quot;number&quot; id=&quot;age&quot; name=&quot;age&quot; min=&quot;1&quot; max=&quot;150&quot; required&gt;
</code></pre>
<p>Then it will prevent you submitting the form with empty values[8].</p>
<p><img src="ch3/image/ch3-required.png" alt="Figure 3.6 Required in input elements." title=":size=40%" /></p>
<p>It seems that everything goes well. But unfortunately, <strong>front-end checking methods can only prevent careless people, not evil guys</strong>. For example, people can issue an request by the URL directly, and skip the check of the web browser. Therefore, we need also ask the back-end for help.</p>
<h3 id="back-end-checking"><a class="header" href="#back-end-checking">Back-end checking</a></h3>
<p>Let's inspect the two cases mentioned above:</p>
<ul>
<li><strong>Case 1</strong>: the name <code>&quot;age&quot;</code> does not exist.
In this case, <code>getParameter()</code> would return <code>null</code>.</li>
</ul>
<pre><code class="language-java">int age;
if (request.getParameter(&quot;age&quot;) != null) {
    age = Integer.parseInt(request.getParameter(&quot;age&quot;));
    // normal logic
} else {
    // handling error
}
</code></pre>
<p>It is up to the developers to decide how to handle the detected error. For example, <em>forward</em> this request to another error page:</p>
<pre><code class="language-java">request.getRequestDispatcher(&quot;error.html&quot;).forward(request, response);
</code></pre>
<ul>
<li><strong>Case 2</strong>: the value of <code>&quot;age&quot;</code> cannot be converted to <code>int</code>.
It is apparently that converting from strings like <code>&quot;abc&quot;</code>, <code>&quot;3.14&quot;</code> would result in an error (or <em>exception</em> in Java). To determine the exact type of <em>error</em>, you can use the skill introduced in <a href="ch3/ch2/2.2">Section 2.2</a>. The following is method signature of <code>parseInt()</code>.</li>
</ul>
<pre><code class="language-java">public static int parseInt​(String s) throws NumberFormatException
</code></pre>
<p>We can use the <code>try...catch</code> structure to capture the exception inside <code>if</code>:</p>
<pre><code class="language-java">try {
    age = Integer.parseInt(request.getParameter(&quot;age&quot;));
    // normal logic
} catch (NumberFormatException e) {
    // handling error
}
</code></pre>
<p>Note that since <code>parseInt()</code> would also throw <code>NumberFormatException</code> when its argument is <code>null</code>, so we can simplify the code by removing the <code>if</code> check.</p>
<h3 id="a-final-note-for-error-checking"><a class="header" href="#a-final-note-for-error-checking">A final note for error checking</a></h3>
<p>Front-end and back-end methods for error checking cannot replace each other. For a robust system, the two methods are indispensable. We recommend at least using client-side validation. In general, the front-end is mainly used to warn users before they do something wrong, while the back-end is mainly used to prevent the system being malfunction after users did something wrong.</p>
<hr />
<p>[1] As we have seen, they are also the arguments to <code>doXXX()</code> method, such as <code>doGet()</code> and <code>doPost()</code>.</p>
<p>[2] The containers/servers provides objects that implement those interfaces as long as it is <em>Java EE compliant</em>. And this is also the benefit of interface oriented design.</p>
<p>[3] <a href="https://developer.mozilla.org/en-US/docs/Glossary/Idempotent">Idempotency</a> means that multiple identical requests will have the same outcome.</p>
<p>[4] Of course, no one forbids you changing the server using <em>GET</em>, but it is not encouraged to break its <em>getting</em> convention.</p>
<p>[5] Again, of course, no one forbids you using <em>POST</em> like a <em>GET</em> to simply send something back, but it is not encouraged to break its <em>updating</em> convention.</p>
<p>[6] It is the responsibility of programmers to decide how to handle re-submitting <code>POST</code> requests.</p>
<p>[7] According to <a href="https://en.wikipedia.org/wiki/Oldest_people">oldest people - Wikipedia</a>, the oldest people alive is 122 years old, as of the time of writing (January, 2022).</p>
<p>[8] Depending on your browser and OS, you’ll see a slightly different style of feedback.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="33-more-about-request"><a class="header" href="#33-more-about-request">3.3 More About Request</a></h1>
<p>In this section, we continue studying more about <em>request</em> using a question-oriented method. To be specific,</p>
<ul>
<li>how to handle multi values with one name in a request?</li>
<li>how to handle non-latin characters?</li>
<li>what else can I get from a <em>request</em> object?</li>
</ul>
<h2 id="in-depth-parameter2"><a class="header" href="#in-depth-parameter2">In-depth parameter(2)</a></h2>
<p>No matter what the HTTP method is, the query parameters in a request are started with a question mask <code>?</code>, and separated by the ampersand <code>&amp;</code>. So, how to handle multi values with one name in a request? It is mainly found in <code>checkbox</code>. Checkboxes let a user select zero or more options of a limited number of choices; while <code>select</code> only allows a user select zero or one option.</p>
<pre><code class="language-html">&lt;input type=&quot;checkbox&quot; id=&quot;read1&quot; name=&quot;read&quot; value=&quot;PC&quot;&gt;
&lt;label for=&quot;read1&quot;&gt;PC&lt;/label&gt;&lt;br&gt;
&lt;input type=&quot;checkbox&quot; id=&quot;read2&quot; name=&quot;read&quot; value=&quot;Kindle&quot;&gt;
&lt;label for=&quot;read2&quot;&gt;Kindle&lt;/label&gt;&lt;br&gt;
&lt;input type=&quot;checkbox&quot; id=&quot;read3&quot; name=&quot;read&quot; value=&quot;paper&quot;&gt;
&lt;label for=&quot;read3&quot;&gt;paper&lt;/label&gt;&lt;br&gt;
&lt;input type=&quot;checkbox&quot; id=&quot;read4&quot; name=&quot;read&quot; value=&quot;phone&quot;&gt;
&lt;label for=&quot;read4&quot;&gt;Phone&lt;/label&gt;&lt;br&gt;
</code></pre>
<p>Note that <code>name</code> with <em>&quot;read&quot;</em> is repeated for 4 times. If both <em>PC</em> and <em>Kindle</em> are selected, then the query string would contain <code>read=PC&amp;read=Kindle</code>. So how can we get those values in a servlet? Instead using <code>getParameter()</code>, we should use <code>getParameterValues()</code>:</p>
<blockquote>
<p>String[]	getParameterValues(String name)	
Returns an array of String objects containing all of the values the given request parameter has, or null if the parameter does not exist.</p>
</blockquote>
<pre><code class="language-java">String[] reads = request.getParameterValues(&quot;read&quot;);
</code></pre>
<h2 id="in-depth-parameter3"><a class="header" href="#in-depth-parameter3">In-depth parameter(3)</a></h2>
<p>Till now, we only use English in the web applications. But in the real world, we would like a international website which can be accessed by people using different languages all over the world[1]. It is not trivial problem, because garbled characters are very common in real systems if <em>i18n</em> is not well considered. For example, there are many legacy pages from <a href="https://docs.oracle.com/cd/E19199-01/817-4244-10/overview.html">Oracle</a> which are full of garbled characters, such as <em>&quot;锟斤拷&quot;</em>. We bet no one can interpret the meaning of <em>锟斤拷</em>:</p>
<p><img src="ch3/image/ch3-oracle.png" alt="Figure 3.7 Garbled characters." title=":size=60%" /></p>
<p>In this subsection, let's investigate this problem. </p>
<p>First of all, we design a small test to reproduce this problem in <code>utf8.html</code> of <code>ch3/request</code>:</p>
<pre><code class="language-html">&lt;form action=&quot;international&quot; method=&quot;post&quot;&gt;
    &lt;label for=&quot;name&quot;&gt;Name: &lt;/label&gt;
    &lt;input type=&quot;text&quot; name=&quot;name&quot; id=&quot;name&quot;&gt;
    &lt;button type=&quot;submit&quot;&gt;Login in&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>And in <code>InternationalServlet.java</code> whose URL name is <code>/international</code> we try to output the <em>name</em>:</p>
<pre><code class="language-java">response.setContentType(&quot;text/html&quot;);
PrintWriter out = response.getWriter();
String name = request.getParameter(&quot;name&quot;);
out.println(name);
</code></pre>
<p>If we input <em>Bob</em> in the input box, the output is <em>Box</em>, as we expected; but if we input <em>小明</em> in the input box, the output is <em>å°æ˜Ž</em>. WTF?</p>
<blockquote>
<p>[!TIP]
<strong>TL;DR</strong> There are different character set encodings, and it may produce garbled characters when converting one to another. Modern applications should use <em>UTF-8</em> if you don't have special reasons to use alternatives.</p>
</blockquote>
<p>To understand this, you need know the background knowledge about <strong>how a string is represented</strong>. Essentially, <code>String</code>, as well as other objects, are a sequences of <em>bytes</em>[2]. Given a sequence of bytes, how to interpret it depends on the <em>character encoding</em>. To be precise, character encoding is the process of assigning numbers to graphical characters, especially the written characters of human language, allowing them to be stored, transmitted, and transformed using digital computers. And the character set used in encoding/decoding is usually abbreviated as <em>charset</em>.</p>
<p>As an analogy, let's take an double entendre in English as an example: &quot;What's the longest sentence in the world?&quot; &quot;Life sentence.&quot; Here, <em>sentence</em> can be 1) a set of words that is complete in itself; or 2) the punishment assigned to a defendant found guilty by a court. Anyway, <strong>the same data can convey different meanings in different interpretations</strong>.</p>
<p>There are a larger number of <a href="https://en.wikipedia.org/wiki/Character_encoding">character encodings</a>. For example:</p>
<ul>
<li>ASCII: for English [3]</li>
<li>UTF-8: for Unicode</li>
<li>ISO 8859: for Europe</li>
<li>GB 2312: for Chinese</li>
<li>...</li>
</ul>
<p>UTF-8 is by far the most common encoding for the World Wide Web, accounting for 98% of all web pages, and up to 100.0% for some languages, as of 2021[4]. So, please use UTF-8 encoding in your applications if possible. ISO 8859-1 is in the family of ISO-8859, which is used to encode western Europe languages, and it is the one what Tomcat is using. The following is what happens behind the scene.</p>
<ul>
<li>The parameters is encoded in <em>UTF-8</em> by the web browser, and sent to the server.</li>
<li>Tomcat decodes the parameters in <em>ISO 8859-1</em>. Note that IOS 8859-1 can be only used to store western Europe characters.</li>
<li>Tomcat sends this value as response in <em>ISO 8859-1</em> encoding.</li>
</ul>
<p>We can notice the response encoding in <code>Network</code> tab:</p>
<p><img src="ch3/image/ch3-response-encoding.png" alt="Figure 3.8 HTTP response encoding." title=":size=70%" /></p>
<p>Therefore, you cannot pass the parameters in Chinese (e.g., <em>你好</em>) or Japanese (e.g., <em>こんにちわ</em>). </p>
<p>How to solve this problem? One solution is to specify the <em>UTF-8</em> charset for both request and response. Note that the case is insensitive.</p>
<pre><code class="language-java">request.setCharacterEncoding(&quot;utf-8&quot;);
response.setContentType(&quot;text/html;charset=utf-8&quot;);
</code></pre>
<p>Alternatively, you can specify the response's encoding separately:</p>
<pre><code class="language-java">request.setCharacterEncoding(&quot;utf-8&quot;);
response.setCharacterEncoding(&quot;utf-8&quot;);
response.setContentType(&quot;text/html&quot;);
</code></pre>
<p>The code above works for <code>POST</code>. But as for <code>GET</code>, it does not make sense to set charset for <em>request</em>,</p>
<blockquote>
<p>void	setCharacterEncoding(String env)	
Overrides the name of the character encoding used in the body of this request.</p>
</blockquote>
<p>Recall the the parameters of <code>POST</code> are wrapped in the request body, while the parameters of <code>GET</code> is appended in the URL directly. Therefore, when it comes to <code>GET</code>, specifying the encoding for the response is enough:</p>
<pre><code class="language-java">response.setContentType(&quot;text/html;charset=utf-8&quot;);
</code></pre>
<p>By the way, as for <code>POST</code>, another solution is to encode nd decode manually without specifying the charset of <em>request</em>:</p>
<pre><code class="language-java">String temp = request.getParameter(&quot;name&quot;);
String name = new String(tmp.getBytes(StandardCharsets.ISO_8859_1), StandardCharsets.UTF_8);
</code></pre>
<p><img src="ch3/image/ch3-utf8.png" alt="Figure 3.9 Encoding and decoding." title=":size=70%" /></p>
<p>In <code>utf8-2.html</code>, we send a parameter in Chinese to a servlet via <em>POST</em>, and then the servlet forwards this request to a JSP, like we did in the mini MVC project. To encode/decode correctly, the code is similar. Note that we don't need to set charset for response now, because the encoding of <code>result.jsp</code> has been specified to the UTF-8:</p>
<pre><code class="language-jsp">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
</code></pre>
<h2 id="beyond-parameters"><a class="header" href="#beyond-parameters">Beyond parameters</a></h2>
<p>The <code>ServletRequest</code> and <code>HttpServletRequest</code> interfaces have a ton of methods you can call, but you don’t need to memorize them all. On your own, you really should look at the full API for <code>javax.servlet.ServletRequest</code> and <code>javax.servlet.http.HttpServletRequest</code>, but here we’ll look at only the methods you’re most likely to use in your work.</p>
<p><strong>Don't worry if you are not clear about how or why you'd use each of these</strong>; we'll see more details on some of them (especially <em>cookies</em> and <em>session</em>) later in the book.</p>
<h3 id="the-clients-platform-and-browser-info"><a class="header" href="#the-clients-platform-and-browser-info">The client's platform and browser info</a></h3>
<p>As we can see in Fig 1.15 and 3.4, a large number of information, in the form of <code>&lt;name&gt;: &lt;value&gt;</code>, contained in the <em>request header</em>, and then we can use <code>getHeader()</code> to extract targeted one:</p>
<blockquote>
<p>String	getHeader(String name)	
Returns the value of the specified request header as a String.</p>
</blockquote>
<p>A user agent is a computer program representing a person, for example, a browser in a Web context. The <code>User-Agent</code> request header is a characteristic string that lets servers and network peers identify the application, operating system, vendor, and/or version of the requesting <em>user agent</em>[5]. The <em>user agent</em> string of my web browser indicates I am using MacOS and Edge:</p>
<blockquote>
<p>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36 Edg/96.0.1054.62</p>
</blockquote>
<p>And it can be obtained in a servlet:</p>
<pre><code class="language-java">String agent = request.getHeader(&quot;User-Agent&quot;);
</code></pre>
<h3 id="the-cookies-associated-with-this-request"><a class="header" href="#the-cookies-associated-with-this-request">The cookies associated with this request</a></h3>
<pre><code class="language-java">Cookie[] cookies = request.getCookies();
</code></pre>
<h3 id="the-session-associated-with-this-request"><a class="header" href="#the-session-associated-with-this-request">The session associated with this request</a></h3>
<pre><code class="language-java">HttpSession session = request.getSession();
</code></pre>
<h3 id="the-http-method-of-this-request"><a class="header" href="#the-http-method-of-this-request">The HTTP method of this request</a></h3>
<pre><code class="language-java">String method = request.getMethod();
</code></pre>
<hr />
<p>[1] It is often called <em>i18n</em>, short for internationalization and localization. Internationalization is the process of designing a software application so that it can be adapted to various languages and regions without engineering changes. Localization is the process of adapting internationalized software for a specific region or language by translating text and adding locale-specific components.</p>
<p>[2] A byte is a unit of measurement of the size of information on a computer or other electronic device. A single byte is usually eight bits.</p>
<p>[3] Here we mean <a href="https://en.wikipedia.org/wiki/ASCII">US-ASCII</a>.</p>
<p>[4] https://en.wikipedia.org/wiki/UTF-8</p>
<p>[5] https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="34-upload-files-in-servlets"><a class="header" href="#34-upload-files-in-servlets">3.4 Upload Files In Servlets</a></h1>
<p>Unlike previous sections, in this section, we only focus on a single problem when developing a web application: <strong>how to upload files in servlets</strong>?</p>
<p>Uploading files in a common requirement. For example, you might upload an avatar when signing up in a social website; when adding a book in the book-selling website, the admin may asked to upload the book's cover; users can upload videos to the stream medias such as YouTube, and BiliBili.</p>
<h2 id="front-end"><a class="header" href="#front-end">Front-end</a></h2>
<p>In order to upload files, there are some worth-noting configurations in the <code>&lt;form&gt;</code>.</p>
<pre><code class="language-html">&lt;form action=&quot;upload&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;label for=&quot;file&quot;&gt;Choose a file: &lt;/label&gt;
    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Upload&quot;&gt;
&lt;/form&gt;
</code></pre>
<ul>
<li>The <em>method</em> attribute must be <code>POST</code>.</li>
<li>The <em>enctype</em> attribute must be <code>multipart/form-data</code>.</li>
<li>An input element with <em>type=&quot;file&quot;</em> to choose a file.</li>
</ul>
<p>The first and third requirements are intuitive, and we need to explain the second point. Firstly, let's think about another question: what is the default <em>enctype</em> value? Well, <em>enctype</em> means encoding type, and HTML forms provide three methods of encoding: 1) <code>application/x-www-form-urlencoded</code> (the default); 2) <code>multipart/form-data</code>; 3) <code>text/plain</code>[1].</p>
<blockquote>
<p>[!NOTE]
<strong>TL;DR</strong> The <em>enctype</em> attribute must be <code>multipart/form-data</code> in <code>&lt;form&gt;</code> if you would like to upload files.</p>
</blockquote>
<p>To satisfy your curiosity, let's investigate what encoding exactly is through a small test:</p>
<ul>
<li>Try to input <em>&quot;Chen=&quot;</em> in <code>utf-8.html</code> of <code>ch3/request</code>, and inspect the payload in <code>Network</code> tab for <em>POST</em>, or inspect the URL for <em>GET</em>. Interestingly, you would find that the data sent is <em>Chen%3D</em>, rather than <em>Chen=</em>. </li>
<li>Try to input <em>&quot;Zhongpu Chen&quot;</em> in <code>utf8.html</code> of <code>ch3/request</code>. Similarly, you would find that the data sent is <em>Zhongpu+Chen</em>, rather than <em>Zhongpu Chen</em>[2].</li>
</ul>
<p>This is caused by <a href="https://en.wikipedia.org/wiki/Percent-encoding">URL Encoding</a>. For example, since <em>=</em> has special meaning in URL, we have to encode or escape it to avoid confusion. Back to uploading files, we need also some special <em>encoding</em> algorithms. For regular parameters, they are separated by the ampersand <code>&amp;</code>, while <code>multipart/form-data</code> needs to add a special boundary so that the server has to distinguish between text data and binary data[3].</p>
<h2 id="back-end"><a class="header" href="#back-end">Back-end</a></h2>
<p>Before Servlet 3.0, writing code to receive uploaded files is a bit complicated. But now, we can use <code>MultipartConfig</code> annotation to reduce the workload[4].</p>
<pre><code class="language-java">@MultipartConfig
public class UploadServlet extends HttpServlet 
</code></pre>
<p>Apparently, the uploaded file is not a string, so we need a new method:</p>
<blockquote>
<p>Part	getPart(String name)	
Gets the named Part or null if the Part does not exist.</p>
</blockquote>
<p>Here, <code>javax.servlet.http.Part</code> represents a part or form item that was received within a <code>multipart/form-data</code> POST request. So anything we want to do for the uploaded file should rely on <em>Part</em>'s API. In some cases, we may simply store this uploaded file to a folder in the server. In what follows, we will illustrate how to finish this task. Remember, <strong>the code itself is not really important, and what you need to do is to practice how to expand your knowledge by <em>searching</em></strong>, as we mentioned in <a href="ch3/ch2/2.2">Section 2.2</a>.</p>
<p>First of all, we can write pseudo code for this task:</p>
<pre><code>s &lt;- get the name of this uploaded file;
save this file to the server to name s;
</code></pre>
<p>Pretty clear, right? Let's try to convert the pseudo code into real Java code. For the first sub-task, we need to get the name of the submitted file. After a quick check of the API documentation of <code>Part</code>, we can find a proper method:</p>
<blockquote>
<p>getSubmittedFileName()	
If this part represents an uploaded file, gets the file name submitted in the upload.</p>
</blockquote>
<pre><code class="language-java">Part part = request.getPart(&quot;file&quot;);
String fileName = part.getSubmittedFileName();
</code></pre>
<p>You can print this variable to either the web page or standard out, but we recommend using <em>debug</em> in IntelliJ IDEA[5].</p>
<p>The next subtask can be solved by its another method:</p>
<blockquote>
<p>InputStream	getInputStream()	
Obtain an InputStream that can be used to retrieve the contents of the file.</p>
</blockquote>
<p><em>Stream</em> is a common abstraction for files, I/O, and networking. If you are familiar with Java I/O, implementing the rest of code is trivial. The following is a sample code[6]:</p>
<pre><code class="language-java">InputStream is = part.getInputStream();
Path path = Path.of(&quot;/Users/zhongpu/Desktop/&quot; + fileName);
Files.copy(is, path);
</code></pre>
<p>It writes (copies) the <code>InputStream</code> to a file in the server's Desktop and the path is in Solaris syntax used by MacOS/Linux. If you are using Windows, please place it in Windows syntax, such as <em>C:\\Users\\zhongpu\\Desktop</em>.</p>
<p>Note that in reality, reusing the submitted file name is not very useful, because different people may upload different files with the same name. To solve this problem, we have to make sure that the file's name is unique while the suffix/extension name (e.g., <code>.txt</code>, <code>.png</code>) is kept. The code to get the suffix name is left as an exercise for readers. And the unique name can be generated by <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/UUID.html">UUID</a>:</p>
<pre><code class="language-java">String uuid = UUID.randomUUID().toString();
</code></pre>
<h2 id="front-end-2"><a class="header" href="#front-end-2">Front-end (2)</a></h2>
<p>In our previous sample code, we can upload <em>any</em> file to the server. But in the real world, we might restrict the file type by its extension. For example, a journal report system may only allow <em>.doc</em> and <em>.docx</em> files. We can achieve this by the following code:</p>
<pre><code class="language-html">&lt;input type=&quot;file&quot; accept=&quot;.doc,.docx&quot;&gt;
</code></pre>
<p>The <code>accept</code> attribute value is a string that defines the file types the file input should accept. This string is a comma-separated list of <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file#unique_file_type_specifiers">unique file type specifiers</a>. Because a given file type may be identified in more than one manner, it's useful to provide a thorough set of type specifiers when you need files of a given format.</p>
<p>For instance, there are a number of ways Microsoft Word files can be identified, so a site that accepts Word files might use an <code>&lt;input&gt;</code> like this:</p>
<pre><code class="language-html">&lt;input type=&quot;file&quot; accept=&quot;.doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;&gt;
</code></pre>
<p>Again, like <code>required</code>, HTML backed restrictions can be bypassed by evil guys, so back-end programers shall take the responsibility to check it again. And this is also left as an exercise for readers.</p>
<hr />
<p>[1] Never use <code>text/plain</code> in any case. More discussions can be found at <a href="https://stackoverflow.com/questions/4526273">What does enctype='multipart/form-data' mean?</a>.</p>
<p>[2] In some browsers, space can be encoded as <em>%20</em>, rather than <em>+</em>.</p>
<p>[3] The detailed multipart/form-data encoding algorithm can be found <a href="https://html.spec.whatwg.org/multipage/form-control-infrastructure.html#multipart-form-data">here</a>.</p>
<p>[4] Any annotation can be replaced by XML settings in DD, and <code>@MultipartConfig</code> is not the exception.</p>
<p>[5] If you don't know what <em>debug</em> is, please refer to <a href="https://www.jetbrains.com/help/idea/debugging-your-first-java-application.html#what-is-debugging">Tutorial: Debug your first Java application</a>. And debugging web application is the similar.</p>
<p>[6] Please set the project language level to <em>11</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="35-more-about-response-1"><a class="header" href="#35-more-about-response-1">3.5 More About Response (1)</a></h1>
<p>Previously, we either make a <code>text/html</code> response or forward the request to another resource. In this section, we will focus on <em>response</em>, and try to return something different.</p>
<h2 id="json-as-response"><a class="header" href="#json-as-response">JSON as response</a></h2>
<p>JSON, short for JavaScript Object Notation, is a lightweight data-interchange format, and it is &quot;self-describing&quot; and easy to understand. For example, the JSON String <code>{&quot;name&quot;:&quot;John&quot;, &quot;age&quot;:30}</code> defines an object with 2 properties, and each property has a value. JSON is widely used in the Internet, and a large number of web APIs returns JSON as their response.</p>
<p>The complete code can be found at <code>JsonServlet.java</code> in <code>ch3/response</code>. Similar to <code>text/html</code>, <code>application/json</code> is another MIME type to indicate it is JSON. The <em>content type</em> is to tell the client (e.g., browser) what you are sending back, so the browser can <strong>do the right thing</strong>. Note that we have to escape <em>&quot;</em> within a string.</p>
<pre><code class="language-java">response.setContentType(&quot;application/json&quot;);
PrintWriter out = response.getWriter();
String json = &quot;{\&quot;name\&quot;:\&quot;John\&quot;, \&quot;age\&quot;:30}&quot;;
out.println(json);
</code></pre>
<p>Outputting JSON string directly is infrequent. Rather, in real word, we mainly need to convert an object to JSON. For example, in the mini MVC project, there is a model for books recommendation, and it would be better to design a class to represent a book.</p>
<pre><code class="language-java">public class Book {
    private String title;
    private float price;
    private String author;

    public Book(String title, float price, String author) {
        this.title = title;
        this.price = price;
        this.author = author;
    }
    // getter/setter are omitted.
}
</code></pre>
<p>How can we convert a <code>Book</code> object to JSON? We often call the converting encoding/decoding. Unfortunately, neither Java SE nor Java EE provide built-in support for JSON processing. Should we write the encoding/decoding code on our own? No. Don't try to reinvent wheels. There are several awesome JSON libraries (e.g., <em>Gson</em>, <em>Jackson</em>) in the community. In this book, we use <code>Gson</code> to serialize and deserialize Java objects to JSON[1].</p>
<pre><code class="language-groovy">implementation 'com.google.code.gson:gson:2.8.9'
</code></pre>
<p>The complete code for serialization a <code>Book</code> can be found in <code>Json2Servlet.java</code> of <code>ch3/response</code>:</p>
<pre><code class="language-java">Book book = new Book(&quot;Gone with the wind&quot;, 29.0f, &quot;Margaret Mitchell&quot;);
Gson gson = new Gson();
String json = gson.toJson(book);
</code></pre>
<h2 id="tools-for-testing-apis"><a class="header" href="#tools-for-testing-apis">Tools for testing APIs</a></h2>
<p>The the last subsection, we enable the Java EE application to return JSON, instead of HTML, as responses. As we mentioned, JSON is the main data type transmitting between the client (e.g., Android) and the server used in API design. Recall the <em>design-code-test cycle</em> in <a href="ch3/ch2/2.4">Section 2.4</a>. For those APIs, web browser is no longer the first choice for testing, because the rendering effect is not our concern. Instead, we would like a lightweight yet powerful tool concentrating on <em>request</em> and <em>response</em>. </p>
<p>For a long time, <a href="https://www.postman.com/">Postman</a> is recognized and popular tool to  simplify each step of the API lifecycle. And in the book, we will use <em>Thunder Client</em>, a lightweight Rest API Client Extension for <a href="https://code.visualstudio.com/">Visual Studio Code</a>.</p>
<p><img src="ch3/image/ch3-thunder.png" alt="Figure 3.10 Thunder Client extension." title=":size=50%" /></p>
<p>And we can even write tests in its <em>New Request</em> window. In Fig 3.11, we added two tests: 1) <code>Content-type</code> contains <em>application-json</em>; 2) the returned JSON string's <code>title</code> is <em>Gone with the wind</em>:</p>
<p><img src="ch3/image/ch3-json-test.png" alt="Figure 3.11 API Tests." title=":size=60%" /></p>
<p>Curious readers can further investigate how to harness this tool to help you developing design APIs. Good luck!</p>
<h2 id="binary-as-response"><a class="header" href="#binary-as-response">Binary as response</a></h2>
<p><em>Binary</em> here means a non-text resource, such as an image, an <em>.exe</em> file. Of course, in some cases, such static resources (e.g., <code>.js</code> and <code>.css</code>) can be accessed directly if they are parts of <code>webapp</code> or they are served by a dedicated web server.</p>
<p>But in rare situations, returning a binary resource as response is necessary. For example, we would like add some authentications to restrict the access; the returned binary resource is generated by code in real time; the returned binary resource is not governed by the web applications. Anyway, let's learn how to return a binary resource through servlets.</p>
<p>In what follows, we are going to return an image <em>cat.png</em> as the response. Code can be found at <code>ch3/response</code>. But it raises another question: <em>where should we put this image in</em>? Well, it can be many places.</p>
<ul>
<li><strong>Case 1</strong>: <em>cat.png</em> is put under <code>webapp</code> (a.k.a., <em>webcontent</em>, not in its subfolder <code>WEB-INF</code>).</li>
</ul>
<p>Then this image can be accessed as a static resource via <code>http://localhost:8080/response/cat.png</code> directly. In order to output an image in servlets, again, we should use the <strong>stream</strong>.</p>
<pre><code class="language-java">response.setContentType(&quot;image/png&quot;);
ServletOutputStream os = response.getOutputStream();
</code></pre>
<p>The first line is to specify the content to <code>image/png</code>, and the second line is to get an output stream from <em>response</em> via <code>getOutputStream()</code>. Recall that for text output, we use its <code>getWriter()</code> method.</p>
<p>So the real difficulty is how to read <code>cat.png</code> as an input stream.</p>
<pre><code class="language-java">InputStream is = getServletContext().getResourceAsStream(&quot;cat.png&quot;);
</code></pre>
<p><code>getServletContext</code> returns a reference to the <code>ServletContext</code> in which this servlet is running. So what is the <code>ServletContext</code>? You can regard it as the <em>application</em> context, an we will . And its <code>getResourceAsStream()</code> method is to read files under <code>webapp</code> as a stream. It does what exactly we want! </p>
<p>The next step is to enable the <em>output stream</em> output <code>is</code> to the client. As for <code>PrintWriter</code>, its <code>println()</code> method takes this responsibility, while as for <code>ServletOutputStream</code>, we should use <code>write()</code>[2]:</p>
<blockquote>
<p>void	write​(byte[] b)	
Writes b.length bytes from the specified byte array to this output stream.</p>
</blockquote>
<p>Therefore, if we can convert <code>is</code> into a byte array, the mission can be accomplished. And luckily, <code>readAllBytes()</code> is on call[3]. The complete code can found in <code>ImageServlet.java</code> of <code>ch3/response</code></p>
<pre><code class="language-java">byte[] data = is.readAllBytes();
</code></pre>
<ul>
<li><strong>Case 2</strong>: <em>cat.png</em> is put under <code>src/main</code> (a.k.a, <em>resource</em>). And to avoid confusion, we use another image <code>cat2.png</code>.</li>
</ul>
<p>Maven project would has a template <code>resources</code> folder under <code>src/main</code> by default, and we need to create it manually in Gradle. It is the place where we put some resources for Java source code by convention.</p>
<p><img src="ch3/image/ch3-resources.png" alt="Figure 3.12 File structure of resources." title=":size=40%" /></p>
<p>After compiling, those resources would in the <em>classpath</em>. Similar to <em>case 1</em>, the main task is to get the <em>input stream</em> from this image:</p>
<pre><code class="language-java">InputStream is = getClass().getClassLoader().getResourceAsStream(&quot;cat2.png&quot;);
</code></pre>
<p>Strictly speaking, understanding <code>getClass().getClassLoader()</code> would require some background knowledge about how JVM loads classes. Here, you can simply interpret it as getting a root of <em>classpath</em>.</p>
<p>In fact, in order to enable the <em>output stream</em> output <code>is</code> to the client, another solution can make it without introducing the byte array. Take the case 1 for example,</p>
<pre><code class="language-java">Path source = Path.of(getServletContext().getResource(&quot;cat.png&quot;).toURI());
Files.copy(source, os);
</code></pre>
<p>The first line is to get the <em>path</em> of the resource, and the second line is to <em>copy</em> the resource to the <em>output stream</em>[4]. Readers can try the new solution for the case 2.</p>
<h2 id="a-final-note-for-response"><a class="header" href="#a-final-note-for-response">A final note for response</a></h2>
<p>As for <em>response</em>, we have got two choices for output: <code>ServletOutputStream</code> for bytes, or a <code>PrintWriter</code> for character data. Essentially, the <code>PrintWriter</code> wraps the <code>ServletOutputStream</code>. In other words, the <code>PrintWriter</code> has a reference to the <code>ServletOutputStream</code> and delegates calls to it. It makes sense because any character will be interpreted as bytes in the runtime. Such design, which adds higher-level method by hiding low-level operations is very common in programming. For example, <code>Files.copy()</code> is another higher-level method to hide bytes.</p>
<hr />
<p>[1] Converting an object to JSON string is called <em>serialize</em>, and converting JSON string to an object is called <em>deserialize</em>.</p>
<p>[2] <code>ServletOutputStream</code> also provides <code>println()/print()</code>, but they cannot deal with <em>stream</em> directly.</p>
<p>[3] The language should be set to at least <em>9</em>.</p>
<p>[4] The language should be set to at least <em>11</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="36-more-about-response-2"><a class="header" href="#36-more-about-response-2">3.6 More About Response (2)</a></h1>
<p>In this section, we continue studying <em>response</em> using a question-oriented method. To be specific,</p>
<ul>
<li>How to serve static files outside the web application?</li>
<li>How to customize error page?</li>
<li>To respond, or not to respond?</li>
</ul>
<h2 id="static-files-outside-the-web-application1"><a class="header" href="#static-files-outside-the-web-application1">Static files outside the web application[1]</a></h2>
<p>In the last section, we introduced several methods to return an image as the response. What if the <code>cat.png</code> is located <em>outside</em> the web application? This question can be easily solved as long as we can get its <em>path</em>. Then, what if we would to server a static folder outside the web application? For example, a folder is on you desktop and its absolute path can be <em>/Users/zhongpu/Desktop/foo</em> on MacOS, or <em>C:\Users\zhongpu
Desktop\foo</em> on Windows, or <em>/home/zhongpu/Desktop/foo</em> on Linux, and there are all kinds of files (e.g., <code>.mp3</code>, <code>.pdf</code>) in the folder.</p>
<p>We expect to get <code>a.mp3</code> via <code>/static/a.mp3</code>, get <code>b.png</code> via <code>/static/b.png</code>, and so on. Shall we write every single servlet for each file? Of course not! We even do not know how many files, and what types they are.</p>
<p>To solve this problem, we need to solve several sub-problems:</p>
<ul>
<li><em>How to write a general URL pattern</em>?</li>
</ul>
<p>The URL mapping for servlets supports wildcard characters. For example, <code>/static/*</code> can match any URL starting with <code>static/</code>.</p>
<ul>
<li><em>How to extract the file name from URL</em>?</li>
</ul>
<p>For example, we need to extract string <code>a.mp3</code> from URL <code>/static/a.mp3</code>. This task can be accomplished by a simple string operations.</p>
<pre><code class="language-java">String filename = URLDecoder.decode(request.getPathInfo().substring(1), StandardCharsets.UTF_8);
</code></pre>
<p>Here, <code>request.getPathInfo()</code> returns any extra path information associated with the URL the client sent when it made this request. The extra path information follows the servlet path but precedes the query string and will start with a &quot;/&quot; character. For example, for URL <code>/static/a.mp3</code>, it will return <code>/a.mp3</code>. And <code>decode()</code> is used to decode an <code>application/x-www-form-urlencoded</code> string. Recall that URL is encoded by the browser before sending an HTTP request.</p>
<ul>
<li><em>How to get the mime type of a file</em>?</li>
</ul>
<pre><code class="language-java">String mime = getServletContext().getMimeType(fileName);
response.setContentType(mime);
</code></pre>
<p>Again, <code>ServletContext</code> is on call. The complete code can be found at <code>StaticResourceServlet.java</code> of <code>ch3/response</code>.</p>
<h2 id="error-page"><a class="header" href="#error-page">Error page</a></h2>
<p>Errors often occur in a system, and how to handle them properly mainly depends on the business logic. Recall the example converting a string to <code>int</code> in <a href="ch3/ch3/3.2">Section 3.2</a>.</p>
<p>Suppose there is no <code>a.png</code> inside our static folder. What if we access http://localhost:8080/response/static/a.png? As expected, it throws a <code>NoSuchFileException</code>. Yes, there is NO such file. As a result, HTTP response's status code becomes 500, indicating there is  an <em>Internal Server Error</em>.</p>
<p><img src="ch3/image/ch3-500.png" alt="Figure 3.13 HTTP status code: 500." title=":size=60%" /></p>
<p>Then what if we access http://localhost:8080/response/abc? Again, suppose currently there is no any resource whose URL name is <code>abc</code>. In this case, HTTP response's status code becomes 404, indicating the targeted resource is <em>NOT Found</em>.</p>
<p>Some severs have their default error page, as we have witnessed, but we would like to customize the error page for our website. Fig 3.14 shows the 404 page of Google.</p>
<p><img src="ch3/image/ch3-google-404.png" alt="Figure 3.14 Google's 404 page." title=":size=60%" /></p>
<p>Firstly, we need to prepare a resource, including an HTML, JSP and servlet, to take the responsibility to show <em>404</em>. Here we simply use an HTML page which is adapted from <a href="https://www.zhihu.com/abc">zhihu.com</a>. Next, we add the following configuration in DD (i.e., <code>web.xml</code>):</p>
<pre><code class="language-xml">&lt;error-page&gt;
    &lt;error-code&gt;404&lt;/error-code&gt;
    &lt;location&gt;/404.html&lt;/location&gt;
&lt;/error-page&gt;
</code></pre>
<p>It tells the Tomcat that please display <code>404.html</code> when the status code is 404. Note that if <code>&lt;error-code&gt;</code> is not specified explicitly, it means it is able to match all status codes. That is all for customizing an error page.</p>
<blockquote>
<p>[!WARNING]
HTTP status code is commonly misused in software engineering.</p>
</blockquote>
<p>Please keep the rule <em>&quot;Use it as it should be&quot;</em> in mind when designing APIs. Some programmers may always return <code>200</code> even if there is an error, and it is definitely a bad practice. For example, in the last subsection's example, from the standpoint of an API, it would be better to return a <code>404</code> when the file is not found. And this can achieved by a simple <code>if-else</code>[2]:</p>
<pre><code class="language-java">if (source.toFile().exists()) {
    response.setContentType(mime);
    ServletOutputStream os = response.getOutputStream();
    Files.copy(source, os);
} else {
    response.sendError(404);
}
</code></pre>
<h2 id="to-respond-or-not-to-respond"><a class="header" href="#to-respond-or-not-to-respond">To respond, or not to respond</a></h2>
<p>In the previous examples, we mainly deal with the response within the servlet. In other words, the single servlet does all work for the <em>request-response</em> model in the server. But, you can choose to have something else handle the response for your request. You can either <em>redirect</em> the request to a completely different URL, or you can <em>dispatch the request</em> to some other component in your web app (as we have seen in the mini MVC project). In what follows, we will discuss about when and how to make a response by redirecting and dispatching.</p>
<blockquote>
<p>[!TIP]
<strong>TL;DR</strong>. Servlet redirect makes the <em>browser</em> do the work, while a request dispatch does the work on the <em>server</em> side.</p>
</blockquote>
<h3 id="redirect"><a class="header" href="#redirect">Redirect</a></h3>
<p>As for <em>redirect</em>, it means when a web browser attempts to open a URL that has been redirected, a page with a different URL is opened.</p>
<pre><code class="language-java">@WebServlet(name = &quot;RedirectServlet&quot;, value = &quot;/redirect&quot;)
public class RedirectServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {
        response.sendRedirect(&quot;https://zhongpu.gitlab.io/java-web-book/&quot;);
    }
}
</code></pre>
<p>In the code above, when a user visit <code>/redirect</code>, it would send a <em>redirect</em> to another URL. Let's have a closer look at what it happened exactly.</p>
<ul>
<li>Step 1: As usual, the client sends an HTTP request to the server.</li>
<li>Step 2: The server redirects this request by returning a new URL to the client[3]. Note that the response status code is <code>301</code> (indicating <em>Moved Permanently</em>) or <code>302</code> (indicating <code>Found</code>)[4].</li>
<li>Step 3: After the client received the new URL, it will visit this new URL automatically.</li>
</ul>
<p>Since it is the <em>client</em> that does all work for a new request, the client will see the new URL.</p>
<p>Now let's try to make some changes for the new URL. In the code above, the URL is absolute, but relative URLs are more common when using <code>sendRedirect()</code>. Relative URLs come in two flavors: with or without a starting forward slash (&quot;/&quot;)[5].</p>
<p>Image the client originally typed in: http://localhost:8080/response/foo/redirect.</p>
<p>When the request comes into the servlet named &quot;redirect&quot;, the servlet calls <code>sendRedirect()</code> with a relative URL that does not start with a forward slash:</p>
<pre><code class="language-java">sendRedirect(&quot;bar/test.html&quot;)
</code></pre>
<p>Then container builds the full URL relative to the original request URL: http://localhost:8080/response/foo/bar/test.html.</p>
<p>But if the argument to <code>sendRedirect()</code> starts with a forward slash:</p>
<pre><code class="language-java">sendRedirect(&quot;/bar/test.html&quot;)
</code></pre>
<p>Then the container builds the complete URL <strong>relative to the web container root itself</strong>. So the new URL will be: http://localhost:8080/bar/test.html. Recall that there may be several applications within a container.</p>
<p>Readers can design tests to understand these two kinds of relative URLs[6].</p>
<blockquote>
<p>[!NOTE]
You cannot do a <code>sendRedirect()</code> after writing to the response.</p>
</blockquote>
<h3 id="dispatch"><a class="header" href="#dispatch">Dispatch</a></h3>
<p>We have studied how to <em>dispatch</em> a request in the mini MVC project. Different from <em>redirect</em>, a request dispatch does the work on the server side.</p>
<pre><code class="language-java">RequestDispatcher dispatcher = request.getRequestDispatcher(&quot;json&quot;);
dispatcher.forward(request, response);
</code></pre>
<p>Instead, the browser address bar didn't change, and the user does not know that <code>json</code> generated the response. Different from <em>redirect</em>, the servlet only make one response, and it simply forwards the same request to another resource within the same application.</p>
<p>Note that the parameter what <code>getRequestDispatcher()</code> accepts is always a <em>relative</em> path. Similarly, relative URLs come in two flavors: with or without a starting forward slash (&quot;/&quot;).</p>
<pre><code class="language-java">@WebServlet(name = &quot;Forward2Servlet&quot;, value = &quot;/foo/forward&quot;)
public class Forward2Servlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.getRequestDispatcher(&quot;/json&quot;).forward(request, response);
    }
}
</code></pre>
<p>Image this servlet is accessed by http://localhost:8080/response/foo/forward. The relative path <code>/json</code>, starting with &quot;/&quot;, will build a path relative to the servlet's context root. So the final path is http://localhost:8080/response/json. If it were <code>json</code>, without the forwarding slash, then the final path would be http://localhost:8080/response/foo/json. </p>
<h3 id="a-summary-of-redirect-and-dispatch"><a class="header" href="#a-summary-of-redirect-and-dispatch">A summary of redirect and dispatch</a></h3>
<p>To sum up, <em>dispatch</em> is a practical technique in MVC design, while <em>redirect</em> is mainly to make a web page available under more than one URL address. For example[7]:</p>
<ul>
<li><strong>Force HTTPS</strong>: Some websites would redirect HTTP requests to HTTPS requests for security issues.</li>
<li><strong>Moving pages to a new domain</strong>: Some websites may has more than one domain name, and they would redirect <code>olddomain.com</code> to <code>newdomain.com</code>.</li>
<li><strong>URL shortening</strong>: Web applications often include lengthy descriptive attributes in their URLs, and URL shortening services provide a solution to this problem by redirecting a user to a longer URL from a shorter one.</li>
</ul>
<p>Last but not the least, let's consider a non-trivial problem for MVC design: where should we put <em>views</em>? Recall that in the mini MVC project, <code>result.jsp</code> is located at the <code>webapp</code>, then what happens if a user visit <code>result.jsp</code> directly without the transit of <em>forward</em>? She would find there is a 500 error due to the <code>NullPointerException</code>. Although we can provide default values for them or add non-null checking, this approach does not really make logic sense. </p>
<p><img src="ch3/image/ch3-result.png" alt="Figure 3.15 Server internal error in a view." title=":size=60%" /></p>
<p>To avoid this problem, a better solution is to hide the view from users. So we could put views under <code>webapp/WEB-INF</code>, where users cannot access them directly.</p>
<pre><code class="language-java">request.getRequestDispatcher(&quot;/WEB-INF/result.jsp&quot;).forward(request, response);
</code></pre>
<hr />
<p>[1] This subsection is adapted from <a href="https://stackoverflow.com/questions/1812244">StackOverflow</a>.</p>
<p>[2] As a matter of fact, there is also a method called <code>setStatus()</code>. But if we consider such <em>status code</em> as an error, we should use <code>sendError()</code>.</p>
<p>[3] The new URL is in HTTP response's <em>Location</em> header.</p>
<p>[4] 3XX is for <em>Redirection</em> messages; 4XX is for <em>Client error</em> responses; 5XX is for <em>Server error</em> responses.</p>
<p>[5] Readers may analogize URLs to paths in file system when it comes to <em>absolute</em> or <em>relative</em>.</p>
<p>[6] It is also legal to double forward slash (&quot;//&quot;), and the container interprets it as a network-path reference. For example, <code>//zhongpu.gitlab.io/java-web-book/</code></p>
<p>[7] https://en.wikipedia.org/wiki/URL_redirection</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-2"><a class="header" href="#exercise-2">Exercise</a></h1>
<p><strong>3.1</strong>. Design and implement a test to verify that <code>init()</code> is called only once.</p>
<hr />
<p><strong>3.2</strong>. Please run the <em>thread</em> sample code in <a href="ch3/ch3/3.1">Section 3.1</a>, and observe the output.</p>
<hr />
<p><strong>3.3</strong>. In the <code>mini-mvc</code> project, what if <code>doPost()</code> method does not exist while the <code>method=&quot;POST&quot;</code> is specified in the form?</p>
<hr />
<p><strong>3.4</strong>. Which error would you encounter on the web page if you try to convert <em>&quot;3.14&quot;</em> to <code>int</code>?</p>
<hr />
<p><strong>3.5</strong>. Extend <code>mini-mvc</code> for book recommendation. Add a view to display:</p>
<pre><code>Your age is xxx.
You name is xxx.
Recommendation:
1. XXX
2. XXX
</code></pre>
<p>Make sure the <em>name</em> can be in non-Latin languages, and it is able to output user-friendly message when the <em>age</em> is not valid.</p>
<hr />
<p><strong>3.6</strong>. In most cases, the browser' default validation using <code>required</code> is not you want. Therefore, front-end frameworks can help you out. Try to understand <code>form.html</code> in <code>ch3/request</code> which is integrated with Bootstrap. (Skip this exercise if you don't know JavaScript)</p>
<hr />
<p><strong>3.7</strong>. Password confirmation validation is very common in sign up pages. Try to understand <a href="https://www.w3schools.com/howto/howto_js_password_validation.asp">Password Validation</a>. (Skip this exercise if you don't know JavaScript)</p>
<hr />
<p><strong>3.8</strong>. Can we use <code>getParameterValues()</code> to obtain a single value parameter like <em>&quot;age&quot;</em> in <code>ch3/request</code>? Design a test to verify your hypothesis.</p>
<hr />
<p><strong>3.9</strong>. Write a helper method to get the suffix of a file name for <code>UploadServlet.java</code> in <code>ch3/request</code>. For example, <code>getSuffix(&quot;abc.png&quot;)</code> returns <em>.png</em>; <code>getSuffix(&quot;123.abc.txt&quot;)</code> returns <em>.txt</em>.</p>
<pre><code class="language-java">String getSuffix(String path)
</code></pre>
<p>And then combine this method with UUID to save upload files.</p>
<hr />
<p><strong>3.9</strong>. Try to upload multiple files in a form.</p>
<hr />
<p><strong>3.10</strong>. We can customize many settings (e.g., the limiting size of the uploaded file) by <code>@MultipartConfig</code>. For example, it could be constructed as follows:</p>
<pre><code class="language-java">@MultipartConfig(location=&quot;/tmp&quot;, fileSizeThreshold=1024*1024, 
    maxFileSize=1024*1024*5, maxRequestSize=1024*1024*5*5)
</code></pre>
<p>Please try to understand what this annotation means.</p>
<hr />
<p><strong>3.11</strong>. Bootstrap provides input group style for file uploading. Please add some code to <code>upload2.html</code> in <code>ch3/request</code> to let it upload files.</p>
<hr />
<p><strong>3.12</strong>. Add restrictions for <code>upload.html</code> in <code>ch3/request</code> to let it only allow <em>.jpg</em>, <em>.jpeg</em> and <em>.png</em> files. Note that the server-side checking is also required.</p>
<hr />
<p><strong>3.13</strong>. How does the payload look like in a <code>multipart/form-data</code> request? Try to inspect it in the <code>Network</code> tab.</p>
<hr />
<p><strong>3.14</strong>. Try to return a list of <code>Book</code> objects as JSON string based on <code>Json2Servlet.java</code> of <code>ch3/response</code>.</p>
<hr />
<p><strong>3.15</strong>. Can you access <code>cat.png</code> if it is put inside <code>webapp/WEB-INF</code>? If not, please write code to return it as the response.</p>
<hr />
<p><strong>3.16</strong>. Please return a PDF file as the response.</p>
<hr />
<p><strong>3.17</strong>. In <a href="ch3/ch3/3.5">Section 3.5</a>, we provided two methods to enable <em>output stream</em> to output the <em>input stream</em>. Particularly, the first method will get all bytes from the resource:</p>
<pre><code class="language-java">byte[] data = is.readAllBytes();
</code></pre>
<p>Clearly, it would result in much memory overhead if the resource is very large. A common trick is to read-write per fixed small length (e.g., 1024) of bytes. For example,</p>
<pre><code class="language-java">int read = 0;
byte[] bytes = new byte[1024];
while ((read = is.read(bytes)) != -1) {
    os.write(bytes, 0, read);
}
</code></pre>
<p>Try to understand the code above and test in a servlet. (Note that the memory overhead is no longer a problem if we use <code>Files.copy()</code>.)</p>
<hr />
<p><strong>3.18</strong>. For an HTTP <em>response</em>, we mainly care about its <em>status code</em>, <em>content type</em> and <em>content</em>. Both <em>status code</em> and <em>content type</em> belong to the response <em>header</em>, and you can view them in the <code>Network</code> tab. Try to figure out what <code>setHeader()</code> and <code>addHeader()</code> are used for.</p>
<hr />
<p><strong>3.19</strong>. In <code>Forward4Servlet.java</code> of <code>ch3/response</code>. What is the wrong with the code? Can you have some conclusions?</p>
<hr />
<p><strong>3.20</strong>. By default, Tomcat would locate and display the <em>index</em> page (e.g., <code>index.jsp</code>, <code>index.html</code>) when we start a web application. In fact, we are also able to specify our customized <em>index</em> in DD. For example,</p>
<pre><code class="language-xml">&lt;welcome-file-list&gt;
    &lt;welcome-file&gt;home.html&lt;/welcome-file&gt;
&lt;/welcome-file-list&gt;
</code></pre>
<p>It means <code>home.html</code> will be considered as the welcome page, and the content of <code>&lt;welcome-file&gt;</code> accepts any valid resource name including a servlet's URL name.</p>
<hr />
<p><strong>3.21</strong>. Create a servlet which accepts a text and then generates a QRCode as the response. Please use <code>Zxing</code> as the dependency.</p>
<p><em>Hint</em>: <code>MatrixToImageWriter</code> offers a static method <code>writeToStream()</code>. You can find more at the <a href="https://zxing.github.io/zxing/apidocs/">API Doc</a>.</p>
<pre><code class="language-java">public static void writeToStream(BitMatrix matrix, String format, OutputStream stream)
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-4-in-depth-web"><a class="header" href="#chapter-4-in-depth-web">Chapter 4: In-depth Web</a></h1>
<p>Data sharing is a common task in programming. In the code's level, it can be achieved by functions' parameters/arguments, global variables, external files, databases. And Java EE further provides other mechanisms for information sharing.</p>
<p>In this chapter, we will investigate how the pieces of the web application interact. <strong>No servlet stands alone.</strong> In today's modern web application, many components, including models, controllers, and views, work together to accomplish a goal. For example, we have used <em>attributes</em> in the mini MVC project to tie the controller and view together.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="41-init-parameters"><a class="header" href="#41-init-parameters">4.1 Init parameters</a></h1>
<p>When starting an application, we always hope that it is flexible enough to change some configurations if necessary. It can be database's connection information[1], the contact email address, the file path. For example, in <code>HelloServlet.java</code>, we would like to output a welcome message to users on the web page. What if we want to output &quot;Hello and Happy New Year&quot; on new year's eve?</p>
<pre><code class="language-java">public void init() {
    message = &quot;Hello World!&quot;;
}
</code></pre>
<p>Changing the Java code? We will introduce a better way to solve this problem.</p>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>First of all, we have to keep an important rule in mind: <em>Never hard code if possible</em>. In the code above, the string literal is hard coded, so it is impossible for us to <em>change</em> it without changing code and recompiling[2]. Generally, we have two solutions:</p>
<ul>
<li>Design a program to check the date of the day. Its main idea is very straightforward: <code>if (is_new_year) { message = &quot;Hello and Happy New Year&quot; ;}</code>. But the limitation of this method is that we have to code all logic in advance. What if you want to change it to &quot;Hello, and Happy New Year&quot; after the code is compiled and packaged? So, a more flexible method is required.</li>
<li>Write those <em>configurations</em> in external files[3], including databases. As we can see, this method has the highest flexibility.</li>
</ul>
<blockquote>
<p>In computing, configuration files (commonly known simply as config files) are files used to configure the parameters and initial settings for some computer programs. </p>
</blockquote>
<p>Of course, we can use any kind of config files in Java EE, but Java EE provides built-in supports in DD (i.e., <code>web.xml</code>)[4], and it can alleviate our programming labour greatly.</p>
<p>Therefore, by convention, web configurations, including init parameters should be put in DD.</p>
<h2 id="servlet-init-parameters"><a class="header" href="#servlet-init-parameters">Servlet init parameters</a></h2>
<p>Recall the static file serving example in <a href="ch4/ch3/3.6">Section 3.6</a>. A folder called <em>/Users/zhongpu/Desktop/foo</em> on MacOS or <em>C:\Users\zhongpu Desktop\foo</em> on Windows, or <em>/home/zhongpu/Desktop/foo</em> on Linux is the root of these static files. We would like to consider this path as a <em>parameter</em> in config files, so we can change it by modifying only the <code>web.xml</code> file, <strong>without having to touch the servlet source code</strong>.</p>
<p>We use the <code>&lt;init-param&gt;</code> nested in <code>&lt;servlet&gt;</code> to set name-value pairs for init parameters. Note that both name and value must be <code>String</code>.</p>
<pre><code class="language-xml">&lt;servlet&gt;
    &lt;servlet-name&gt;InitServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;com.swufe.javaee.init.InitServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;path&lt;/param-name&gt;
        &lt;param-value&gt;/Users/zhongpu/Desktop/foo&lt;/param-value&gt;
    &lt;/init-param&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;InitServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/init&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre>
<p>And in <code>InitServlet.java</code>, we are able to get the value given a name, and the complete code can found at <code>ch4/init</code>.</p>
<pre><code class="language-java">String path = getInitParameter(&quot;path&quot;);
</code></pre>
<p>In the code of DD above, we put all configurations including URL mappings inside the <code>web.xml</code>. Can we still use annotations? Yes, we can (see <code>Init2Servlet.java</code>).</p>
<pre><code class="language-java">@WebServlet(name = &quot;Init2Servlet&quot;, value = &quot;/init2&quot;, initParams = {
        @WebInitParam(name = &quot;path&quot;, value = &quot;C:\\Users\\zhongpu\\Desktop\\foo&quot;)
})
</code></pre>
<p>Which style of init parameters should we use? It is actually is trade-off. DD style prefers flexibility in code maintenance as you do not have to touch the code, while annotation style prefer flexibility in code writing as it is more concise. As a matter of fact, we can even achieve a balance by using annotations for URL mappings while using DD for init parameters. Readers can try out this new approach.</p>
<p>The servlet init parameters are read only once (when the container initializes the servlet). Recall the lifecycle of a servlet, <code>init()</code> is called during initialization. In fact, <code>init()</code> wraps another method <code>init(ServletConfig)</code>. So, what is <code>ServletConfig</code>? Every servlet has a servlet configuration object:</p>
<blockquote>
<p>A servlet configuration object used by a servlet container to pass information to a servlet during initialization.</p>
</blockquote>
<p>This is the whole story of the init parameters[5]:</p>
<ul>
<li>Step 1: Container reads the Deployment Descriptor for this servlet, including <code>&lt;init-param&gt;</code>.</li>
<li>Step 2: Container crates a new <code>ServletConfig</code> instance of this servlet.</li>
<li>Step 3: Container gives the <code>ServletConfig</code> references to the name/value init parameters[6].</li>
<li>Step 4: Container creates a new instance of the servlet.</li>
<li>Step 5: Container calls the servlet <code>init(ServletConfig)</code> method, passing in the reference to the <code>ServletConfig</code>.</li>
</ul>
<p><img src="ch4/image/ch4-init.png" alt="Figure 4.1 ServletConfig and init parameters." title=":size=50%" /></p>
<p>As a result, <code>getInitParameter()</code> is a shorthand of <code>getServletConfig().getInitParameter()</code>.</p>
<p>By the way, since the container would read the init parameters only once, how to make the modification visible in the runtime? You can <em>redeploy</em> this web application, but taking your web application down is not a wise solution. Therefore, most of the production-quality Web Containers let you do a <em>hot redeploy</em>, which means that you don’t have to restart your server or take any other web apps down. However, redeploying a web application just because the init parameter value changed can be a bad idea. If the value of your init parameters are going to change frequently, you're better off having your servlet methods get the value from a file or database. Remember: <em>No code is panacea.</em>. Init parameters are designed to provide you some extent of flexibility, and trade-off should be always considered when programming.</p>
<h2 id="context-init-parameters"><a class="header" href="#context-init-parameters">Context init parameters</a></h2>
<p>The init parameters above are scoped to a single servlet, but sometimes we would like those parameters to be visible throughout the whole application. The code is very similar to the one above.</p>
<p>We use <code>&lt;context-param&gt;</code> in DD. <em>Context</em> is the application runtime where the servlet is running.</p>
<pre><code class="language-xml">&lt;context-param&gt;
    &lt;param-name&gt;path&lt;/param-name&gt;
    &lt;param-value&gt;/home/zhongpu/Desktop/foo&lt;/param-value&gt;
&lt;/context-param&gt;
</code></pre>
<p>As shown in Fig 4.2, <code>ServletConfig</code> is one per servlet, but <code>ServletContext</code> is one per web application[7]. Therefore, if you would like to share something globally, <code>ServletContext</code> is your own choice. By the way, you can think of init parameters as deploy-time constants: you can get them at runtime, but you cannot set them. There is no <code>setInitParameter()</code>!</p>
<pre><code class="language-java">String path = getServletContext().getInitParameter(&quot;path&quot;);
</code></pre>
<p><img src="ch4/image/ch4-context.png" alt="Figure 4.2 ServletContext and ServletConfig." title=":size=60%" /></p>
<p>In fact, <em>ServletContext</em> can be confusing, and a better name of it would be <em>ApplicationContext</em>. But the reality is the designers of Java EE used the confusing name; we have to tolerant it. So, we would simply call it <em>context</em>.</p>
<hr />
<p>[1] Like URL, it includes <em>hostname</em>, <em>port</em>, <em>username</em>, <em>password</em>, <em>database name</em>.</p>
<p>[2] This problem is less severe in script languages (e.g., Ruby and Python).</p>
<p>[3] There are many types of configuration files in different computing environments, such as <code>properties</code>, <code>ini</code>, <code>rc</code>, and simple <em>key–value</em> (i.e., <em>name-value</em>) pair format is very common.</p>
<p>[4] If we use our customized config files, we have to handle the <em>write/read</em> issues by our own.</p>
<p>[5] When using annotations, the process is similar.</p>
<p>[6] In Java, &quot;an object A <em>has</em> B&quot; means &quot;A has a <em>reference</em> of B&quot;.</p>
<p>[7] JSP is also a servlet in runtime, so it also has a <code>ServletConfig</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="42-attributes"><a class="header" href="#42-attributes">4.2 Attributes</a></h1>
<p>In the mini MVC project, we have used <em>attributes</em> to send data from <em>controllers</em> to <em>views</em>. Attributes, like init parameters, are in the form of name-value. But different from init parameters, the values can be <em>objects</em>, rather than simple strings. </p>
<blockquote>
<p>An attribute is like an object pinned to a bulletin board. Somebody stuck it on the board so that others can get it.</p>
</blockquote>
<p>To use attributes, we need to understand two questions: 1) Who has access to it?; 2) How long does it live? In other words, what is the <em>scope</em> of the attribute? Generally speaking, there are three scopes for attributes:</p>
<ul>
<li><strong>Context</strong>: It is the <code>ServletContext</code> representing the web application.</li>
<li><strong>Request</strong>: It is the <em>request</em> part of a <em>request-response</em> model, and you can simply think of it as the <code>HttpServletRequest</code> object in most cases.</li>
<li><strong>Session</strong>: This is a key point (<code>HttpSession</code>) we will explain in detail later. Now you can simply think of it as several request-response phrases by the <em>same</em> person.</li>
</ul>
<p>For example,</p>
<pre><code class="language-java">request.setAttribute(&quot;books&quot;, books);
RequestDispatcher dispatcher = request.getRequestDispatcher(&quot;result.jsp&quot;);
dispatcher.forward(request, response);
</code></pre>
<p>In the code above, the attribute is in the scope of a <em>request</em>. Because <code>result.jsp</code> and this servlet use the <em>same</em> request when forwarding, <code>result.jsp</code> is able to call <code>getAttribute()</code> to <em>get</em> the attribute.</p>
<h2 id="attributes-vs-parameters"><a class="header" href="#attributes-vs-parameters">Attributes vs. parameters</a></h2>
<p>In the last section, we have studied two types parameters: servlet init parameters and context init parameters. In fact, what we send from <em>views</em> to <em>controller</em> are also parameters. We can find many similarities among them: name-value string pairs; only <code>get()</code> is allowed.</p>
<p>Many students may find it hard to distinguish attributes and parameters. The following table summarizes the main differences.</p>
<table><thead><tr><th style="text-align: left"></th><th style="text-align: center">Attributes</th><th style="text-align: right">Parameters</th></tr></thead><tbody>
<tr><td style="text-align: left">Types</td><td style="text-align: center">Context <br> Request <br> Session</td><td style="text-align: right">Context init parameters <br>  Request parameters <br> Servlet init parameters</td></tr>
<tr><td style="text-align: left">Method to set</td><td style="text-align: center"><code>setAttribute(String, Object)</code></td><td style="text-align: right">You cannot set init parameters[1]</td></tr>
<tr><td style="text-align: left">Return type</td><td style="text-align: center">Object</td><td style="text-align: right">String</td></tr>
<tr><td style="text-align: left">Method to get</td><td style="text-align: center"><code>getAttribute(String)</code></td><td style="text-align: right"><code>getInitParameter(String)</code></td></tr>
</tbody></table>
<blockquote>
<p>[!TIP]
In daily programming, <em>attributes</em> is much more frequently used than <em>init parameters</em>.</p>
</blockquote>
<p>In what follows, we will have a glance at attributes related APIs. Readers can refer to the API documentation for more information.</p>
<p><img src="ch4/image/ch4-attributes.png" alt="Figure 4.3 Attributes' APIs." title=":size=40%" /></p>
<h2 id="thread-safety-and-attributes"><a class="header" href="#thread-safety-and-attributes">Thread-safety and attributes</a></h2>
<p>We know that there are three scopes of attributes, but there is a dark side that cannot be ignored: thread-safety. In this book, we won't take much space to explain the thread-sate of attributes in a technical view. Rather, we think it can also be well understood through natural language.</p>
<blockquote>
<p>A class is thread-safe if it behaves correctly when accessed from multiple threads.</p>
</blockquote>
<p>As a matter of fact, thread-safety is a common issue in terms of data sharing. For example, suppose an attribute is in the scope of <code>ServletContext</code>. It is possible for several servlets/threads to update it at the same time. So context scope is not thread safe. Similarly, session scope is not thread safe either, because there could be more than more request at the same time from the same client (i.e., the same session).</p>
<p>To achieve thread safety, the main idea is to let only thread access the current attribute at a time, and one method is to use <code>synchronized</code> in Java. As we can imagine, such restriction would result in bad performance in the context scope. So we should not update attributes in the context scope if possible. Luckily, for session scope, it is not a big deal: one person one request at a time. Quite fair, isn't it?</p>
<pre><code class="language-java">HttpSession session = request.getSession();
synchronized(session) {
    session.setAttribute(&quot;foo&quot;, &quot;22&quot;);
    session.setAttribute(&quot;bar&quot;, 42);
}
</code></pre>
<p>The code above may look sophistic for beginners. Don't worry. Currently what you need to know is that 1). What thread-safety is; 2) Attributes in session scope is not thread-safe; 3) <code>synchronized</code> can solve this problem.</p>
<p>A final question: what about request attributes? In Fig 3.3, we know that each request is processed in a single thread. So attributes in request scope is thread-safe!</p>
<h2 id="attributes-example-database-connection"><a class="header" href="#attributes-example-database-connection">Attributes example: database connection</a></h2>
<p>The usage of attributes is very straightforward. In this section, let's try to use attributes to implement a practical functionality in web applications.</p>
<p>In last section, we mentioned that we can put database connection string in init parameters. And any database operations in the web application should use this global <em>database connection</em>. It is reasonable to put it in the context attribute.</p>
<pre><code class="language-java">DatabaseConn conn = new DataBaseConn(&quot;hostname&quot;, &quot;user&quot;, &quot;password&quot;, &quot;database&quot;);
context.setAttribute(&quot;database&quot;, conn);
</code></pre>
<p>Note that <code>DatabaseConn</code> above is mock class for testing, and it cannot carry out any real database task.</p>
<p>The next question is: where should the code above be put? What about a servlet's <code>init()</code>? It seems a bad idea, because we would expect a place where the whole application is initialized (before any servlets or JSPs). Is there a <code>init()</code> of <em>context</em> for us to override? Unfortunately, no. It seems like a very hard problem. At least servlets are unable to do anything. </p>
<p>But, listeners can solve this problem! The core idea behind <em>listeners</em> is:</p>
<ul>
<li>A listener binds to an event.</li>
<li>When the event is triggered, the listener will be notified and then do something (<em>callback</em> event).</li>
</ul>
<p>Back to our example. A listener binds to the context's initialization event; when the context is initialized, we call <code>setAttribute()</code> method.</p>
<p>In Java EE, there are several listener interfaces, and what we need to do is to implement them and override their methods. For example, the one related with <em>context</em> is <code>ServletContextListener</code>[2].</p>
<pre><code class="language-java">@WebListener
public class DatabaseListener implements ServletContextListener
</code></pre>
<p>Again, we use annotations here to declare that it is a listener. Readers can try out how to do it alternatively in DD.</p>
<p><img src="ch4/image/ch4-listener.png" alt="Figure 4.4 ServletContextListener." title=":size=40%" /></p>
<p>As we can this, this interface binds two events, representing context's initialization and destroying, respectively. So what is <code>ServletContextEvent</code>? This is the event class for notifications about changes to the servlet context of a web application, and it has a reference to <code>ServletContext</code>.</p>
<p>In the <code>contextInitialized()</code> method, we can implement our <em>callback</em> logic, and the complete code can be found at <code>DatabaseListener.java</code> of <code>ch4/listener</code>.</p>
<pre><code class="language-java">DatabaseConn conn = new DatabaseConn(host, user, password, database);
sce.getServletContext().setAttribute(&quot;database&quot;, conn);
</code></pre>
<p>Then we can use the sharing <code>conn</code> in servlets:</p>
<pre><code class="language-java">DatabaseConn conn = (DatabaseConn) getServletContext().getAttribute(&quot;database&quot;);
</code></pre>
<p>Besides context events, you can listen for events related to context attributes, servlet requests and attributes, and HTTP sessions and session attributes. Again, you don't have to memorize them. The key point is to understand how a <em>listener</em> works, and also remember: there are many lifecycle events in a web application, and it is possible to be notified and do something using a right type of listener.</p>
<ul>
<li>ServletRequestListener</li>
<li>HttpSessionAttributeListener</li>
<li>HttpSessionBindingListener</li>
<li>ServletContextAttributeListener</li>
<li>HttpSessionListener</li>
<li>ServletRequestAttributeListener</li>
</ul>
<h2 id="listener-example-log"><a class="header" href="#listener-example-log">Listener example: log</a></h2>
<p>Many websites would log every request information containing who was visiting the site, where they came from, and exactly what they were doing on the web site, and these log files are valuable resources for business intelligence. The W3C maintains a <a href="https://www.w3.org/TR/WD-logfile">standard format</a> for web server log files, and for simplicity, we design a compact format based on it. Each line is in the form of <em>time method resource</em>, separately by a blank space. For example,</p>
<pre><code>00:34:23.344207 GET /foo/bar.html
12:21:16.963480 POST /foo/a
12:45:52.255619 GET /foo/b.jsp
</code></pre>
<p>To accomplish this task, we should <em>listen to</em> the event of every request coming in, and that is exactly what <em>ServletRequestListener</em> does.</p>
<pre><code class="language-java">@WebListener
public class LogListener implements ServletRequestListener {
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        // log
    }
}
</code></pre>
<p>Essentially, logs are append-only files. Firstly, we need to get the current time and necessary information from <code>sre</code>:</p>
<pre><code class="language-java">String now = LocalTime.now().toString();
HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
String method = request.getMethod();
String context = request.getContextPath();
String path = request.getServletPath();
String s = &quot;%s %s %s%s\n&quot;;
String record = String.format(s, now, method, context, path);
</code></pre>
<p>Then we use <code>Files</code> to write this line to the file[3], and it is thread-safe.</p>
<pre><code class="language-java">Path p = Path.of(&quot;/Users/zhongpu/Desktop/file.log&quot;);
try {
    Files.writeString(p, record, StandardOpenOption.CREATE, StandardOpenOption.APPEND);
} catch (IOException e) {
    e.printStackTrace();
}
</code></pre>
<p>By the way, due to the importance of logging, communities have designed some awesome specialized libraries (e.g., <a href="https://www.slf4j.org/">SLF4J</a>) to help programmers to deal with logging. We also develop another logging system using the built-in <code>java.util.logging</code>, and the complete code can be found at <code>LogListener.java</code> of <code>ch3/listener</code>.</p>
<hr />
<p>[1] With request parameters, you can adjust the query String, but that's different.</p>
<p>[2] In IntelliJ IDEA, when we create a <em>listener</em>, it will automatically implement <code>ServletContextListener</code>, <code>HttpSessionListener</code>, <code>HttpSessionAttributeListener</code>. You can delete unneeded interfaces and their methods. </p>
<p>[3] The language level should be set to at least 11.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="43-session-management-1"><a class="header" href="#43-session-management-1">4.3 Session Management (1)</a></h1>
<p>In the classical <em>request-response</em> model, the server cannot remember who you are. In other words, as far as the container's concerned, <strong>each request is from a new client</strong>. But, in real world, remembering the client is very important. For example, after you logged in a website, the website is expected to be able to recognize your identification. Otherwise, you have to input your name and password again and again for any subsequent action.</p>
<p><img src="ch4/image/ch4-session.png" alt="Figure 4.5 HTTP is stateless." title=":size=50%" /></p>
<p>HTTP is stateless. In order to associate a request to any other request, you need a way to store user data between HTTP requests. One solution is to store some <em>id</em> to identify a unique user. This is how <em>session</em> works[1].</p>
<blockquote>
<p>Session, literally, means a conversation, and it is to keep conversational state with the client across multiple requests.</p>
</blockquote>
<p>Session is also one of the three scopes of attributes, so understanding how session works and how to use session would definitely enrich your programming toolbox.</p>
<h2 id="how-session-works"><a class="header" href="#how-session-works">How session works</a></h2>
<p>Resident Identity Card has a unique <em>ID</em> for everyone in a country; every student has a unique <em>ID</em> in her campus. So, the idea is simple: the container keeps a unique <em>ID</em> for every session. So the whole story goes:</p>
<ul>
<li>On the client's first request, the container generates a unique session ID and gives it back to the client with the response.</li>
<li>The client sends back the session ID with each subsequent request.</li>
<li>The container sees the ID, finds the matching session, and associates the session with the request.</li>
</ul>
<p>Note that the session ID is shipped with the response. Let's check the <code>Network</code> tab using the web browser of the response header for the first time (<code>ch3/response</code>). <code>Set-Cookie</code> is just another header sent in the response, and <code>JSESSIONID</code> is the <em>ID</em> generated by the container. As we expected, for the subsequent requests, we will find the <em>same</em> <code>JSESSIONID</code> at the request's header again.</p>
<p><img src="ch4/image/ch4-set-cookie.png" alt="Figure 4.6 Set-cookie in response header." title=":size=50%" /></p>
<p>As we can see, cookie is used to exchange the <em>ID</em> between the client and server. So what is cookie exactly? Of course, it is not the biscuit in your favorite bakery.</p>
<blockquote>
<p>An HTTP cookie (web cookie, browser cookie) is a small piece of data that a server sends to a user's web browser[2].</p>
</blockquote>
<p>The browser may store the cookie and send it back to the same server with later requests. Typically, an HTTP cookie is used to tell if two requests come from the same browser—keeping a user logged in, for example. It remembers stateful information for the stateless HTTP protocol.</p>
<p>Back the <code>Set-Cookie</code> header. A simple cookie is set like this:</p>
<pre><code>Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;
</code></pre>
<p><code>JSESSIONID</code> is the name generated by the servlet container; other severs might use different names. And as we will see soon, like any other header, we can put anything we like into cookies.</p>
<p>By the way, strictly speaking, the statement &quot;On the client's first request, the container generates a unique session ID&quot; is not correct. We need to figure out another question: <em>Under what conditions is a JSESSIONID created?[3]</em> Now only partial answer is given:</p>
<blockquote>
<p>Every call to JSP page implicitly creates a new session if there is no session yet.</p>
</blockquote>
<p>We will investigate this problem in the next subsection.</p>
<h2 id="how-and-when-session-is-created"><a class="header" href="#how-and-when-session-is-created">How and when session is created?</a></h2>
<p>Did we manually <code>Set-Cookie</code> for the response? No. So the container does virtually all the cookie work for us! How to send a session with cookie in the response? One line of code is enough:</p>
<pre><code class="language-java">HttpSession session = request.getSession();
</code></pre>
<p>That's it. Everything else happens automatically[4]:</p>
<ul>
<li>You don't make the new <code>HttpSession</code> object yourself.</li>
<li>You don't generate the unique session ID.</li>
<li>You don't make the new <code>Cookie</code> object.</li>
<li>You don't associate the session ID with the cookie.</li>
<li>You don't set the <code>Cookie</code> into the response (under <code>Set-Cookie</code> header).</li>
</ul>
<p>Session is created when your code calls <code>getSession()</code> for the first time, and the subsequent calls would return the <em>same</em> session if it exits. In fact, <code>getSession()</code> is shorthand for <code>getSession(true)</code>, and <em>true</em> means the statement <em>&quot;crate a new one if not exits&quot;</em> is true. So <code>getSession(false)</code> return a session or <code>null</code>. </p>
<p>For example, the following code in <code>HelloServlet.java</code> of <code>ch4/session</code> would output <em>This is a new session</em> on the first visit, and output <em>Welcome back</em> otherwise.</p>
<pre><code class="language-java">HttpSession session = request.getSession(false);

if (session == null) {
    out.println(&quot;This is a new session&quot;);
    request.getSession();
} else {
    out.println(&quot;Welcome back&quot;);
}
</code></pre>
<p>We can also <em>ask the session</em> to know if the session is new by <code>isNew()</code> method of <code>HttpSession</code>. The refactor work is left as an exercise to readers.</p>
<h2 id="how-long-session-lives"><a class="header" href="#how-long-session-lives">How long session lives</a></h2>
<p>No one is immortality, neither is a session. You might notice the message on the log-in page, such as <em>Remember me for one week</em>. It means the browser will keep your stayed for some time, and after this duration, it forgets you, and you have to log in again. Anyway, we may need to consider the lifespan of a session.</p>
<p><img src="ch4/image/ch4-session-life.png" alt="Figure 4.7 HttpSession's API[5]." title=":size=40%" /></p>
<p>We can know what these APIs do from their names without much trouble. And we only concentrate on two methods:</p>
<blockquote>
<p>void	setMaxInactiveInterval(int interval)	
Specifies the time, in seconds, between client requests before the servlet container will invalidate this session.</p>
</blockquote>
<p>This method is to set the max interval this session can live. For example, <code>setMaxInactiveInterval(60 * 60 * 24 * 7)</code> means it will be invalidated if the same client have not sent requests for more than 7 days[6].</p>
<blockquote>
<p>void	invalidate()	
Invalidates this session then unbinds any objects bound to it.</p>
</blockquote>
<p>This method is to kill a session manually. Of course, when the application goes down (or crashes), all sessions will also die. There is another method to set the timeout. Configuring a timeout in the DD has virtually the same effect as calling <code>setMaxInactiveInterval()</code> on every session in this web application. But note the timeout in the DD is in <em>minutes</em>, not seconds.</p>
<pre><code class="language-xml">&lt;session-config&gt;
    &lt;session-timeout&gt;60&lt;/session-timeout&gt;
&lt;/session-config&gt;
</code></pre>
<h2 id="an-example-log-in"><a class="header" href="#an-example-log-in">An example: log in</a></h2>
<p>In this example, if she does not log in, then the home page will display <em>Hello guest</em>; if you log in with her email, let's say <em>mary@gmail.com</em>, then the home page will display <em>Hello mary@gmail.com</em>.</p>
<p><img src="ch4/image/ch4-hello.png" alt="Figure 4.8 Hello message." title=":size=40%" /></p>
<p>In <code>HomeServlet.java</code>, we check if there is an attribute named <code>name</code> in the session. If so, it means she has logged in; otherwise, she is a guest user. And <code>home.jsp</code>, as the view, is used to display the hello message from the request's attribute.</p>
<pre><code class="language-java">HttpSession session = request.getSession();
if (session.getAttribute(&quot;name&quot;) == null) {
    request.setAttribute(&quot;name&quot;, &quot;Guest&quot;);
} else {
    request.setAttribute(&quot;name&quot;, session.getAttribute(&quot;name&quot;));
}
request.getRequestDispatcher(&quot;/WEB-INF/home.jsp&quot;).forward(request, response);
</code></pre>
<p>In <code>LoginServlet.java</code>, its <code>doPost</code> accepts user's email (note that password is ignored) and then puts her email into session's attribute. Finally, it redirects to home page.</p>
<pre><code class="language-java">String email = request.getParameter(&quot;email&quot;);
HttpSession session = request.getSession();
session.setAttribute(&quot;name&quot;, email);
response.sendRedirect(&quot;home&quot;);
</code></pre>
<p>In <code>LogoutServlet.java</code>, it just kills the session:</p>
<pre><code class="language-java">request.getSession().invalidate();
response.sendRedirect(&quot;home&quot;);
</code></pre>
<p>As for the <em>logout</em>, sometimes we would like to keep some attributes, then we can remove the <code>name</code>:</p>
<pre><code class="language-java">request.getSession().removeAttribute(&quot;name&quot;);
</code></pre>
<blockquote>
<p>void removeAttribute​(java.lang.String name)	
Removes the object bound with the specified name from this session. If the session does not have an object bound with the specified name, this method does nothing.</p>
</blockquote>
<p>Or alternatively, setting its value to <code>null</code>:</p>
<pre><code class="language-java">request.getSession.setAttribute(&quot;name&quot;, null);
</code></pre>
<p>Try your best to understand how the code works, especially how data is shared and passed between front-end and back-end.</p>
<hr />
<p>[1] Session, or more specifically <code>HttpSession</code>, is not the only option, but it is easy to implement. </p>
<p>[2] https://en.wikipedia.org/wiki/HTTP_cookie</p>
<p>[3] https://stackoverflow.com/questions/595872</p>
<p>[4] We need also consider the case when the client doesn't accept cookies. If cookies are disabled, then <code>isNew()</code> method will always return true. In this situation, we can use <em>URL rewriting</em> by appending session at the URL. But since it is handled in a vendor-specific way, we won't discuss it in this book.</p>
<p>[5] Only lifespan related APIs are listed here, and <em>attributes</em> related APIs are listed in Fig 4.3.</p>
<p>[6] It is commonly misunderstood that the session will die in 7 days since it was created.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="44-session-management-2"><a class="header" href="#44-session-management-2">4.4 Session Management (2)</a></h1>
<p>In this section, we continue studying session management. It mainly includes how to use custom cookies, and another two listeners with respect to session. </p>
<h2 id="in-depth-cookie"><a class="header" href="#in-depth-cookie">In-depth cookie</a></h2>
<p>Although cookies were originally designed to help support session state, we can use custom cookies for other things. Remember, a cookie is nothing more than a little piece of data (name/value String pair) exchanged between the client and the server. The server sends the cookie to the client, and the client returns the cookie when the client makes another request.</p>
<p>One cool thing about cookies is that the user doesn't have to get involved: the cookie exchange is automatic (as long as cookies are enabled in the client). Of course, programmers are also able to send cookies <em>manually</em> if necessary. Cookie is main tool for tracking (recording and analyzing user behavior) and personalization (user preferences, themes, and other settings) on the Internet. Fig 4.9 shows the cookies of requests of StackOverFlow:</p>
<p><img src="ch4/image/ch4-cookie-so.png" alt="Figure 4.9 Cookies in StackOverFlow." title=":size=60%" /></p>
<p>By default, a cookie lives only as long as a session; once the client quits the browser, the cookie disappears. That is how <em>JSESSIONID</em> cookie works. <strong>But you can tell a cookie to stay alive even after the browser shuts down</strong> by setting its max-age. First, let's have a look at cookie related APIs.</p>
<p><img src="ch4/image/ch4-cookie-api.png" alt="Figure 4.10 Cookie APIs." title=":size=60%" /></p>
<p>Readers can refer to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies">Using HTTP cookies</a> for more details, and in this book we only discuss how to use cookies via a few APIs.</p>
<p>Creating a new Cookie:</p>
<pre><code class="language-java">Cookie cookie = new Cookie(&quot;name&quot;, &quot;mary@gmail.com&quot;);
</code></pre>
<p>Setting how long a cookie will live on the client. Note that <code>setMaxAge()</code> is defined in seconds:</p>
<pre><code class="language-java">cookie.setMaxAge(30 * 60);
</code></pre>
<p>Sending the cookie to the client:</p>
<pre><code class="language-java">response.addCookie(cookie);
</code></pre>
<p>Getting the cookies from the client:</p>
<pre><code class="language-java">for (Cookie cookie : request.getCookies()) {
    if (cookie.getName().equals(&quot;name&quot;)) {
        // to do
    }
}
</code></pre>
<p><code>HomeServlet.java</code> in <code>ch4/cookie</code> is similar to the <em>log in</em> example in <a href="ch4/ch4/4.3">Section 4.3</a>. Since currently we didn't implement <em>log in</em> yet, it will always display <em>Hello Guest</em>. As we mentioned above, people can send cookies programmatically. Let's try it in the web browser. Open <code>Application</code> at <em>Inspect</em> window, select <code>Cookies</code>, and add new cookie named <code>name</code>.</p>
<p><img src="ch4/image/ch4-add-cookie.png" alt="Figure 4.11 Add a cookie in the browser." title=":size=60%" /></p>
<p>As a result, the browser will send requests with you newly added cookies, then the <code>home.jsp</code> shall display <em>Hello mary@gmail.com</em> after refreshing.</p>
<h2 id="url-rewriting"><a class="header" href="#url-rewriting">URL rewriting</a></h2>
<p>Sometimes the client may disable the cookies, and as a result, <code>Session</code> will be infeasible. Here is a short instruction about how to disable the cookie for your browser temporally. As for Edge, you can add <code>http://localhost</code> into <code>Block</code> of <code>Settings | Cookies and Site | Cookies and data stored</code>.</p>
<p>When it is disabled, you will always see &quot;This is a new session&quot; for <code>HellServlet</code> of <code>ch4/session</code>. Luckily, you can use <strong>URL rewriting</strong> as a backup. Its core idea is simple: append the <code>jsessionid</code> after the URL.</p>
<pre><code class="language-java">String url = response.encodeRedirectURL(&quot;home&quot;);
response.sendRedirect(url);
</code></pre>
<p>So, even though the client won't store the cookies, the request can still be sent with the <code>jsessionid</code>. In addition, we also would like to rewrite the hyperlinks on JSP pages:</p>
<pre><code class="language-jsp">&lt;a href=&quot;&lt;%= response.encodeURL(&quot;login&quot;) %&gt;&quot;&gt;Log in&lt;/a&gt;
</code></pre>
<blockquote>
<p>[!NOTE]
The URL would remain unchanged if cookies are accepted in the browser.</p>
</blockquote>
<h2 id="session-listener"><a class="header" href="#session-listener">Session listener</a></h2>
<p>In <a href="ch4/ch4/4.2">Section 4.2</a>, we introduce <em>listeners</em> which are able to get notified when some event happens, and in this subsection, we are going to study one application of <code>HttpSessionListener</code>: <strong>count how many people are online</strong>.</p>
<blockquote>
<p>Implementations of this interface are notified of changes to the list of active sessions in a web application.</p>
</blockquote>
<p>Of course, here <em>people</em> are not strictly people in the physical world, because we assume that one session is one people. So if you access this web application using different web browsers, or in <em>Private Window</em>, then the listener would consider them as <em>different</em> people. The complete code is found at <code>ch4/session2</code>.</p>
<pre><code class="language-java">@WebListener
public class SessionListener implements HttpSessionListener
</code></pre>
<p>We can maintain a static member variable in <code>SessionListener</code>[1], and increase it by one in <code>sessionCreated()</code>, and decrease it by one in <code>sessionDestroyed</code>. So far so good, but it has thread-safety issue. One way to avoid the concurrent problem is to use APIs under <code>java.util.concurrent</code>, and <code>java.util.concurrent.atomic.AtomicInteger</code> is int value that may be updated atomically:</p>
<pre><code class="language-java">private static final AtomicInteger COUNT = new AtomicInteger(0);
</code></pre>
<h2 id="session-bind-listener"><a class="header" href="#session-bind-listener">Session bind listener</a></h2>
<p>Based on the last subsection, what about counting how many people log in? We can accomplish this task even if there is no listener. To be specific, we maintain a counter, and then increase it by one when one logs in; decrease it by one when one logs out.</p>
<p>And <code>HttpSessionBindingListener</code> provides another solution to this problem:</p>
<blockquote>
<p>Causes an object to be notified when it is bound to or unbound from a session.</p>
</blockquote>
<p>This interface has two APIs:</p>
<ul>
<li><code>valueBound()</code>: This object is added (bounded) to a session.</li>
<li><code>valueUnbound()</code>: This object is removed (unbound) from a session.</li>
</ul>
<p>For example, <code>ActiveUser</code> is a class containing a logged user's name and age. And then she logs in, we add a <code>ActiveUser</code> object into attributes in session's scope; and when she logs out, we remove the attribute.</p>
<pre><code class="language-java">class ActiveUser {
    private String name;
    private int age;
}
</code></pre>
<p>To let <code>ActiveUser</code> listen to the bounding event, this class shall implement <code>HttpSessionBindingListener</code>. So it can find out when it is put into (or taken out from) a session. It won't tell <code>ActiveUser</code> anything about other session events. </p>
<pre><code class="language-java">class ActiveUser implements HttpSessionBindingListener 
</code></pre>
<p>Then we should override the <code>valueBound()</code> and <code>valueUnbound()</code> method for it. The complete code can be found <code>ch4/session2</code>. With <code>HttpSessionBindingListener</code>, we do not have to concern about the counter changing when the user logs in or logs out, and this simplifies our workload at some extent.</p>
<hr />
<p>[1] The key point is to maintain a variable that can be accessed globally. Static variable is a good choice, and attribute in <em>context</em> scope is also fine.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-3"><a class="header" href="#exercise-3">Exercise</a></h1>
<p><strong>4.1</strong>. Put you email address and phone number in DD as init-parameters, and then output them in the servlet.</p>
<hr />
<p><strong>4.2</strong>. Use annotations to solve Exercise 4.1.</p>
<hr />
<p><strong>4.3</strong>. We can use init parameters as the default parameters for requests. For example, we expect that user would submit a form with his <em>name</em> and <em>city</em>, but the <em>city</em> is optional. So in the servlet, we shall assign a default value for city, let's say <em>Chengdu</em>, if it is empty. Because we don't like hard coding, we could consider default values as init parameters.</p>
<p>Please implement the code in a servlet.</p>
<hr />
<p><strong>4.4</strong>. Based on Exercise 4.3, the optional parameters can be more than one (<em>city</em>, <em>gender</em>, <em>occupation</em>), so we can design a method in the servlet to reduce duplicates. Assume all parameters are strings.</p>
<pre><code class="language-java">private String getRequestParameter(
      HttpServletRequest request, 
      String name) {
}
</code></pre>
<p>Please implement the method above.</p>
<hr />
<p><strong>4.5</strong>. In <code>LogListener.java</code> (<code>FileLogListener.java</code>) of <code>ch4/listener</code>, the path of log file is hard-coded. Please set its path to an init parameter.</p>
<hr />
<p><strong>4.6</strong>. Will the container create a session for the mini mvc project (<code>ch2/mini-mvc</code>)? Hint: you can inspect the <code>Network</code> in <em>InPrivate Window</em>.</p>
<hr />
<p><strong>4.7</strong>. Please try to answer the question in <a href="ch4/ch4/4.3">Section 4.3</a>: Under what conditions is a JSESSIONID created?</p>
<hr />
<p><strong>4.8</strong>. Use <code>isNew()</code> method of <code>HttpSession</code> to refactor <code>HelloServlet.java</code> of <code>ch4/session</code>.</p>
<hr />
<p><strong>4.9</strong>. Try to disable the cookies for your web browser, and then run <code>HelloServlet.java</code> of <code>ch4/session</code>.</p>
<hr />
<p><strong>4.10</strong>. Try to figure out what the default max inactive interval of <code>HttpSession</code> is.</p>
<hr />
<p><strong>4.11</strong>. What if you use a session after it is killed?</p>
<pre><code class="language-java">session.invalidate(); // or `session.setMaxInactiveInterval(0)`;
String foo = (String) session.getAttribute(&quot;foo&quot;);
</code></pre>
<hr />
<p><strong>4.12</strong>. What is the max age of the <em>JSESSIONID</em> cookie?</p>
<hr />
<p><strong>4.13</strong>. Implement <em>log in</em> for <code>ch4/cookie</code>.</p>
<hr />
<p><strong>4.14</strong>. Design a shopping chart for the book-selling website. To be specific, users can view books in the home page, and she can pick up books to adding into the shopping cart. She can also view details in her shopping cart. </p>
<ul>
<li>Hint: Use <em>Session</em>.</li>
<li>Optional: The books in the home page can also be loaded by the attribute of a request.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-5-jsp-and-scriptless-jsp"><a class="header" href="#chapter-5-jsp-and-scriptless-jsp">Chapter 5: JSP And Scriptless JSP</a></h1>
<p>In this chapter, we will focus on JSP. In previous chapters, we have used JSP for many times. In particular, JSP mainly works as a view. Basically, an inaccurate definition of JSP can be <em>an HTML page enhanced by Java</em>. The following code is from <code>home.jsp</code>:</p>
<pre><code class="language-jsp">&lt;h1&gt;Cover your page.&lt;/h1&gt;
&lt;%
String name = (String) request.getAttribute(&quot;name&quot;);
%&gt;
&lt;p class=&quot;lead&quot;&gt;Hello &lt;%= name %&gt;&lt;/p&gt;
</code></pre>
<p>As we can see, JSP can combine HTML tags and regular Java code, as well as its extending syntax (e.g., JSP expression tag). Although you can do many things in JSP, keep in mind that <strong>the right role of JSP is just being a view</strong>, nothing more. So importantly, you will learn what <em>not</em> to write in JSP. To put it in another way, there are <em>good</em>, <em>bad</em> and <em>ugly</em> in JSP[1], and we only need to concentrate on the <em>good</em>. For example, writing Java code in JSP is considered <em>bad</em>, so scriptless JSP using tag expressions is preferred.</p>
<p>As a matter of fact, a JSP is also a servlet, and the container would translate it into Java source code, and complies it into a full-fledged Java servlet class. Sound a bit complicate, right? Those abstruse parts are <em>bad</em> and <em>ugly</em>, so it is okay to ignore them.</p>
<blockquote>
<p>[!TIP]
Learning JSP is somewhat in vain, so we only study its <em>good</em> parts.</p>
</blockquote>
<p>Currently, JSP is generally considered obsolete, and many modern alternatives (e.g., <a href="https://www.thymeleaf.org">Thymeleaf</a>) become incredibly popular. However, there are still some reasons to learn it in 2022:</p>
<ul>
<li>Understanding JSP's <em>good</em> part will help you learn other alternatives.</li>
<li>JSP is a part of Java EE, while other alternatives are third parties.</li>
<li>You may have to maintain some legacy projects which are written in JSP.</li>
</ul>
<hr />
<p>[1] <em>The Good, the Bad and the Ugly</em> is a 1966 Italian epic spaghetti Western film directed by Sergio Leone.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="51-facts-about-jsp"><a class="header" href="#51-facts-about-jsp">5.1 Facts About JSP</a></h1>
<p>In this section, we will learn the basic facts about JSP. </p>
<blockquote>
<p>[!NOTE]
The JSP eventually becomes a full-fledged servlet running in your web application[1]. </p>
</blockquote>
<h2 id="jsp-element-types-1"><a class="header" href="#jsp-element-types-1">JSP element types (1)</a></h2>
<p>The regular old Java code in JSP is within <code>&lt;%  %&gt;</code> tag is called <strong>scriptlet</strong>. Recall the <code>result.jsp</code>, the importing statement is within <code>&lt;%@  %&gt;</code> tag is called <strong>directive</strong>. The <strong>expression</strong> within <code>&lt;%= &gt;</code> is a shorthand for <code>out.println()</code>. Note that there is no semicolon <em>;</em> in JSP expression. </p>
<pre><code class="language-jsp">&lt;%@ page import=&quot;java.util.List&quot; %&gt;
&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;%
    List&lt;String&gt; books = (List&lt;String&gt;) request.getAttribute(&quot;books&quot;);
    for (String b : books) {
%&gt;
&lt;%= b %&gt;&lt;br&gt;
&lt;% } %&gt;
</code></pre>
<p>What about <code>page</code>? You can simply understand it as the directive's scope. For example, <code>&lt;%@ page import=&quot;java.util.List&quot; %&gt;</code> means importing <code>java.util.List</code> to current JSP <em>page</em>.</p>
<p>By the way, we can also put comments in the JSP:</p>
<pre><code class="language-jsp">&lt;!-- This is an HTML comment. --&gt;
&lt;%-- This is a JSP comment. --%&gt;
</code></pre>
<h2 id="implicit-objects"><a class="header" href="#implicit-objects">Implicit objects</a></h2>
<p>We have used <code>request</code> and <code>out</code> in JSP, and they are indeed <em>implicit</em> objects. For example, the <em>request</em> is a reference to the <code>HttpServletRequest</code> object. The following table summarizes some important mapping from APIs to implicit objects.</p>
<table><thead><tr><th>API</th><th>Implicit Object</th></tr></thead><tbody>
<tr><td>JspWriter[2]</td><td>out</td></tr>
<tr><td>HttpServletRequest</td><td>request</td></tr>
<tr><td>HttpServletResponse</td><td>response</td></tr>
<tr><td>HttpSession</td><td>session</td></tr>
<tr><td>ServletContext</td><td>application</td></tr>
<tr><td>ServletConfig</td><td>config</td></tr>
</tbody></table>
<p>The following JSP is able to get the attribute from a session, and you can try to output it in <code>ch3/session</code>.</p>
<pre><code class="language-jsp">&lt;% String name = (String) session.getAttribute(&quot;name&quot;); %&gt;
</code></pre>
<h2 id="expression-language"><a class="header" href="#expression-language">Expression Language</a></h2>
<p>Scriptlets are considered <em>bad</em> and <em>ugly</em>. There are two big complaints about putting Java code into a JSP:</p>
<ul>
<li><strong>Web page designers and front-end developers should not have to know Java</strong>.</li>
<li><strong>Java code in a JSP is hard to change and maintain</strong>.</li>
</ul>
<p>To solve this problem, <strong>expression language</strong> (EL for short) is designed to get rid of Java code. An EL always looks like this: <code>${something}</code>. In other words, the expression always enclosed in curly braces, and prefixed with a dollar (<em>$</em>) sign. EL is the base of scriptless JSP.</p>
<p>Let's study how to use EL by an example. First, a <code>Book</code> class contains the title and price:</p>
<pre><code class="language-java">public class Book {
    private String title;
    private float price;
    ...
}
</code></pre>
<p>And a <code>User</code> has a favorite book:</p>
<pre><code class="language-java">public class User {
    private String name;
    private int age;
    private Book favourite;
    ...
}
</code></pre>
<p>Then in <code>HelloServlet.java</code> of <code>ch5/el</code>, we add an attribute into <em>request</em> scope. Finally, we forward this request.</p>
<pre><code class="language-java">Book book = new Book(&quot;Gone with the wind&quot;, 42.0f);
User user = new User(&quot;Mary&quot;, 18, book);
request.setAttribute(&quot;user&quot;, user);
request.setAttribute(&quot;name&quot;, &quot;Mary&quot;);
request.getRequestDispatcher(&quot;/WEB-INF/home.jsp&quot;).forward(request, response);
</code></pre>
<p>Without EL, in order to get data from request's attribute, we have to use <em>scriptlet</em>:</p>
<pre><code class="language-jsp">&lt;%
    String name = (String) request.getAttribute(&quot;name&quot;);
    User user = (User) request.getAttribute(&quot;user&quot;);
%&gt;
&lt;%= name %&gt;
&lt;%= user.getName() %&gt;
</code></pre>
<p>But with EL, it can be simplified dramatically:</p>
<pre><code class="language-jsp">${name}
${user.name}
</code></pre>
<p>Similarly, we can even get the price of this user's favorite book:</p>
<pre><code class="language-jsp">${user.favourite.price}
</code></pre>
<p>EL makes it easy to print nested properties. Elegant, isn't it? In the next chapter, we will try to deconstruct EL.</p>
<h2 id="jsp-element-types-2"><a class="header" href="#jsp-element-types-2">JSP element types (2)</a></h2>
<p>There are five different scripting elements in JSPs, and we have learned four of them in the start of this chapter. Since the <em>declaration</em> element is considered <em>bad</em> and <em>ugly</em>, we won't discuss it.</p>
<ul>
<li><strong>Comment</strong>: &lt;%--  --%&gt;</li>
<li><strong>Directive</strong>: &lt;%@  %&gt;</li>
<li><strong>Declaration</strong>: &lt;%!  %&gt;</li>
<li><strong>Scriptlet</strong>: &lt;%  %&gt;</li>
<li><strong>Expression</strong>: &lt;%=  %&gt;</li>
</ul>
<p>In what follows, we will study the <em>directive</em> element in depth. Directives supply directions and messages to a JSP container, and these special instructions are used for translating JSP to servlet code. The syntax of <em>directives</em> looks like:</p>
<pre><code class="language-java">&lt;%@ directive attribute=&quot;&quot; %&gt;
</code></pre>
<p>There are 3 types of directives: <em>page</em> directive, <em>include</em> directive, and <em>taglib</em> directive. </p>
<p>We have seen the usage of <em>page</em> already. It is used for defining attributes that can be applied to a complete JSP page. In daily programming, <code>import</code> and <code>contentType</code>.</p>
<p>The <em>include</em> directive is used to include one file in another JSP file at translation time[3]. This includes HTML, JSP, text, and other files. It is used to create templates for common UI components, such as headers, footers, and sidebars. For example, <code>footer.html</code> is a sticky footer adapted from <a href="https://getbootstrap.com/docs/5.1/examples/sticky-footer/">Bootstrap</a>:</p>
<pre><code class="language-html">&lt;footer class=&quot;footer mt-auto py-3 bg-light&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;span class=&quot;text-muted&quot;&gt;Head First Java Web.&lt;/span&gt;
    &lt;/div&gt;
&lt;/footer&gt;
</code></pre>
<p>And then we can include it in JSPs:</p>
<pre><code class="language-jsp">&lt;%@ include file=&quot;foot.html&quot; %&gt;
</code></pre>
<p>The JSP <em>taglib</em> directive is implemented to define a tag library with &quot;taglib&quot; as its prefix, and we will learn how to use it in <a href="ch5/ch5/5.3">Section 5.3</a>.</p>
<h2 id="one-more-thing"><a class="header" href="#one-more-thing">One more thing</a></h2>
<p>As we mentioned above, all JSP code will be translated into Servlet code, and this step is done by the container. So, even if there are some mistakes or errors in JSP, they can only be found in the runtime. In addition, your IDA may not be aware of some APIs belonging to <code>javax.servlet.jsp.*</code> (e.g, the implicit object <code>out</code>). For example, your IDE could complain that </p>
<blockquote>
<p>Cannot resolve method println(java.lang.String)</p>
</blockquote>
<pre><code class="language-jsp">&lt;%
out.println(&quot;hello world&quot;);
%&gt;
</code></pre>
<p>But, this <em>error</em> will not cause any bother. If you want to enable the IDE understand those APIs, you can add dependency <code>jsp-api</code>:</p>
<pre><code class="language-groovy">compileOnly('javax.servlet.jsp:javax.servlet.jsp-api:2.3.3') {
    exclude group: 'javax.el', module: 'el-api'
    exclude group: 'javax.servlet', module: 'servlet-api'
}
</code></pre>
<p>Note that this dependency is totally optional. After all, JSP is an obsolete technology, and we will never focus on its details.</p>
<hr />
<p>[1] The translated <code>.java</code> and complied <code>.class</code> can be found at <code>work/Catalina</code> folder of Tomcat home under package <code>org.apache.org</code>.</p>
<p>[2] <code>JspWriter</code> is not <code>PrintWriter</code>, but it has most of the same print methods.</p>
<p>[3] The <code>include</code> action tag includes the file at runtime, but we will not cover action tags in this book.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="52-expression-language"><a class="header" href="#52-expression-language">5.2 Expression Language</a></h1>
<p>EL is always within curly braces, and prefixed with dollar sign. In this chapter, we will study its syntax in depth.</p>
<h2 id="anatomy-of-el"><a class="header" href="#anatomy-of-el">Anatomy of EL</a></h2>
<p><img src="ch5/image/ch5-el-1.png" alt="Figure 5.1 EL's first thing." title=":size=50%" /></p>
<p>The first named variable in EL is either an <em>implicit object</em> or an <em>attribute</em>[1]. As for EL implicit objects, except for <code>pageContext</code> (not shown in the Fig 5.1), they are essentially <em>Map</em> objects (<code>java.util.Map</code>)[2]. Note that they are not the same as the JSP implicit objects.</p>
<pre><code class="language-jsp">${requestScope.name}
${requestScope.user.name}
</code></pre>
<blockquote>
<p>[!TIP]
The <code>requestScope</code> is not the <em>request</em> object; we can only use it to get request <em>attributes</em>. So are other <code>xxxScope</code> implicit objects.</p>
</blockquote>
<p>Since attributes are most commonly used, we mainly focus on attributes, which can be the names of attributes stored in any of the four available scopes. Another question: why can <code>${user.name}</code> get the <em>name</em> of a user? The dot (<em>.</em>) operator is used to access properties and map values. <strong>If the expression has a variable followed by a dot, the left-hand variable must be a <em>map</em> or a <em>bean</em></strong>.</p>
<p><img src="ch5/image/ch5-el-2.png" alt="Figure 5.2 EL: map or bean." title=":size=40%" /></p>
<p>So is <code>user</code> a bean? Yes, but it is not the one that can be cooked. <em>Bean</em> is a class that encapsulates one or more objects into a single standardized object. For example, <code>Book</code> encapsulates <em>title</em> (<code>String</code>) and <em>price</em> (<code>float</code>), and <code>User</code> encapsulates <em>name</em> (<code>String</code>), <em>age</em> (<code>int</code>), and favorite book (<code>Book</code>). This standardization allows the beans to be handled in a more generic fashion, allowing easier code reuse and introspection. Java beans generally will not contain any business logic rather those are used for holding some data in it, and their holding data are often called <strong>properties</strong>.</p>
<p>Java Bean is an important concept on the Java Platform, and we expect beans will obey some conventions[3]:</p>
<blockquote>
<p>As part of the standardization, all beans must be serializable, have a zero-argument constructor, and allow access to properties using getter and setter methods.</p>
</blockquote>
<p>So, strictly speaking, neither <code>User</code> nor <code>Book</code> is a Java bean. Note that those conventions (e.g., implementing <code>Serializable</code>) are always not per se mandatory, but very useful sometimes. Back to EL, <code>${user.name}</code> works because 1) <code>user</code> is the name of an attribute, 2) and its value <code>User</code> is a Java bean, 3) and <code>User</code> has <code>getName()</code> and <code>setName()</code> method[4].</p>
<p>By the way, <code>${user.name}</code> works because we assume that there is only one attribute named <em>user</em> in four scopes. If there may be a conflict, you can restrict its scope explicitly, such as <code>${requestScope.user.name}</code>, <code>${sessionScope.user.name}</code>.</p>
<h2 id="more-powerful--operator"><a class="header" href="#more-powerful--operator">More powerful [] operator</a></h2>
<p>The dot operator works only when the thing on the right is a bean property or map key for the thing on the left. That's it. But the <em>[]</em> operator is a lot more powerful and flexible.</p>
<pre><code class="language-jsp">${user[&quot;name&quot;]}
${user.name}
</code></pre>
<p>The two lines of code are identical, but [] is better because it gives you more options: the thing on the left can also be a <em>List</em> or an array. That also means the thing on the right can be a number, or anything that resolves to a number, or an identifier that doesn't fit the Java naming rules. For example, you might have a Map key in the name &quot;com.swufe.javaee&quot;.</p>
<p><img src="ch5/image/ch5-el-3.png" alt="Figure 5.3 EL with [] operator." title=":size=50%" /></p>
<blockquote>
<p>[!TIP]
For beans and Maps, you can use either dot operator or bracket operator[5].</p>
</blockquote>
<p>The following is an example using the [] operator with an array.</p>
<p>In <code>BookServlet.java</code>,</p>
<pre><code class="language-java">String[] books = {&quot;Gone with the Wind&quot;, &quot;The Great Gatsby&quot;,
        &quot;1587, a Year of No Significance&quot;};
request.setAttribute(&quot;bookArray&quot;, books);
request.getRequestDispatcher(&quot;/WEB-INF/book.jsp&quot;).forward(request, response);
</code></pre>
<p>In <code>book.jsp</code>,</p>
<pre><code class="language-jsp">${bookArray[0]}
</code></pre>
<p>It even works when the index is a String literal, and the index is coerced to an int: <code>${bookArray[&quot;0&quot;]</code>.</p>
<p>We can also use <strong>nested expressions inside the brackets</strong>. Based on the previous example, we add a <code>HashMap</code> to count books:</p>
<pre><code class="language-java">Map&lt;String, Integer&gt; bookCount = new HashMap&lt;&gt;();
bookCount.put(&quot;Gone with the Wind&quot;, 42);
bookCount.put(&quot;The Great Gatsby&quot;, 100);
bookCount.put(&quot;1587, a Year of No Significance&quot;, 130);
request.setAttribute(&quot;bookCount&quot;, bookCount);
</code></pre>
<p>And in JSP, <code>${bookCount[bookArray[0]]}</code> will output 42.</p>
<p><img src="ch5/image/ch5-el-4.png" alt="Figure 5.4 Nested [] operators." title=":size=40%" /></p>
<h2 id="handy-el-operators"><a class="header" href="#handy-el-operators">Handy EL operators</a></h2>
<p>You shouldn't do calculations and logic from EL. Remember, a JSP is the View, and the View’s job is to render the response, not to make Big Important Decisions or do Big Processing. But, sometimes a little arithmetic or a simple boolean test might come in handy. So, with that perspective, here's a look at the most useful EL arithmetic, relational, and logical operators.</p>
<ul>
<li><strong>Arithmetic</strong>: +, -, *, / (div), % (mod)</li>
<li><strong>Logical</strong>: &amp;&amp; (and), || (or), ! (not)</li>
<li><strong>Relational</strong>: == (eq), != (ne), &lt; (lt), &gt; (gt), &lt;= (le), &gt;= (ge)</li>
</ul>
<p>In <code>Operator.java</code> of <code>ch5/el</code>:</p>
<pre><code class="language-java">String num = &quot;42&quot;;
request.setAttribute(&quot;num&quot;, num);
int i = 43;
request.setAttribute(&quot;integer&quot;, i);
request.getRequestDispatcher(&quot;/WEB-INF/operator.jsp&quot;).forward(request, response);
</code></pre>
<p>And in <code>operator.jsp</code>:</p>
<pre><code class="language-jsp">${integer + 2}
${integer le 12}
${integer &gt; 12}
${num &gt; 43}
${42 div 0}
</code></pre>
<p>The code above will output</p>
<ul>
<li>45</li>
<li>false</li>
<li>true</li>
<li>false</li>
<li>Infinity</li>
</ul>
<p>Note that in <code>${num &gt; 43}</code>, the &quot;num&quot; attribute was found, and its value &quot;2&quot; coerced to an int. You can divide by zero in EL, and you will get an <code>INFINITY</code>, not an error[6].</p>
<h2 id="a-final-note-about-java-beans"><a class="header" href="#a-final-note-about-java-beans">A final note about Java beans</a></h2>
<p>People sometimes get confused about POJO and Java bean[7]. </p>
<p>POJO stands for Plain Old Java Object. It is an ordinary Java object, not bound by any special restriction other than those forced by the Java Language Specification and not requiring any classpath. POJOs are used for increasing the readability and re-usability of a program. POJOs have gained the most acceptance because they are easy to write and understand. Both <code>User</code> and <code>Book</code> are POJOs.</p>
<p><strong>Beans are special type of POJOs</strong>. There are some restrictions on POJO to be a bean.</p>
<ul>
<li>It should implement serializable interface.</li>
<li>Fields are accessed only by getters and setters.</li>
<li>Fields have only private visibility.</li>
<li>It must have a no-arg constructor.</li>
</ul>
<p>Again, not all the patterns are absolute requirements. For example, the minimal requirement of a Java bean in EL is the getter and setter methods.</p>
<hr />
<p>[1] The dot is not always needed. The dot operator is used to access properties and map values. By the way, we can also get other information like <em>parameters</em>, <em>cookies</em> using EL, but that is considered <em>bad</em>.</p>
<p>[2] <em>Map</em> is an object that maps keys (names) to values.</p>
<p>[3] https://en.wikipedia.org/wiki/JavaBeans</p>
<p>[4] The thing on the left of dot operator must follow normal Java naming rules for identifiers. For example, it must start with a letter, _, or $.</p>
<p>[5] When using dot operators for Maps, the <em>names</em> (<em>keys</em>) should be valid Java identifiers.</p>
<p>[6] However, you cannot use the remainder operator (<code>%</code> or <code>mod</code>) against a zero.</p>
<p>[7] https://stackoverflow.com/questions/1612334/</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="53-jstl"><a class="header" href="#53-jstl">5.3 JSTL</a></h1>
<p>EL saves the day by beautifully simplifying the JSP, but sometimes we need more than it. For example, can you express <code>if</code> or <code>for</code> in EL? The answer is no. To this end, custom tags are designed. They look like HTML tags, but they can help you express logics (e.g., <code>if</code> and <code>for</code>) while getting away from scripting. Even better, the community has already written a pile of tags you're most likely to need, and bundled then into the JSP Standard Tag Library (JSTL).</p>
<h2 id="how-to-install-jstl"><a class="header" href="#how-to-install-jstl">How to install JSTL</a></h2>
<p>JSTL is not part of the JSP specification[1], so we have to download both its API and implementation in our project. However, the latest version of JSTL in <code>javax</code> namespace is <em>1.2.2</em>, and it depends on <code>servlet-api:2.5</code>, <code>el-api:2.2</code> and <code>jsp-api:2.2</code>. So there may be packages version conflicts problems. To solve those conflicts, we shall exclude them in the dependency:</p>
<pre><code class="language-groovy">implementation('org.glassfish.web:javax.servlet.jsp.jstl:1.2.5') {
    exclude group: 'javax.el', module: 'el-api'
    exclude group: 'javax.servlet', module: 'servlet-api'
    exclude group: 'javax.servlet.jsp', module: 'jsp-api'
}
</code></pre>
<p>Then in the JSP file, we add the <em>taglib</em> directive:</p>
<pre><code class="language-java">&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
</code></pre>
<p>Where <code>prefix</code> is a customized prefix name, and you can use other names if you like; you can think of <code>uri</code> as an address or a namespace, which looks like a URL. It must start with <em>http://java.sun.com/jsp/jstl</em> in JSTL 1.2, and <code>core</code> is one of tag libraries[2].</p>
<h2 id="jstl-examples"><a class="header" href="#jstl-examples">JSTL examples</a></h2>
<p>In this subsection, we will learn how to use JSTL through examples, and the code can be found at <code>ch5/jstl</code>.</p>
<blockquote>
<p>[!NOTE]
Similar to HTML tags, different tags in JSTL have different <em>attributes</em>, and some are optional while some are required.</p>
</blockquote>
<p>Suppose <code>foo</code> is not the attribute's name, then <code>${foo}</code> won't output anything. But if we would like to output a default value when it is empty:</p>
<pre><code class="language-jsp">&lt;c:out value=&quot;${user}&quot; default=&quot;Guest&quot;/&gt;
</code></pre>
<p>Where <code>&lt;c:out&gt;</code> is a tag defined in JSTL, and <code>c</code> is the prefix we defined in the <em>taglib</em> directive.</p>
<p>Suppose an array is put into the attribute,</p>
<pre><code class="language-java">String[] books = {&quot;Gone with the Wind&quot;, &quot;The Great Gatsby&quot;,
        &quot;1587, a Year of No Significance&quot;};
request.setAttribute(&quot;bookArray&quot;, books);
</code></pre>
<p>Let's iterate an array in the attribute.</p>
<pre><code class="language-jsp">&lt;c:forEach var=&quot;book&quot; items=&quot;${bookArray}&quot;&gt;
    ${book}
&lt;/c:forEach&gt;
</code></pre>
<p><img src="ch5/image/ch5-foreach.png" alt="Figure 5.5 The forEach tag." title=":size=50%" /></p>
<p>As we see, <code>&lt;c:forEach&gt;</code> can replace <code>for</code> in the scriptlet.</p>
<p><code>&lt;c:if&gt;</code> is able to replace <code>if</code>:</p>
<pre><code class="language-jsp">&lt;c:if test=&quot;${balance &gt; 88}&quot;&gt;
    You are rich.
&lt;/c:if&gt;
</code></pre>
<p>Where <code>test</code> attribute accepts a boolean value. Note that if we use a String literal, it should be enclosed with the single quote. </p>
<pre><code class="language-jsp">&lt;c:if test=&quot;${name == 'Mary'}&quot;&gt;
    You are Mary.
&lt;/c:if&gt;
</code></pre>
<p>However, <code>&lt;c:if&gt;</code> tag cannot express <code>else</code>. If you would like to express <code>if...else</code>, you can use <code>&lt;c:choose&gt;</code> tag:</p>
<pre><code class="language-jsp">&lt;c:choose&gt;
    &lt;c:when test=&quot;${balance &gt; 88}&quot;&gt;
        You are rich.
    &lt;/c:when&gt;
    &lt;c:otherwise&gt;
        You are poor.
    &lt;/c:otherwise&gt;
&lt;/c:choose&gt;
</code></pre>
<p>There are a plenty of tags defined in JSTL, but basically, <code>&lt;c:forEach&gt;</code>, <code>c:if&gt;</code> and <code>&lt;c:choose&gt;</code> can cover most of your daily programming tasks.</p>
<p>As a final example, let's try to iterate a <em>Map</em>.</p>
<pre><code class="language-java">Map&lt;String, Integer&gt; bookCount = new HashMap&lt;&gt;();
bookCount.put(&quot;Gone with the Wind&quot;, 42);
bookCount.put(&quot;The Great Gatsby&quot;, 100);
bookCount.put(&quot;1587, a Year of No Significance&quot;, 130);
request.setAttribute(&quot;bookCount&quot;, bookCount);
</code></pre>
<pre><code class="language-jsp">&lt;c:forEach var=&quot;book&quot; items=&quot;${bookCount}&quot;&gt;
    ${book.key}
    ${book.value}
&lt;/c:forEach&gt;
</code></pre>
<hr />
<p>[1] In the book, we use Java EE 8 with <code>servlet-api:4.0.1</code>, <code>el-api:3.0.0</code> and <code>jsp-api:2.3.3</code>, and both <em>APIs</em> and <em>implementations</em> are provided by the container. See more at <a href="https://tomcat.apache.org/whichversion.html">Apache Tomcat Versions</a>.</p>
<p>[2] There are other tag libraries, such as <code>fmt</code> and <code>sql</code>. It is a convention to use <code>c</code> as the prefix for <code>core</code> tag library. You can even write you own tags, but this is also considered <em>bad</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-4"><a class="header" href="#exercise-4">Exercise</a></h1>
<p><strong>5.1</strong>. Use EL and JSTL to refactor mini MVC project in Chapter 2.</p>
<hr />
<p><strong>5.2</strong> EL is null-friendly. If there is not an attribute named &quot;foo&quot;, what will the following output?</p>
<pre><code class="language-jsp">${foo}
${7 + foo}
${7 &lt; foo}
${7 == foo}
${7 != foo}
${true and foo}
${not foo}
</code></pre>
<p>If there is an attribute named &quot;bar&quot;, but that &quot;bar&quot; does not have a property or key named &quot;foo&quot;, what will the following output?</p>
<pre><code class="language-jsp">${bar[foo]}
${bar.foo}
${foo.bar}
</code></pre>
<p>Do you have any conclusion based on the output above?</p>
<hr />
<p><strong>5.3</strong>. How to iterate nested arrays or lists using JSTL?</p>
<pre><code class="language-java">List&lt;String&gt; programmings = Arrays.asList(&quot;C&quot;, &quot;C++&quot;, &quot;Java&quot;, &quot;Python&quot;);
List&lt;String&gt; sports = Arrays.asList(&quot;Running&quot;, &quot;Basketball&quot;, &quot;Football&quot;);
List&lt;List&lt;String&gt;&gt; skills = new ArrayList&lt;&gt;();
skills.add(programmings);
skills.add(sports);
request.setAttribute(&quot;skills&quot;, skills);
</code></pre>
<hr />
<p><strong>5.4</strong>. What does <code>varStatus</code> means in <code>&lt;c:forEach&gt;</code> tag?</p>
<pre><code class="language-jsp">&lt;c:forEach var=&quot;book&quot; items=&quot;${bookArray}&quot; varStatus=&quot;idx&quot;&gt;
&lt;/c:forEach&gt;
</code></pre>
<hr />
<p><strong>5.5</strong>. Develop a book-selling website.</p>
<ul>
<li>Users can log in, and log out.</li>
<li>Users information is kept in a file, including <em>name</em>, <em>password</em>, and <em>card</em>.</li>
<li>Books information (including <em>ISBN</em>, <em>title</em>, <em>author</em>, <em>cover image</em>, <em>description</em>, and <em>price</em>) are stored in the models.</li>
<li>Users who do not log in can only view books.</li>
<li>Users who have logged in can add books into, and remove books from their shopping carts.</li>
<li>Users can check out their shopping carts by inputting the card number. The website shall display the total price.</li>
</ul>
<p>In this exercise, both users and books are considered <em>static</em>. Hint: Users and books information can be stored in attributes of <em>context</em> scope for global sharing.</p>
<hr />
<p><strong>5.6</strong>. Based on Exercise 5.5, here are more requirements:</p>
<ul>
<li>There is an admin, whose <em>name</em> and <em>password</em> are stored in the init parameters.</li>
<li>A book has the <em>quantity</em> property, and users' purchases can decrease it.</li>
<li>Admin can add new books.</li>
</ul>
<p>Note that it is fine to ignore the thread-safety issue in this exercise.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-6-database"><a class="header" href="#chapter-6-database">Chapter 6: Database</a></h1>
<p>The central aspect of an application is usually the data themselves. For example, a book-selling website's most valuable asset is its data on books and users. Previously, we store these data in either code or files, and they would be loaded into memory at runtime. It is clear that pure in-memory based storage has many pitfalls. For example,</p>
<ul>
<li>Data would be lost when the system shuts down.</li>
<li>It is very difficult to support multiple users at the same time.</li>
<li>Memory cannot hold large size of data.</li>
</ul>
<p>File-based processing system can alleviate partial problems, but it further poses new challenges for programming, such as difficulty in accessing data, data redundancy and inconsistency. Those difficulties, among others, prompted the development of database systems. A primary goal of a database management system (DBMS) is to provide a way to store and retrieve database information that is both <em>convenient</em> and <em>efficient</em>.</p>
<blockquote>
<p>[!NOTE]
Database is one of the core courses in Computer Science, and we can only cover a very small part of it in this book. Readers can refer to other textbooks, such as <a href="https://www.db-book.com/">Database System Concepts</a>, if they wish to learn more about databases.</p>
</blockquote>
<p>In this chapter, we will learn the basic concepts about (relational) database, and especially, how to use database in Java web.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="61-introduction-to-database"><a class="header" href="#61-introduction-to-database">6.1 Introduction To Database</a></h1>
<p>A database, is just a location to store data, and a database management system (DBMS) is a collection of interrelated data and a set of programs to access those data.</p>
<h2 id="data-models"><a class="header" href="#data-models">Data models</a></h2>
<p>For most database applications, we don't have to care about how data is stored physically. Instead, we only need to understand it in a logical view[1], and it is mainly described as a <em>data model</em>.</p>
<blockquote>
<p>A collection of conceptual tools for describing data, data relationships, data semantics, and consistency constraints.</p>
</blockquote>
<p>There are a number of different data models, but in this book, we only focus on <strong>relational model</strong>, which is used in a vast majority of current database system. The relational model uses a collection of tables to represent both data and the relationships among those data. Tables are also known <em>relations</em>. Probably everyone knows what a table is, and you see digital tables in spreadsheet software such as Excel, Google Docs. </p>
<p><img src="ch6/image/excel.png" alt="Figure 6.1 Digital tables." title=":size=50%" /></p>
<p>Each table has multiple columns, and each column has a unique name. Each row of the table represents one piece of information. In general, a row in a table represents a <em>relationship</em> among a set of values. The following presents a sample relational database comprising two tables: one (<code>book</code>) shows details of books, and the other (<code>author</code>) shows details of authors. Note that the order of rows is not important for a relation.</p>
<table><thead><tr><th>ISBN</th><th>title</th><th>author_name</th><th>price</th></tr></thead><tbody>
<tr><td>9780446365383</td><td>Gone with the Wind</td><td>Margaret Mitchell</td><td>7.99</td></tr>
<tr><td>9780743273565</td><td>The Great Gatsby</td><td>F. Scott Fitzgerald</td><td>15.00</td></tr>
<tr><td>9780300028843</td><td>1587, a Year of No Significance</td><td>Ray Huang</td><td>27.00</td></tr>
</tbody></table>
<table><thead><tr><th>name</th><th>birth</th><th>country</th></tr></thead><tbody>
<tr><td>Margaret Mitchell</td><td>1900-11-08</td><td>America</td></tr>
<tr><td>Ray Huang</td><td>1918-06-25</td><td>America</td></tr>
<tr><td>F. Scott Fitzgerald</td><td>1896-09-24</td><td>America</td></tr>
<tr><td>Lu Xun</td><td>1881-09-25</td><td>China</td></tr>
</tbody></table>
<p>A relational database consists of a collection of tables, each of which is assigned a unique name. For example, consider the <code>book</code> table above, which stores information about books. The table has four column headers: <em>ISBN</em>, <em>title</em>, <em>author_name</em>, and <em>price</em>. Each row of this table records information about a book, consisting of the book's <em>ISBN</em>, <em>title</em>, <em>author_name</em>, and <em>price</em>. In the relational model, the term <strong>relation</strong> is used to refer to a table, while the term <strong>tuple</strong> is used to refer to a row. Similarly, the term <strong>attribute</strong> refers to a column of a table.</p>
<h2 id="keys"><a class="header" href="#keys">Keys</a></h2>
<p>To describe how a relation looks like, we use the concept <strong>schema</strong> so that we can investigate relations while ignoring the real data in them. The schema for <code>book</code> is</p>
<pre><code>book(ISBN, title, author_name, price)
</code></pre>
<p>We must have a way to specify how tuples within a given relation are distinguished. This is expressed in terms of their attributes. No two tuples in a relation are allowed to have exactly the same values for all attributes.</p>
<blockquote>
<p>[!TIP]
<strong>TL;DR</strong>. Super keys can uniquely identify a tuple; candidate key is the minimal super key; primary key is the one chosen from candidate keys by programmers.</p>
</blockquote>
<p>A <strong>super key</strong> is a set of one or more attributes, that taken collectively, allow us to identify uniquely a tuple in the relation. For example, the <em>ISBN</em> attribute of the relation <code>book</code> is sufficient to distinguish one book tuple from another. Thus, <em>ISBN</em> is super key. The <em>author</em> attribute, on the other hand, is not a super key, because several books might have the same name. Clearly, if <em>K</em> is a super key, so is any superset of <em>K</em>. We are often interested in super keys for which no proper subset is a super key. Such minimal super keys are called <strong>candidate keys</strong>.</p>
<p>Candidate keys can be more than one. For example, suppose that given an author, all books written by her have different titles. So <em>{author, title}</em> is also a candidate key of <code>book</code>. We use the term <strong>primary key</strong> to denote a candidate key that is chosen by the database designers. Primary key attributes are also underlined: book(<ins>ISBN</ins>, title, author_name, price).</p>
<h2 id="database-systems"><a class="header" href="#database-systems">Database systems</a></h2>
<p>There are a large number of commercial database systems in use today. The major ones include: Oracle, Microsoft SQL Server, and SAP HANA. There are also many free database systems; widely used ones include MySQL, PostgreSQL, and the embedded database SQLite.</p>
<p>In this book, for the ease of installing, we use <em>SQLite</em>. Note that although there are the differences between different databases, and it is almost unlikely to use SQLite for Java web application in the production environment, the basic concepts and practices are the same. So you can easily switch to other alternative database systems without much trouble. Additionally, <em>SQLite</em> is a popular storage choice for Android and iOS applications in mobile devices.</p>
<p>Users can request information from the database using query languages. And the <em>SQL</em> query language is the standard one in relational databases. Individual implementations of SQL may differ in details, and most basic SQL syntaxes are the same.</p>
<blockquote>
<p>[!NOTE]
Many SQL syntaxes in SQLite differ from the standard one. You can refer to <a href="https://www.sqlite.org/quirks.html">Quirks, Caveats, and Gotchas In SQLite</a> for more information.</p>
</blockquote>
<hr />
<p>[1] A major purpose of a database system is to provide users with an <em>abstract</em> view of data.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="62-sql-1"><a class="header" href="#62-sql-1">6.2 SQL (1)</a></h1>
<p>SQL, short of Structured Query Language, has established itself as the standard relational database language. Generally speaking, although SQL is only a small part of database systems, studying SQL would cost most time for undergraduates[1]. In this textbook, we mainly focus two parts of SQL:</p>
<ul>
<li>Data-definition language (<strong>DDL</strong>): defining relation schemas, deleting relations, and modifying relation schemas.</li>
<li>Data-manipulation language (<strong>DML</strong>): querying information from, inserting tuples into, deleting tuples from, and modifying tuples in the database.</li>
</ul>
<p>The term <strong>CRUD</strong>, short for create, read, update, and delete, is often used to describe the database business logics.</p>
<blockquote>
<p>[!NOTE]
SQL is case-insensitive. SQL command ends with a semicolon (<code>;</code>).</p>
</blockquote>
<h2 id="ddl-data-types"><a class="header" href="#ddl-data-types">DDL: data types</a></h2>
<blockquote>
<p>[!TIP]
<strong>TL;DR</strong>. We only use <em>INTEGER</em>, <em>REAL</em>, and <em>TEXT</em> for simplicity, and you can think of it as <code>int</code>, <code>double</code>, and <code>String</code> in Java, respectively.</p>
</blockquote>
<p>When defining relation schemas, we must specify the attributes' data types[2]. The most commonly used data types are listed below:</p>
<ul>
<li><em>char(n)</em>: A fixed length character string with user-specified length <em>n</em>.</li>
<li><em>varchar(n)</em>: A variable-length character string with user-specified maximum length <em>n</em>.</li>
<li><em>int</em>: An integer.</li>
<li><em>numeric(p, d)</em>: A fixed-point number with user-specified precision. For example, <strong>numeric(3, 1)</strong> allows 42.1 to be stored.</li>
<li><em>real</em>, <em>double precision</em>: Floating-point and double precision floating point numbers.</li>
<li><em>float(n)</em>: A floating-point number with precision of at least <em>n</em> digits.</li>
</ul>
<p>But each value stored in an SQLite database (or manipulated by the database engine) has one of the following storage classes:</p>
<ul>
<li>INTEGER</li>
<li>REAL</li>
<li>TEXT</li>
<li>BLOB</li>
<li>NULL</li>
</ul>
<p>So, is SQL written in standard syntaxes not compatible with SQLite? The answer is <em>yes or no</em>. 1) No two SQL database engines work exactly alike, so incompatibility sometimes is avoidable. 2) SQLite supports the concept of <em>type affinity</em> on columns. For example, both <em>char(n)</em> and <em>varchar(n)</em> will convert to affinity type <em>TEXT</em>[3].</p>
<p>SQLite strives to be flexible regarding the datatype of the content that it stores. For example, if a table column has a type of &quot;INTEGER&quot;, then SQLite tries to convert anything inserted into that column into an integer. So an attempt to insert the string '123' results in an integer 123 being inserted. But if the content cannot be losslessly converted into an integer, for example if the input is 'xyz', then the original string is inserted instead.</p>
<p>For the sake of simplicity, in what follows, we only use three data types: <em>INTEGER</em>, <em>REAL</em>, and <em>TEXT</em>. By the way, SQLite does not have a storage class set aside for storing dates and/or times. In this textbook, we use <em>TEXT</em> to store date as ISO8601 strings (<code>YYYY-MM-DD HH:MM:SS.SSS</code>)[4].</p>
<p>We define an SQL relation by using <code>CREATE TABLE</code> command. The following command crates a relation <code>book</code> in the database:</p>
<pre><code class="language-sql">CREATE TABLE book(
    ISBN TEXT PRIMARY KEY,
    title TEXT,
    author_name TEXT,
    price REAL
);
</code></pre>
<p>Since primary key for <code>book</code> consists of a single column (<em>ISBN</em>), the keywords <em>PRIMARY KEY</em> is added to a column definition. Alternatively, it can also be specified as a <strong>table constraint</strong>:</p>
<pre><code class="language-sql">CREATE TABLE book(
    ISBN TEXT,
    title TEXT,
    author_name TEXT,
    price REAL,
    PRIMARY KEY(ISBN)
);
</code></pre>
<p>To remove a relation from an SQL database, we use <code>DROP TABLE</code> command:</p>
<pre><code class="language-sql">DROP TABLE book;
</code></pre>
<h2 id="ddl-constraints"><a class="header" href="#ddl-constraints">DDL: constraints</a></h2>
<p>Besides <em>PRIMARY KEY</em>, we can specify more constraints for relations. For example,</p>
<ul>
<li><strong>NOT NULL</strong>: By default, a column can be a null value. We can add <em>NOT NULL</em> attached to a column definition.</li>
<li><strong>DEFAULT</strong>: The <em>DEFAULT</em> clause specifies a default value to use for the column if no value is explicitly provided by the user when doing an <em>INSERT</em>[5].</li>
<li><strong>UNIQUE</strong>: It is similar to <em>PRIMARY KEY</em>[6].</li>
</ul>
<p>Another important constraint on the contents of relations are called <strong>foreign-key</strong> constraints. Consider the attribute <em>author_name</em> of the <code>book</code> relation. It would not make sense for a tuple in <code>book</code> have a value for <em>author</em> that does not correspond to a name in the <code>author</code> relation. In this case, the attribute <em>author_name</em> in <code>book</code> is a foreign key, referencing <code>author</code>.</p>
<pre><code class="language-sql">CREATE TABLE author(
    name TEXT PRIMARY KEY,
    birth TEXT,
    country TEXT
);
</code></pre>
<p>Suppose every author has a unique name.</p>
<pre><code class="language-sql">CREATE TABLE book(
    ISBN TEXT,
    title TEXT NOT NULL,
    author_name TEXT,
    price REAL DEFAULT 9.9,
    PRIMARY KEY(ISBN),
    FOREIGN KEY(author_name) REFERENCES author(name)
);
</code></pre>
<h2 id="basic-dml"><a class="header" href="#basic-dml">Basic DML</a></h2>
<p>To insert data into a relation, we either specify a tuple to be inserted or write a query whose result is a set of tuples to be inserted. In this book, we only use the simplest form[7]:</p>
<pre><code class="language-sql">INSERT INTO author(name, birth, country) VALUES ('Lu Xun', '1881-09-25', 'China');

INSERT INTO book(ISBN, title, author_name, price)
VALUES ('9781500946654', 'A Madman''s Diary', 'Lu Xun', 10.5);
</code></pre>
<p><code>SELECT</code> command is to issue a query. Let us consider a simple query: &quot;find the names of all in books&quot;,</p>
<pre><code class="language-sql">SELECT title
FROM book;
</code></pre>
<p>The <code>WHERE</code> clause allows us to select only those rows in the result relations of the <code>FROM</code> clause that satisfy a specified predicate. For example, &quot;find the names of books written by Lu Xun&quot;:</p>
<pre><code class="language-sql">SELECT title
FROM book
WHERE author_name = 'Lu Xun';
</code></pre>
<p>SQL allows the use of logical connectives <strong>AND</strong>, <strong>OR</strong> and <strong>NOT</strong> in the <code>WHERE</code> clause. The operands of the logical connectives can be expressions involving the comparison operations, including &lt;, &lt;=, &gt;, &gt;=, =, &lt;&gt;[8]. For example,</p>
<pre><code class="language-sql">SELECT title
FROM book
WHERE author_name = 'Lu Xun' AND price &gt; 20;
</code></pre>
<p>Sometimes, we may want to retrieve all attributes. The asterisk symbol &quot;*&quot; can be used in the <code>SELECT</code> clause to denote &quot;all attributes&quot;[9]:</p>
<pre><code class="language-sql">SELECT *
FROM book;
</code></pre>
<p><code>UPDATE</code> statement can be used if we wish to change a value in a tuple. Suppose we would like to increase the price of the book above by 5 percent,</p>
<pre><code class="language-sql">UPDATE book
SET price = price * 1.05
WHERE ISBN = '9781500946654';
</code></pre>
<p><code>DELETE</code> statement is used to delete tuples. For example, </p>
<pre><code class="language-sql">DELETE FROM book
WHERE ISNB = '9781500946654';
</code></pre>
<p>If the predicate is not given, it means deleting all tuples while keeping the relation itself.</p>
<hr />
<p>[1] This is because most undergraduate database courses only cover the <em>application</em> aspect of the database systems, while the <em>theory</em> aspect is rarely involved. </p>
<p>[2] Different from standard SQL, data types in SQLite are advisory rather than mandatory.</p>
<p>[3] Flexible type is a feature of SQLite, and you don't have to memorize the detailed rules.</p>
<p>[4] https://en.wikipedia.org/wiki/ISO_8601</p>
<p>[5] If there is no explicit <em>DEFAULT</em> clause attached to a column definition, then the default value of the column is NULL.</p>
<p>[6] <em>PRIMARY KEY</em> cannot be NULL in SQL standard, but it can be NULL in SQLite.</p>
<p>[7] String should be enclosed in single quotes in SQL standard, but double-quoted String literals are accepted in SQLite.</p>
<p>[8] Inequality in SQL standard is <code>&lt;&gt;</code>, but most database implementations, including SQLite, also support <code>!=</code>.</p>
<p>[9] <code>SELECT *</code> is considered a bad style in production code.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="63-sql-2"><a class="header" href="#63-sql-2">6.3 SQL (2)</a></h1>
<p>Studying SQL would cost most time for undergraduates in the database course, and <code>SELECT</code> would take more than 90% of time. In this section, we will explore how to use <code>SELECT</code> clause in different contexts. Again, this book is not dedicated to discussing SQL and databases, so only basic syntaxes are covered.</p>
<h2 id="additional-basic-operations"><a class="header" href="#additional-basic-operations">Additional basic operations</a></h2>
<p>The <code>SELECT</code> clause may contain arithmetic expressions involving +, -, *, and /. For example,</p>
<pre><code class="language-sql">SELECT title, price * 0.9
FROM book;
</code></pre>
<p>Pattern matching can be performed on strings using the operator <code>LIKE</code>. We describe patterns by using two special characters:</p>
<ul>
<li>Percent(<code>%</code>): matching any substring</li>
<li>Underscore(<code>_</code>): matching any character</li>
</ul>
<p>For example, for a book's title <em>Gone with the Wind</em>, <code>title LIKE 'Gone%'</code> is true.</p>
<p>To simplify <code>WHERE</code> clauses that specify that a value be less than or equal to some value and greater than to equal to some other value, SQL provides a <code>BETWEEN</code> comparison operator.</p>
<pre><code class="language-sql">SELECT title
FROM book
WHERE price BETWEEN 10 AND 50;
</code></pre>
<p>The <code>ORDER BY</code> clause causes the tuples in the result of a query to appear in sorted order. To list alphabetic order all authors from America, we write:</p>
<pre><code class="language-sql">SELECT *
FROM author
WHERE country = 'America'
ORDER BY name;
</code></pre>
<h2 id="aggregate-functions"><a class="header" href="#aggregate-functions">Aggregate functions</a></h2>
<p>Aggregate functions are functions that take a collection of values as input and return a single value as output. SQL offers five standard built-in aggregate functions:</p>
<ul>
<li>Average: <code>AVG</code></li>
<li>Minimum: <code>MIN</code></li>
<li>Maximum: <code>MAX</code></li>
<li>Total: <code>SUM</code></li>
<li>Count: <code>COUNT</code></li>
</ul>
<p>Consider the query &quot;find the average price of books written by Lu Xun&quot;. We can write the query as follows:</p>
<pre><code class="language-sql">SELECT AVG(price)
FROM book
WHERE author_name = 'Lu Xun';
</code></pre>
<p>We often use <code>COUNT</code> to count the number of tuples in a relation. The notation for this function in SQL is <code>COUNT(*)</code>. Thus, to find how many books written by Lu Xun, we write:</p>
<pre><code class="language-sql">SELECT COUNT(*)
FROM book
WHERE author_name = 'Lu Xun';
</code></pre>
<p>The database system may give an awkward name to the result, and we can give a meaningful name to the attribute by using <code>AS</code> clause as follows:</p>
<pre><code class="language-sql">SELECT COUNT(*) AS books_num
FROM book
WHERE author_name = 'Lu Xun';
</code></pre>
<p>We can use <code>GROUP BY</code> to apply the aggregate functions to a group of sets of tuples[1]. As an illustration, to find the average book price published by each author, we write this query as follows:</p>
<pre><code class="language-sql">SELECT author_name, AVG(price)
FROM book
GROUP BY author_name;
</code></pre>
<p>Note that if <code>GROUP BY</code> is used, then the attributes shown in <code>SELECT</code> clause are either specified in <code>GROUP BY</code> or applied by an aggregate function. Thus, the following SQL is erroneous:</p>
<pre><code class="language-sql">SELECT title, AVG(price)
FROM book
GROUP BY author_name;
</code></pre>
<p>Sometimes, it is useful to state a condition that applies to groups. SQL offers <code>HAVING</code> clause to achieve this query. For example, to find the author whose published books' average price is more than 25:</p>
<pre><code class="language-sql">SELECT author_name
FROM book
GROUP BY author_name
HAVING AVG(price) &gt; 25;
</code></pre>
<h2 id="nested-queries"><a class="header" href="#nested-queries">Nested queries</a></h2>
<p>The <code>IN</code> connective tests for set membership[2]. As an illustration, consider the query &quot;to find the books which were written by Chinese authors&quot;. We can divide this query into two sub queries</p>
<ul>
<li>Find all Chinese authors, donated as <em>A</em></li>
<li>To test if a book's author is a member of <em>A</em>.</li>
</ul>
<pre><code class="language-sql">SELECT *
FROM book
WHERE author IN (SELECT name FROM author WHERE country = 'China');
</code></pre>
<p>The <code>IN</code> operator can also be used on enumerate sets. For example, to find all authors from China and Japan, we can write the query:</p>
<pre><code class="language-sql">SELECT name
FROM author
WHERE country IN ('China', 'Japan');
</code></pre>
<h2 id="queries-on-multiple-relations"><a class="header" href="#queries-on-multiple-relations">Queries on multiple relations</a></h2>
<p>So far our example queries were on a single relation. Queries often need to access information from multiple relations[3]. For example, to retrieve the titles of books, along with their authors and countries, we can write:</p>
<pre><code class="language-sql">SELECT title, author_name, country
FROM book, author
WHERE book.author_name = author.name;
</code></pre>
<hr />
<p>[1] By default, the <code>ORDER BY</code> clause lists items in ascending order. To specify the sort order, we may specify <code>DESC</code> for descending order.</p>
<p>[2] The <code>NOT IN</code> connective tests for absence of set membership.</p>
<p>[3] Join expression is another way to express queries on multiple relations.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="64-accessing-databases-from-java-1"><a class="header" href="#64-accessing-databases-from-java-1">6.4 Accessing Databases From Java (1)</a></h1>
<p>Writing queries in SQL is usually much easier than coding the same queries in a general purpose programming language. However, accessing databases from a general purpose programming language is necessary, because no all queries can be expressed in SQL, and some non-declarative actions cannot be done from within SQL. In this book, we only consider how to access a database using Java.</p>
<h2 id="jdbc"><a class="header" href="#jdbc">JDBC</a></h2>
<p>The JDBC[1] standard APIs that Java programs can use to connect to database servers. Like Java EE, JDBC is only a set of specifications, and the specific drivers implement its defined APIs. For example, to connect a MySQL server, we shall use <em>mysql:mysql-connector-java</em>; to connect a PostgreSQL server, we shall use <em>org.postgresql:postgresql</em>. Similarly, to use SQLite[2], we shall use <em>org.xerial:sqlite-jdbc</em>:</p>
<pre><code class="language-groovy">implementation 'org.xerial:sqlite-jdbc:3.36.0.3'
</code></pre>
<p>To use JDBC, we must import <code>java.sql.*</code> which defines all APIs. So when it comes to coding, the program looks nearly the same no matter which databases you are connecting to. A noticeable difference is the <em>connection URL</em> parameter:</p>
<blockquote>
<p>static Connection	getConnection​(String url)	
Attempts to establish a connection to the given database URL.</p>
</blockquote>
<p>As for SQLite, neither <em>username</em> nor <em>password</em> is required, the <code>url</code> must start with <code>jdbc:sqlite:</code>, and the path of the database file follows. For example, <code>jdbc:sqlite:/home/zhongpu/Desktop/test.db</code>.</p>
<p>SQL statements are executed and results are returned within the context of <code>Connection</code>. As an illustration, let's write a <code>SELECT</code> statement in Java:</p>
<pre><code class="language-sql">String sql = &quot;SELECT * FROM book&quot;;
try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
    try (ResultSet rs = preparedStatement.executeQuery()) {
        while (rs.next()) {
            System.out.println(&quot;title = &quot; + rs.getString(&quot;title&quot;));
            System.out.println(&quot;price = &quot; + rs.getDouble(&quot;price&quot;));
        }
    }
}
</code></pre>
<p>It may look a bit complicated. But don't worry, because this is perhaps the most difficult Java code when using SQL.</p>
<ul>
<li>Create <code>PreparedStatement</code> by <code>Connection</code>, which is used to execute SQL statements. Note we should care about exceptions and resource management[3]. And luckily, the <em>try-with-resources</em> feature can make it simple.</li>
<li><code>executeQuery()</code> is used because it is a <code>SELECT</code> statement, and it returns <code>ResultSet</code>, representing database result tuples.</li>
<li>As <code>ResultSet</code> is an iterator, we can use <code>next()</code> to traversal from the first row to the last row by moving a cursor. When <code>next()</code> returns false, it means the cursor is positioned after the last row.</li>
<li><code>getXXX()</code> can retrieve the value of the designated column in the current row of this <code>ResultSet</code>[4].</li>
</ul>
<p>Note that we prefer <code>PreparedStatement</code> to <code>Statement</code>[5], and its <code>prepareStatement()</code> can accept SQL statements containing parameter values replaced by &quot;?&quot;. We can use <code>setXXX()</code> method to specify the values for the parameters[6]. To illustrate, we write an <code>INSERT</code> statement:</p>
<pre><code class="language-java">String sql = &quot;INSERT INTO author(name, birth, country) VALUES(?, ?, ?)&quot;;
try (PreparedStatement preparedStatement = connection.prepareStatement(sql)) {
    preparedStatement.setString(1, &quot;Wang Xiaobo&quot;);
    preparedStatement.setString(2, &quot;1952-05-13&quot;);
    preparedStatement.setString(3, &quot;China&quot;);
    preparedStatement.execute();
}
</code></pre>
<p>As for an insertion, we don't have to care about the results, so we can use <code>execute()</code> or <code>executeUpdate()</code>. The complete code can be found at <code>ch6/jdbc</code>. By the way, the Java code for <code>DELETE</code> and <code>UPDATE</code> statements is nearly the same, and it is left as an exercise to readers.</p>
<h2 id="databases-and-java-web"><a class="header" href="#databases-and-java-web">Databases and Java web</a></h2>
<p>Using a database in a Java web project still relies on JDBC, so all knowledge you learned above can be applied in a Java EE application. Recall the example in <a href="ch6/ch4/4.2">Section 4.2</a>. The key points are:</p>
<ul>
<li>The <em>connection URL</em> is stored as an <em>init parameter</em>.</li>
<li>Read the init parameter, and store a <code>Connection</code> in an attribute in <em>context</em> scope.</li>
<li>Process the SQL statements in servlets, and then return the results if necessary.</li>
</ul>
<p>In <code>AppListener.java</code>, the creation of <code>Connection</code> is nearly the same with the code in Java SE, except loading the driver explicitly by <code>Class.forName()</code>. This method is optional in Java SE since JDBC 4.0, but it is required in Java EE.</p>
<pre><code class="language-java">String database = sce.getServletContext().getInitParameter(&quot;database&quot;);
try {
    Class.forName(&quot;org.sqlite.JDBC&quot;);
    Connection conn = DriverManager.getConnection(&quot;jdbc:sqlite:&quot; + database);
    sce.getServletContext().setAttribute(&quot;database&quot;, conn);
} catch (SQLException | ClassNotFoundException e) {
    e.printStackTrace();
}
</code></pre>
<p>In this example, we retrieve all books whose price is greater than a given parameter. Readers can find the complete code in <code>ch6/web-database</code>.</p>
<pre><code class="language-java">String sql = &quot;SELECT title, price FROM book WHERE price &gt; ?&quot;;
</code></pre>
<p>By the way, IntelliJ IDEA supports adding <em>database</em> for the project, and it will greatly boost the convenience of development.</p>
<p><img src="ch6/image/sqlite.png" alt="Figure 6.2 Database in IntelliJ IDEA." title=":size=50%" /></p>
<h2 id="datasource7"><a class="header" href="#datasource7">DataSource[7]</a></h2>
<p>An alternative to the <code>DriverManager</code> facility, a <code>DataSource</code> object is the preferred means of getting a connection. For example, we can easily config <strong>pooled connections</strong>[8] using <code>DataSource</code>. In previous examples, only a single <code>Connection</code> is used in the whole application, and it can be a bottleneck. Connection pools promote the reuse of connection objects and reduce the number of times that connection objects are created. Connection pools significantly improve performance for database-intensive applications because creating connection objects is costly both in terms of time and resources.</p>
<p>In case we are using Tomcat, we need to configure the DataSource as per its <a href="https://tomcat.apache.org/tomcat-9.0-doc/jndi-resources-howto.html">JDNI documentation</a>[9]. The easiest way is to create a <code>META-INF/context.xml</code> in the web content, and fill it with something like:</p>
<pre><code class="language-xml">&lt;Context&gt;
    &lt;Resource
            name=&quot;jdbc/db&quot; type=&quot;javax.sql.DataSource&quot;
            maxActive=&quot;30&quot; maxIdle=&quot;10&quot; maxWait=&quot;10000&quot;
            url=&quot;jdbc:sqlite:/home/zhongpu/github/java-ee-swufe/ch6/test.db&quot;
            driverClassName=&quot;org.sqlite.JDBC&quot;
    /&gt;
&lt;/Context&gt;
</code></pre>
<p>Here, we consider the database as a <em>resource</em>. The complete code can be found at <code>ch6/datasource</code>.Let's discuss the <a href="https://tomcat.apache.org/tomcat-9.0-doc/jdbc-pool.html">DBCP properties</a> briefly[10]:</p>
<ul>
<li><strong>name</strong>: A user defined name to identify this resource.</li>
<li><strong>type</strong>: The resource type. In our example, it is <code>javax.sql.DataSource</code>.</li>
<li><strong>maxActive</strong>: The maximum connections being active.</li>
<li><strong>maxIdle</strong>: The maximum connections being idle.</li>
<li><strong>url</strong>, <strong>driverClassName</strong>: We have used them in the last subsection.</li>
</ul>
<p>Next, add an entry into DD:</p>
<pre><code class="language-xml">&lt;resource-env-ref&gt;
    &lt;resource-env-ref-name&gt;jdbc/db&lt;/resource-env-ref-name&gt;
    &lt;resource-env-ref-type&gt;javax.sql.DataSource&lt;/resource-env-ref-type&gt;
&lt;/resource-env-ref&gt;
</code></pre>
<p>This roughly means that the web application should use the server-provided <em>DataSource</em> with the name <code>jdbc/db</code>.</p>
<p>Back to the Java code, we can use the JNDI to look up this resource:</p>
<pre><code class="language-java">DataSource dataSource = (DataSource) new InitialContext().lookup(&quot;java:comp/env/jdbc/db&quot;);
Connection conn = dataSource.getConnection();
</code></pre>
<p>Here, <code>java:comp/env</code> is the node in the JNDI tree where you can find properties for the current Java EE component. </p>
<p><img src="ch6/image/jndi.png" alt="Figure 6.3 JNDI and DataResource." title=":size=50%" /></p>
<p>We would wish this resource is singleton, and luckily, it is a default option. It means that no matter how many <code>lookup()</code> is called, it returns the same object. In our example, we still add the <code>DataSource</code> into <em>context</em>'s attribute, but it is not required. A good practice is to put <code>DataResource</code> in <em>DBUtil</em> class. </p>
<pre><code class="language-java">public class DBUtil {
    public static DataSource getDataSource() throws NamingException {
        return (DataSource) new InitialContext().lookup(&quot;java:comp/env/jdbc/db&quot;);
    }
}
</code></pre>
<hr />
<p>[1] The term JDBC was originally an abbreviation for <em>Java Database Connectivity</em>, but the full form is no longer used.</p>
<p>[2] SQLite is serverless; it is simply a file.</p>
<p>[3] <em>Connection</em>, <em>PreparedStatement</em>, and <em>ResultSet</em> should be closed to avoid computer resources exhausted.</p>
<p>[4] The API offers many <code>getXXX()</code> methods, such as <code>getInt()</code>, <code>getFloat()</code>, and <code>getDate()</code>.</p>
<p>[5] In general, <code>PreparedStatement</code> runs faster, and it can avoid <em>SQL injection</em>.</p>
<p>[6] Similar to <code>getXXX()</code>, the API offers many <code>setXXX()</code> methods, such as <code>setInt()</code>, <code>setFloat()</code>, and <code>getDate()</code>, where the first parameter is 1, the second is 2.</p>
<p>[7] This subsection is adapted from https://stackoverflow.com/questions/2299469/.</p>
<p>[8] JDBC Connection Pool is also known as <strong>DBCP</strong>.</p>
<p>[9] JNDI short for <em>Java Naming and Directory Interface</em>, allows Java software clients to discover and look up data and resources (in the form of Java objects) via a name.</p>
<p>[10] Tomcat's default DBCP relies on <em>Commons DBCP 2</em> and <em>Commons Pool 2</em> from Apache. We can also use other alternatives, such as <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>, to achieve better performance.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="65-accessing-databases-from-java-2"><a class="header" href="#65-accessing-databases-from-java-2">6.5 Accessing Databases From Java (2)</a></h1>
<p>In this section, we will continue studying how to use database in Java web projects in an idiomatic way. In other words, we will study the best practices used in today's software engineering.</p>
<h2 id="a-real-mvc"><a class="header" href="#a-real-mvc">A real MVC</a></h2>
<p>Does <code>ch6/web-database</code> follow MVC design? The answer is no, because the servlet also takes the responsibility of a <em>model</em>.</p>
<h3 id="version-1"><a class="header" href="#version-1">Version 1</a></h3>
<p>First, let's try to separate the <em>model</em> from the servlet. The idea is straightforward, and it mostly follows the structure in <a href="ch6/ch2/2.4">Section 2.4</a>. The complete code can be found at <code>ch6/mvc1</code>.</p>
<p><code>Recommendation</code> class is the model that accesses the database, and servlet calls it to fetch data from the database:</p>
<pre><code class="language-java">try {
    Recommendation recommendation = new Recommendation();
    double price = 15.0;
    List&lt;Book&gt; books = recommendation.getBooksGEPrice(price);
    request.setAttribute(&quot;books&quot;, books);
    request.getRequestDispatcher(&quot;/WEB-INF/books.jsp&quot;).forward(request, response);
} catch (ClassNotFoundException | SQLException e) {
    e.printStackTrace();
}
</code></pre>
<p>Note that to simplify the code, we don't maintain the <code>Connection</code> in an attribute for reuse, and create a new <em>connection</em> for each request in <code>DBUtil</code> class instead. In production code, we can use <code>DataSource</code> to avoid the performance issue.</p>
<h3 id="version-2"><a class="header" href="#version-2">Version 2</a></h3>
<p>As a matter of fact, there are debates about what the <em>Model</em> is exactly[1].</p>
<blockquote>
<p>[!NOTE]
There is a difference between classical MVC and what we use in web development.</p>
</blockquote>
<p>Recall Fig 2.16, and compare it with the one from the introduction to <a href="https://developer.mozilla.org/en-US/docs/Glossary/MVC">MVC</a> by Mozilla. To implement a classic MVC, <em>Model</em> should inform <em>View</em> about the changes. But it is impossible in a Java web application.</p>
<p><img src="https://developer.mozilla.org/en-US/docs/Glossary/MVC/model-view-controller-light-blue.png" alt="Figure 6.4 MVC by Mozilla." title=":size=50%" /></p>
<p>In many tutorials, <em>Model</em> is considered an entity (POJO) or a Java bean. It is a very common mistake to make. Remember, <strong>the model is not a class or any single object</strong>. In a proper MVC adaptation, <em>Model</em> can include everything in business logic:</p>
<ul>
<li><strong>Domain objects</strong>: They usually represent logical entities (e.g., Java beans), and it is completely unaware of storage.</li>
<li><strong>Data mappers</strong>: These objects are only responsible for the storage. If you store information in a database, this would be where the SQL lives. And they are also known as <strong>DAOs</strong>[2].</li>
<li><strong>Services</strong>: They are responsible for interaction between <em>domain objects</em> and <em>mappers</em> by calling <em>DAO</em>. You can avoid them, but at the penalty of leaking some domain logic into <em>Controllers</em>[3].</li>
</ul>
<p>Nowadays, a typical MVC project of Java web tends to separate <em>Model</em> into three parts above. So <code>Recommendation.java</code> of <code>chp6/mvc1</code> belongs to the <em>DAO</em> layer. By the way, because the domain logic is this example is very simple, <em>service</em> layer is unnecessary. </p>
<p><img src="ch6/image/mvc.png" alt="Figure 6.4 MVC in Java web." title=":size=70%" /></p>
<p>In what follows, we will consider a case that the business logic is more complex than the data logic[4]. For example, suppose the book-selling website offers a 10% discount for books whose price is greater than 20.0 on New Year's Eve. It is true that it can be achieved in <em>DAO</em>, but it would be better to move these logics into <em>service</em>. The complete code can be found at <code>ch6/mvc2</code>, and readers pay attention to code organization and the structure of this project.</p>
<p><img src="ch6/image/code.png" alt="Figure 6.5 Code organization." title=":size=30%" /></p>
<h2 id="orm"><a class="header" href="#orm">ORM</a></h2>
<p>In <em>DAO</em> layer, programmers has to write code for creating objects by fetching data from the database and for storing updated objects back in the database using *SQL. However, such manual conversion between data models is cumbersome and error-prone. For example, if the programmer has a typo in <code>while</code> of <code>BookDao.java</code>, this error won't be detected in the compile time. We shall <em>&quot;title&quot;</em>, rather <em>&quot;name&quot;</em>:</p>
<pre><code class="language-java">while (rs.next()) {
    books.add(new Book(rs.getString(&quot;name&quot;),
            rs.getDouble(&quot;price&quot;)));
}
</code></pre>
<p>One approach to handling this problem is to develop a database that natively stores objects, and allows objects in the database to be accessed in exactly the same way as in-memory objects. However, the pure <em>object-oriented databases</em> did not achieve commercial success.</p>
<p>An alternative approach, called <strong>object-relational mapping</strong> (ORM), is to automate the mapping of data in relation to in-memory objects. In other words, we can access databases in object-oriented programming way. In this book, we use <a href="https://hibernate.org">Hibernate</a>, a widely used system for mapping Java objects to relations[5]. In Hibernate, the mapping from each Java class (i.e., <em>entity</em>) to one or more relations is specified either in a mapping file or by annotations. </p>
<p>Hibernate is able to convert the Java code into SQL dialect, but it does not ship with <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/dialect/Dialect.html">Dialect</a> for SQLite[6]. To illustrate how to use Hibernate, we use another embedded Java SQL database, called <a href="https://www.h2database.com/html/main.html">H2</a>[7]. Again, you can easily switch to other relational databases.</p>
<p>To use <em>Hibernate</em>, we can either select its implementation when creating a new project or add the dependency directly. The complete code can be at <code>ch6/orm</code>.</p>
<p><img src="ch6/image/hibernate.png" alt="Figure 6.6 Code organization." title=":size=50%" /></p>
<pre><code class="language-groovy">implementation('org.hibernate:hibernate-core:5.6.0.Final')
implementation group: 'com.h2database', name: 'h2', version: '2.1.210'
</code></pre>
<ul>
<li><strong>Step 1</strong>: Create an entity class, <code>Book.java</code>. It maps to a relation called <code>book</code>. Note that one attribute (<em>primary key</em>) must be annotated with <code>@Id</code>[8]. Note a non-arg constructor is required.</li>
</ul>
<pre><code class="language-java">@Entity
@Table(name = &quot;book&quot;)
public class Book {
    private String isbn;
    private String title;
    private double price;

    public Book() {

    }

    public Book(String isbn, String title, double price) {
        this.isbn = isbn;
        this.title = title;
        this.price = price;
    }

    @Id
    public String getIsbn() {
        return isbn;
    }

    public void setIsbn(String isbn) {
        this.isbn = isbn;
    }
    // other getters/setters
}
</code></pre>
<ul>
<li><strong>Step 2</strong>: Create a <code>hibernate.cfg.xml</code> under <code>src/main/resources</code>. Of course, you can use other names you like, but we prefer the default one as we can write less code. By the way, since <em>Hibernate</em> is also JPA-compliance, we can also config the ORM with <code>persistence.xml</code>.</li>
</ul>
<pre><code class="language-xml">&lt;hibernate-configuration&gt;

    &lt;session-factory&gt;
        &lt;!-- Database connection settings --&gt;
        &lt;property name=&quot;connection.driver_class&quot;&gt;org.h2.Driver&lt;/property&gt;
        &lt;property name=&quot;connection.url&quot;&gt;jdbc:h2:mem:db1&lt;/property&gt;

        &lt;!-- JDBC connection pool (use the built-in) --&gt;
        &lt;property name=&quot;connection.pool_size&quot;&gt;1&lt;/property&gt;
        &lt;!-- SQL dialect --&gt;
        &lt;property name=&quot;dialect&quot;&gt;org.hibernate.dialect.H2Dialect&lt;/property&gt;
        &lt;!-- Echo all executed SQL to stdout --&gt;
        &lt;property name=&quot;show_sql&quot;&gt;true&lt;/property&gt;

        &lt;!-- Drop and re-create the database schema on startup --&gt;
        &lt;property name=&quot;hbm2ddl.auto&quot;&gt;create&lt;/property&gt;
        &lt;!-- Names the annotated entity class --&gt;
        &lt;mapping class=&quot;com.swufe.javaee.orm.entity.Book&quot;/&gt;
    &lt;/session-factory&gt;

&lt;/hibernate-configuration&gt;
</code></pre>
<ul>
<li><strong>Step 3</strong>: Create a helper class <code>DBUtil.java</code> to generate the <code>SessionFactory</code>.</li>
</ul>
<p>The following is the sample code to add a book to the database:</p>
<pre><code class="language-java">public void addBook(Book book) {
    try (Session session = DBUtil.getSessionFactory().openSession()) {
        session.beginTransaction();
        session.save(book);
        session.getTransaction().commit();
    }
}
</code></pre>
<p>As we can see, we can use <code>Session</code> to access databases, which is more friendly for Java programmers.</p>
<hr />
<p>[1] https://stackoverflow.com/questions/5863870/</p>
<p>[2] DAO, short for <em>Data Access Object</em>, are objects that abstract away the data storage mechanism.</p>
<p>[3] Generally the <em>DAO</em> is as light as possible and exists solely to provide a connection to the DB, sometimes abstracted so different database backends can be used. So it is considered bad to leak domain logic into <em>DAO</em>.</p>
<p>[4] For the sake of flexibility, some people tend to forgive foreign constraints for databases, and these constraints can be specified in the <em>service</em> layer.</p>
<p>[5] Hibernate is more than an ORM, and it supports other useful functionalities, such as full-text search.</p>
<p>[6] We can implement the dialect for SQLite, and some third party libraries (e.g., <a href="https://mvnrepository.com/artifact/com.github.gwenn/sqlite-dialect">SQLite Dialect For Hibernate</a>) has done for us. But it is not recommended doing so.</p>
<p>[7] H2 is mainly used for test.</p>
<p>[8] We ignore the case when the primary key contains composite attributes.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-5"><a class="header" href="#exercise-5">Exercise</a></h1>
<p><strong>6.1</strong>. Consider a <code>university</code> database, it has two relations:</p>
<ul>
<li>department(<ins>dept_name</ins>, building, budget)</li>
<li>instructor(<ins>ID</ins>, name, dept_name, salary)</li>
</ul>
<p>Please write SQL statements to create the two relations.</p>
<hr />
<p><strong>6.2</strong>. Dump some data into <code>university</code> database using <code>INSERT INTO</code> statements.</p>
<hr />
<p><strong>6.3</strong>. Find those departments where the average salary of the instructors is more than 100000.</p>
<hr />
<p><strong>6.4</strong>. Find those departments whose building name includes the substring <em>TongBo</em>.</p>
<hr />
<p><strong>6.5</strong>. Find the names of instructors with salary amounts between 90000 and 100000.</p>
<hr />
<p><strong>6.6</strong>. Please add update and delete statements for <code>Main.java</code> in <code>ch6/jdbc</code>.</p>
<hr />
<p><strong>6.7</strong>. Please refactor <code>ch6/datasource</code> and let it follow MVC design.</p>
<hr />
<p><strong>6.8</strong>. Re-implement the book-selling website using a database.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-7-thymeleaf"><a class="header" href="#chapter-7-thymeleaf">Chapter 7: Thymeleaf</a></h1>
<p><a href="https://www.thymeleaf.org">Thymeleaf</a> is a modern server-side Java template engine for both web and standalone environments. It as a better alternative for JSP. In <a href="ch7/ch5/index">Chapter 5</a>, we have introduced how to use scriptless JSP. But JSP has an obvious pitfall: <strong>we cannot preview it</strong>. In contrast, Thymeleaf is featured for its natural templates. To be specific, HTML that can be correctly displayed in browsers and also work as static prototypes, allowing for stronger collaboration in development teams.</p>
<p>Like JSP and other template engines, Thymeleaf does the work at the server-side. So, the projects which wish to separate front-end and back-end completely, modern front-end frameworks (e.g., Vue and React) are preferred.</p>
<p>In this chapter, we focus on how to Thymeleaf in Java web. Note that the knowledge of JSP is not in vain, because essentially, all template engines work similarly, as shown in Fig 7.1. It takes the data and template as the input, and output the HTML to the client[1]. You can think of it as <code>format()</code> method. The string with a placeholder <code>I am learning %s</code> is the <em>template</em>, and <code>name</code> is the <em>data</em>.</p>
<pre><code class="language-java">String name = &quot;Java Web&quot;;
String result = String.format(&quot;I am learning %s&quot;, name);
</code></pre>
<p><img src="ch7/image/ch7-format.png" alt="Figure 7.1 How a template engine works." title=":size=70%" /></p>
<hr />
<p>[1] Thymeleaf allows you to process six kinds of templates, including <em>HTML</em>, <em>XML</em>, <em>TEXT</em>, <em>JAVASCRIPT</em>, <em>CSS</em> and <em>RAW</em>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="71-get-started-with-thymeleaf"><a class="header" href="#71-get-started-with-thymeleaf">7.1 Get Started With Thymeleaf</a></h1>
<blockquote>
<p>[!NOTE]
This section is mainly adapted from <a href="https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html">Tutorial: Using Thymeleaf</a>. It is highly recommended referring to this tutorial if you have any doubt about how to use Thymeleaf.</p>
</blockquote>
<h2 id="setting-up"><a class="header" href="#setting-up">Setting up</a></h2>
<p>Intellij IDEA offers built-in support for Thymeleaf, and you can also set it up manually. When creating a new project, please make sure <em>Thymeleaf</em> dependency is selected. Then you can delete all JSPs generated in your project.</p>
<p><img src="ch7/image/ch7-idea.png" alt="Figure 7.2 Thymeleaf dependency." title=":size=50%" /></p>
<pre><code class="language-groovy">implementation('org.thymeleaf:thymeleaf:3.0.12.RELEASE')
</code></pre>
<p>To use <code>Thymeleaf</code>, we need a <code>TemplateEngine</code> instance to resolve (i.e., obtain and read) templates. Of course, we also have to specify some important information, including the location and mode of templates, and this is what <code>ITemplateResolver</code> does. For Java EE projects, we use its implementation <code>ServletContextTemplateResolver</code>, and the paths of these resources start at the web application root, and are normally stored inside <code>/WEB-INF</code>.</p>
<pre><code class="language-java">ServletContextTemplateResolver resolver = new ServletContextTemplateResolver(context);
resolver.setPrefix(&quot;/WEB-INF/templates/&quot;);
resolver.setTemplateMode(TemplateMode.HTML);

TemplateEngine engine = new TemplateEngine();
engine.setTemplateResolver(resolver);
</code></pre>
<p>The whole project should share one <code>TemplateEngine</code> instance, so we put the code above into an implementation of <code>ServletContextListener</code>, and then store <code>engine</code> into an attribute in <em>context</em> scope. The complete code can be found at <code>ch7/thymeleaf</code>. Note that we add an extra helper <code>TemplateEngineUtil.java</code> class for the ease of getting this engine, and you can adopt the similar designs for all attributes getters/setters.</p>
<blockquote>
<p>[!NOTE]
Readers can start from the <code>ch7/simple-thymeleaf</code> project to understand how Thymeleaf works.</p>
</blockquote>
<p>Let's see how to pass data into the templates in <code>HelloServlet.java</code>. It is slightly different from the code we saw before:</p>
<pre><code class="language-java">TemplateEngine engine = TemplateEngineUtil.getTemplateEngine(request.getServletContext());
WebContext context = new WebContext(request, response, request.getServletContext());
context.setVariable(&quot;name&quot;, &quot;Java Web&quot;);
engine.process(&quot;home.html&quot;, context, response.getWriter());
</code></pre>
<p>First, we get the <code>TemplateEngine</code> instance from <em>attribute</em> via a helper class. To resolve a template, we use its <code>process()</code> method:</p>
<blockquote>
<p>void process(String, org.thymeleaf.context.IContext, Writer)	
Process the specified template (usually the template name). Output will be written to the specified writer as it is generated from processing the template.</p>
</blockquote>
<p>Its first parameter is the template resource (under <code>WEB-INF/templates</code>). The context will contain the variables that will be available for the execution of expressions inside the template[1]. Because this is Java web project, <code>WebContent</code> is used. The third parameter is also output destination (usually use <code>HttpServletResponse.getWriter()</code>).</p>
<p><img src="ch7/image/ch7-webcontext.png" alt="Figure 7.3 WebContext and TemplateEngine." title=":size=60%" /></p>
<p><code>home.html</code> is a plain HTML page with some special attributes defined by Thymeleaf. Note that <strong>the web browser will ignore the attributes which it cannot recognize</strong>, so we can preview how it looks even if we don't start this web application.</p>
<pre><code class="language-html">&lt;body&gt;
I am learning &lt;span th:text=&quot;${name}&quot;&gt;CS&lt;/span&gt;.
&lt;/body&gt;
</code></pre>
<p><code>th:text</code> is an attribute defined by Thymeleaf, and it is used to display text passed from the template engine. It will display the value of a variable named <code>name</code>; it simply display <em>CS</em> if the template engine don't work or there is no such variable. You can roughly think of <em>variables</em> here as <em>attributes</em> which we have learned in <a href="ch7/ch4/4.2">Section 4.2</a>. The following figure illustrates the mapping of several <em>names</em> showed above.</p>
<p><img src="ch7/image/ch7-names.png" alt="Figure 7.4 Names mapping in HTML templates." title=":size=70%" /></p>
<p><code>${name}</code>, called <strong>variable expressions</strong>, simply means “<em>get the variable called name</em>”, which is one of the <strong>Standard Expressions</strong> offered by Thymeleaf. Similar to <em>attributes</em>, we can put a Java bean into the variable, and use expression <code>${user.name}</code>, which means “<em>get the variable called user, and call its <code>getName()</code> method</em>”.</p>
<pre><code class="language-java">context.setVariable(&quot;user&quot;, new User(&quot;Zhongpu&quot;, 30));
</code></pre>
<p>Standard expression can be of five types:</p>
<ul>
<li><code>${...}</code>: Variable expressions.</li>
<li><code>*{...}</code>: Selection expressions.</li>
<li><code>#{...}</code>: Message (i18n) expressions.</li>
<li><code>@{...}</code>: Link (URL) expressions.</li>
<li><code>~{...}</code>: Fragment expressions.</li>
</ul>
<h2 id="messages"><a class="header" href="#messages">Messages</a></h2>
<p>We have studied how to use <em>variables</em> in Thymeleaf, and now we will learn another standard expression, <strong>message expression</strong>, which is used for internationalization (<code>i18n</code>). A web page shall usually be adapted to different languages for people from different countries. For example, <em>Hello</em> in English, should be adapted to <em>你好</em> in Chinese, or <em>こんにちは</em> in Japanese.</p>
<p>The i18n text in different languages is called <em>externalized text</em>, since it is out of template files, and can be kept in separate files (typically <code>.properties</code> files).</p>
<p>Messages always have a key that identifies them, and Thymeleaf allows you to specify that a text should correspond to a specific message with the <code>#{...}</code> syntax:</p>
<pre><code class="language-html">&lt;h1 th:text=&quot;#{hello}&quot;&gt;你好&lt;/h1&gt;
</code></pre>
<p>So, where is this externalized text? The standard message resolver expects to find messages for template files (<code>.html</code>) in properties files (<code>.properties</code>) in the same folder and with the same name as the template[2]. For example, the template HTML is <code>WEB-INF/templates/home.html</code>, the properties files can be:</p>
<ul>
<li><code>/WEB-INF/templates/home_en.properties</code> for English texts.</li>
<li><code>/WEB-INF/templates/home_ja.properties</code> for Japanese texts.</li>
<li><code>/WEB-INF/templates/home_zh.properties</code> for Chinese tests.</li>
<li><code>/WEB-INF/templates/home.properties</code> for default texts (if the locale is not matched).</li>
</ul>
<p>In IntelliJ IDEA, let's create a <code>Resource Bundle</code> under <code>WEB-INF/templates</code>[3], whose base name is <em>home</em>.</p>
<p><img src="ch7/image/ch7-properties.png" alt="Figure 7.5 Create a Resource Bundle." title=":size=50%" /></p>
<p>Then we can add the needed locale, where <code>en</code> is for English, <code>ja</code> is for Japanese, and <code>zh</code> is for Chinese. Readers can refer to <a href="https://www.science.co.il/language/Locale-codes.php">Locale Codes</a> for more information[4].</p>
<p><img src="ch7/image/ch7-locales.png" alt="Figure 7.6 Add locales." title=":size=40%" /></p>
<p>Let’s have a look at our <code>home_ja.properties</code> file:</p>
<pre><code>hello=こんにちは
</code></pre>
<p>This is all we need for making Thymeleaf process our i18n template, and which language is shown will depend on the web browser's setting.By the way, recall <a href="ch7/ch3/3.3">Section 3.3</a>. It is necessary to set <code>UTF-8</code> for responses multi languages, and let the web-oriented <code>WebContext</code> know your locale by requests' header <code>Accept-Language</code>:</p>
<pre><code class="language-java">WebContext context = new WebContext(request, response, request.getServletContext(), request.getLocale());
response.setCharacterEncoding(&quot;UTF-8&quot;);
</code></pre>
<h2 id="variables-revisited"><a class="header" href="#variables-revisited">Variables revisited</a></h2>
<p><code>${}</code> expressions are in fact OGNL (Object-Graph Navigation Language) expressions executed on the map of variables contained in the context[5].</p>
<p>When using Thymeleaf in a web environment, we can use a series of shortcuts for accessing request parameters, session attributes and application attributes. For example,</p>
<pre><code class="language-java">request.getSession().setAttribute(&quot;foo&quot;, 42);
</code></pre>
<p>We can access this value in a template:</p>
<pre><code class="language-html">${session.foo}
${session.size()}
${session.isEmpty()}
${session.containsKey('foo')}
</code></pre>
<p>Note there is no need to specify a namespace for accessing request attributes (as opposed to <em>request parameters</em>) because all request attributes are automatically added to the context as variables in the context root. For example,</p>
<pre><code class="language-java">request.setAttribute(&quot;bar&quot;, 88);
</code></pre>
<p>And then we can retrieve it by <code>${bar}</code> directly.</p>
<p>We can also add parameters to the message. Just like this:</p>
<pre><code>welcome=Welcome {0}!
</code></pre>
<p>Parameters are specified according to the <a href="https://docs.oracle.com/javase/10/docs/api/java/text/MessageFormat.html">java.text.MessageFormat</a> standard syntax, which means you can format to numbers and dates as specified in the API docs for classes in the <code>java.text.*</code> package.</p>
<p>In order to specify a value for our parameter, and given an HTTP session attribute called <code>user</code>, we could have:</p>
<pre><code class="language-html">&lt;h2 th:text=&quot;#{welcome(${session.user})}&quot;&gt;欢迎用户！&lt;/h2&gt;
</code></pre>
<hr />
<p>[1] This context implementation contains all the required Servlet-API artifacts needed for template execution in web environments, and should be enough for most web-based scenarios of template processing.</p>
<p>[2] The default message resolve is <code>StandardMessageResolver</code>.</p>
<p>[3] Please set the default encoding for properties files to <code>UTF-8</code> in IntelliJ IDEA.</p>
<p>[4] One language may have several branches. For example, <code>zh-cn</code> is for Chinese used in mainland China, and <code>zh-hk</code> is for Chinese used in Hong Kong SAR, China. </p>
<p>[5] You do not need to know every detail about OGNL syntax and features.</p>
<p>[6] See Java Doc API for class <a href="ch7/">org.thymeleaf.context.WebServletContextVariablesMap</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="72-standard-expression-syntax"><a class="header" href="#72-standard-expression-syntax">7.2 Standard Expression Syntax</a></h1>
<p>In this section, we focus on <em>Standard Expression Syntax</em>, including:</p>
<ul>
<li>Expressions on selections (asterisk syntax)</li>
<li>Link URLs</li>
<li>Fragments</li>
</ul>
<h2 id="expressions-on-selections"><a class="header" href="#expressions-on-selections">Expressions on selections</a></h2>
<p>Not only can variable expressions be written as <code>${}</code>, but also as <code>*{}</code>. There is an important difference though: the asterisk syntax evaluates expressions on <em>selected objects</em> rather than on the whole context. That is, as long as there is no selected object, the dollar and the asterisk syntaxes do exactly the same.</p>
<p>And what is a selected object? The result of an expression using the <code>th:object</code> attribute. </p>
<pre><code class="language-html">&lt;div th:object=&quot;${user}&quot;&gt;
    &lt;p&gt;Age: &lt;span th:text=&quot;*{age}&quot;&gt;18&lt;/span&gt;&lt;/p&gt;
    &lt;p&gt;Name: &lt;span th:text=&quot;*{name}&quot;&gt;Bob&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
</code></pre>
<p>Which is exactly equivalent to:</p>
<pre><code class="language-html">&lt;div&gt;
    &lt;p&gt;Age: &lt;span th:text=&quot;${user.age}&quot;&gt;18&lt;/span&gt;&lt;/p&gt;
    &lt;p&gt;Name: &lt;span th:text=&quot;${user.name}&quot;&gt;Bob&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
</code></pre>
<p>By the way, dollar and asterisk syntax can be mixed.</p>
<h2 id="link-urls"><a class="header" href="#link-urls">Link URLs</a></h2>
<p>We did not cover how to represent link URLs in JSPs using JSTL in <a href="ch7/ch5/index">Section 5</a>, although link URLs are very important for websites. For example, every book at Douban can be accessed by a URL, and this is the link for <code>HFBook</code>: https://book.douban.com/subject/3223139/. Here <code>3223139</code> is the <em>ID</em> of <code>HFBook</code>.</p>
<p>There are two types of URLs:</p>
<ul>
<li><em>Absolute URLs</em>: https://book.douban.com/subject/3223139/</li>
<li><em>Relative URLs</em>, which can be:
<ul>
<li>Page relative: user/login.html</li>
<li>Context-relative: /book?id=3 (context name in server will be added automatically)</li>
<li>Server-relative: ~/billing/pay</li>
<li>Protocol-relative URLs: //code.jquery.com/jquery-2.0.3.min.js</li>
</ul>
</li>
</ul>
<p>Thymeleaf provides a special for URL, the <code>@</code> syntax: <code>@{...}</code>. Generally, it may be error-prone to distinguish <em>page relative</em> and <em>context-relative</em>, so we illustrate the difference using an example in the following.</p>
<p>Suppose we are now in the page http://localhost:8080/thymeleaf/, and <code>BookServlet</code> accepts a parameter <code>id</code> and then makes a response of a book:</p>
<pre><code class="language-java">@WebServlet(name = &quot;BookServlet&quot;, value = &quot;/books&quot;)
public class BookServlet extends HttpServlet {
</code></pre>
<p>And we look at how URLs are used in <code>&lt;a&gt;</code>'s <code>href</code> attribute.</p>
<ul>
<li><a th:href="ch7/@{books?id=3}" href="#">@{books?id=3}</a></li>
</ul>
<p>It is a page relative URL, and it would produce <code>books?id=3</code>. By the way, Theymeleaf also provides an elegant way to URL rewriting if cookies are not enabled:</p>
<pre><code class="language-html">&lt;a th:href=&quot;@{books(id=3)}&quot; href=&quot;#&quot;&gt;@{books(id=3)}&lt;/a&gt;
</code></pre>
<p>So we always prefer <code>(...)</code> over <code>?</code> syntax for <code>GET</code> parameters.</p>
<ul>
<li><a th:href="ch7/@{/books(id=3)}" href="#">@{/books(id=3)}</a></li>
</ul>
<p>It is a context relative URL, and it would produce <code>/thymeleaf/books?id=3</code>. And we can also put variables into it:</p>
<pre><code class="language-html">&lt;a th:href=&quot;@{books(id=${bookID})}&quot; href=&quot;#&quot;&gt;@{books(id=${bookID})}&lt;/a&gt;
</code></pre>
<p>But suppose we are now in http://localhost:8080/thymeleaf/test/123. The page relative URL will finally become</p>
<blockquote>
<p>http://localhost:8080/thymeleaf/test/books?id=3</p>
</blockquote>
<p>And it is incorrect. However, the context relative URL will work well.</p>
<h2 id="fragments"><a class="header" href="#fragments">Fragments</a></h2>
<p>It is common that web pages share some components (e.g., <em>header</em>, <em>footer</em> and <em>menu</em>), and we also have learned that <em>include</em> directive in JSP is used to include one file at translation time. Similarly, <code>th:insert</code> and <code>th:replace</code> can be used in this scenario[1].</p>
<p>We create a <code>footer.html</code> under <code>webapp | WEB-INF | templates</code>:</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;
&lt;body&gt;
&lt;div th:fragment=&quot;copy&quot;&gt;
    &amp;copy; 2022 SWUFE
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>And in <code>book.html</code>, we can include this file using <code>~{templatename::selector}</code>:</p>
<pre><code class="language-html">&lt;div th:insert=&quot;~{footer.html :: copy}&quot;&gt;&lt;/div&gt;
</code></pre>
<hr />
<p>[1] <code>th:insert</code> is the simplest: it will simply insert the specified fragment as the body of its host tag; <code>th:replace</code> actually replaces its host tag with the specified fragment.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise-6"><a class="header" href="#exercise-6">Exercise</a></h1>
<p><strong>7.1</strong>. Please use Thymeleaf for <em>views</em> in your book-selling website. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-9-get-started-with-spring"><a class="header" href="#chapter-9-get-started-with-spring">Chapter 9: Get Started With Spring</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="appendix"><a class="header" href="#appendix">Appendix</a></h1>
<p>Appendix presents the full details of downloading and installing softwares on computers.</p>
<ul>
<li><a href="appendix/glassfish.html">GlassFish</a></li>
<li><a href="appendix/idea.html">IntelliJ IDEA</a></li>
<li><a href="appendix/jdk.html">JDK</a></li>
<li><a href="appendix/gradle.html">Gradle</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tomcat"><a class="header" href="#tomcat">Tomcat</a></h1>
<p>The Apache Tomcat® software is an open source implementation of the Jakarta Servlet, Jakarta Server Pages, Jakarta Expression Language, Jakarta WebSocket, Jakarta Annotations and Jakarta Authentication specifications. These specifications are part of the Jakarta EE platform. </p>
<p>There are several ways to install Tomcat on your computer, and it is strongly recommended to download in compressed binary package directly instead of an installation program. </p>
<p><strong>Step 1: Download</strong>. Go to <a href="https://tomcat.apache.org/download-90.cgi">Tomcat 9 Software Downloads</a>, and scroll to <code>Binary Distributions</code>. If you are on Windows, click <code>64-bit Windows zip</code>. If you are on Linux/MacOS, click <code>zip</code> or <code>tar.gz</code>. Then your web browser would download the binary package automatically, and you can save it to any place (e.g., <code>Download</code> folder) you like.</p>
<p><strong>Step 2: Un-compress</strong>. Extract the compressed package to any place you like. By default, the extracted folder is <code>apache-tomcat-9.0.56</code>.</p>
<p>Cool! That is all you need to do. Some tutorials may even ask you to register a service for Tomcat, but it is optional if you don't understand what it is doing. Figure A.1 shows what you will see inside <code>apache-tomcat-9.0.56</code> folder.</p>
<p><img src="appendix/image/tomcat.png" alt="Figure A.1 The contents of Tomcat." title=":size=50%" /></p>
<h2 id="a-note-for-linuxmacos"><a class="header" href="#a-note-for-linuxmacos">A note for Linux/MacOS</a></h2>
<p>If the IntelliJ IDEA raises an error containing &quot;permission denied&quot; when you try to run a web application using Tomcat, it can be fixed by adding <em>execute</em> permission for <code>.sh</code> files under the <code>bin</code> folder of Tomcat home. Open the terminal, change the directory to Tomcat home, and then</p>
<pre><code>chmod u+x bin/*.sh
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="intellij-idea-1"><a class="header" href="#intellij-idea-1">IntelliJ IDEA</a></h1>
<p>IntelliJ IDEA, developed by JetBrains, is an integrated development environment (IDE) written in Java for developing computer software, and it is undoubtedly the top-choice IDE for software developers. It provides two major editions (i.e., Ultimate and Community), and IntelliJ IDEA Ultimate aims for web and enterprise development. Although Ultimate edition is a paid software, it allows students and teachers to apply for <em>free</em> educational licenses. </p>
<p><strong>Step 1: Create a JetBrains account</strong>. Go to https://account.jetbrains.com/login. Although not required, you'd better create an account using your <code>edu</code> email address. </p>
<p><strong>Step 2: Apply for educational licenses</strong>. Go to https://www.jetbrains.com/community/education and click the <code>Apply now</code> button. Then fill in the forms as required. When everything is done, you shall receive an email from JetBrains for verifications.</p>
<p><strong>Step 3: Download and install IntelliJ IDEA Ultimate</strong>. Go to https://www.jetbrains.com/idea/download and download packages according to your own operating system. After downloaded, double click the installer, and then it is fine to always click <code>next</code> and use the default settings. When finished, open the IntelliJ IDEA Ultimate application, and then activate the free access using your JetBrains account created in Step 1.</p>
<p>If all goes well, you shall see the welcome screen of IntelliJ IDEA Ultimate, as depicted in Figure A.2.</p>
<p><img src="appendix/image/welcome.png" alt="Figure A.2 Welcome to IntelliJ IDEA." title=":size=70%" /></p>
<h2 id="how-to-import-project-to-intellij-idea"><a class="header" href="#how-to-import-project-to-intellij-idea">How to import project to IntelliJ IDEA</a></h2>
<p>The sample code of this book in GitHub is managed by <code>Gradle</code>, and here is a quick tutorial of how to import Gradle project to IntelliJ IDEA[1].</p>
<p>Suppose that the project has been downloaded to your computer. Click <em>File | Open</em> at the menu, and then select the upmost folder (e.g., <code>mini-mvc</code>) containing <code>gradlew</code> (or <code>gradlew.bat</code>):</p>
<p><img src="appendix/image/import.png" alt="Figure A.3 Open a project." title=":size=40%" /></p>
<p>It may take a few seconds for the first time since it has to download some dependencies from the remote repository and IntelliJ IDEA has to build index for this imported project. </p>
<p>After importing, we need an extra work to make it runnable. To be specific, click <code>Run | Edit Configurations...</code> in the menu, and then click <code>Add new...</code> in the pop-up <em>Run/Debug Configurations</em> window, select <code>Tomcat Server | Local</code>. Now you will find there is a warning:</p>
<blockquote>
<p>[!WARNING]
Warning: No artifacts marked for deployment</p>
</blockquote>
<p>No worry, click the <code>Fix</code> button.</p>
<p><img src="appendix/image/config.png" alt="Figure A.4 No artifacts warning." title=":size=70%" /></p>
<p>And you can select one of two items in the <em>Select an artifact to deploy</em> pop-up windows.</p>
<p>By the way, the repository in the GitHub, by default, can be only downloaded as a whole as a <code>.zip</code> file[2]. But sometimes, we would like to download a single project. Luckily, there are a few tools created by the community that can do this for you. See more at <a href="https://stackoverflow.com/questions/7106012">Download a single folder or directory from a GitHub repo</a>.</p>
<h2 id="how-to-new-a-servlet"><a class="header" href="#how-to-new-a-servlet">How to new a servlet</a></h2>
<p>Sometimes, you may not find the <code>servlet</code> (and <code>listener</code>) template when trying to new a file in Intellij IDEA, and this is because the <code>src/main/java</code> is not marked as the <em>source root</em>.</p>
<ul>
<li><strong>Step 1</strong>: Click <code>File | Project Structure</code>.</li>
</ul>
<p><img src="appendix/image/file-structure.png" alt="Figure A.5 Project Structure." title=":size=70%" /></p>
<ul>
<li><strong>Step 2</strong>: Make the <code>Source Roots</code> as being marked under <code>Modules | Web Gradle xxx.war</code>.</li>
</ul>
<p><img src="appendix/image/modules.png" alt="Figure A.6 Modules." title=":size=70%" /></p>
<p><img src="appendix/image/roots.png" alt="Figure A.7 Source Roots." title=":size=70%" /></p>
<p>Click <code>OK</code> button. Then, finally, you shall see the <code>servlet</code> template when trying to new file.</p>
<p><img src="appendix/image/servlet.png" alt="Figure A.8 New | Servlet." title=":size=70%" /></p>
<p>Of course, those steps are totally optional, because it is fine to create a plain Java class and then make it extend <code>HttpServlet</code> manually. But creating a servlet from the template can be handy for beginners. </p>
<hr />
<p>[1] Those steps are the same for projects managed by other tools, such as Maven and SBT.</p>
<p>[2] Of course, life would be easier if you get used to <code>git</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="jdk"><a class="header" href="#jdk">JDK</a></h1>
<p>The JDK includes tools for developing and testing programs written in the Java programming language and running on the Java platform. Since we are using <a href="appendix/idea.html">IntelliJ IDEA</a>, it is recommended to get the JDK directly from it.</p>
<p>When creating a project in IntelliJ IDEA, you can choose the target JDK built by different vendors (e.g., Oracle OpenJDK, Amazon Corretto, and Eclipse Temurin) in <code>Project SDK</code> setting by clicking <code>Download JDK</code>.</p>
<p><img src="appendix/image/jdk.png" alt="Figure A.9 Download JDK in IntelliJ IDEA." title=":size=50%" /></p>
<h2 id="install-jdk-manually"><a class="header" href="#install-jdk-manually">Install JDK manually</a></h2>
<p>If you are using UNIX-like platforms (e.g., MacOS and Linux), you'd better to ask <em>package managers</em> for help. See the details in the next part.</p>
<p><strong>Step 1: Download JDK</strong>. Go to the website provided by your target JDK vendor, for example, https://docs.aws.amazon.com/corretto/latest/corretto-17-ug/downloads-list.html, and then download either installer (then go to <em>Step 2(a)</em>) or package (then go to <em>Step 2(b)</em>) that is compatible with your operating system.</p>
<p><strong>Step 2(a): Install JDK</strong>. Double click the installer, and it is fine to always click <code>next</code> and use the default settings.</p>
<p><strong>Step 2(b): Un-compress JDK</strong>. Extract the <code>.tar.gz</code> file to any place you like, and then add an environment variable for <code>JAVA_HOME</code>.</p>
<h2 id="install-jdk-by-package-managers"><a class="header" href="#install-jdk-by-package-managers">Install JDK by package managers</a></h2>
<p>If you would like to download and install preferred JDK without the help of IntelliJ IDEA, package managers (e.g., <code>Homebrew</code> in MacOS, <code>APT</code> in Ubuntu, and <code>Pacman</code> in Manjaro) can alleviate the manual work. Here, we strongly recommend <code>SDKMAN!</code> on UNIX-like platforms.</p>
<p><strong>Step 1: <a href="https://sdkman.io/install">SDKMAN! Installation</a></strong>. Install <code>SDKMAN!</code>. </p>
<pre><code class="language-bash">$ curl -s &quot;https://get.sdkman.io&quot; | bash
$ source &quot;$HOME/.sdkman/bin/sdkman-init.sh&quot;
</code></pre>
<p><strong>Step 2: <a href="https://sdkman.io/jdks">JDK Installation</a></strong>. Install target JDK via <code>SDKMAN!</code>. For example, the following command will install JDK 17 build by Eclipse Adoptium Temurin.</p>
<pre><code class="language-bash">$ sdk install java 17.0.0-tem
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gradle"><a class="header" href="#gradle">Gradle</a></h1>
<blockquote>
<p>Gradle is an open-source build automation tool focused on flexibility and performance. </p>
</blockquote>
<p>Fundamentally, all build systems have a straightforward purpose: they transform the <em>source code</em> written by engineers into <em>executable binaries</em> that can be read by machines. For years, builds had the simple requirements of compiling and packaging soft- ware. But the landscape of modern software development has changed, and so have the needs for build automation. </p>
<p>It is highly recommended reading the <a href="https://docs.gradle.org/current/userguide/userguide.html">Gradle User Manual</a>. In this book, we only focus on one of most important features of Gradle, dependency management.</p>
<h2 id="dependency-management-overview"><a class="header" href="#dependency-management-overview">Dependency management overview</a></h2>
<p>There is a well-known saying in software engineering: <em>Don't reinvent wheels</em>. Nowadays, no one would create a software from scratch, and she must use some third libraries to complete her task without re-writing every line of code on her own. For example, when you want to connect to MySQL, you have to use the database driver as a dependency.</p>
<p>In Java, Maven and Gradle are widely used to help programmers to manage third libraries without manual workload. In this tutorial, we focus on Gradle. Gradle's dependencies are put inside <code>dependencies</code>. For example, in the <code>build.gradle</code> of a template Java EE project:</p>
<pre><code class="language-groovy">dependencies {
    compileOnly('javax.servlet:javax.servlet-api:4.0.1')

    testImplementation(&quot;org.junit.jupiter:junit-jupiter-api:${junitVersion}&quot;)
    testRuntimeOnly(&quot;org.junit.jupiter:junit-jupiter-engine:${junitVersion}&quot;)
}
</code></pre>
<p>Clearly, your Java web project depends on <code>servlet</code> if JDK is compiling your source code. Here we are using the string notation to declare such dependency. Let's try to decouple the long string <code>javax.servlet:javax.servlet-api:4.0.1</code>, which contains three parts:</p>
<ul>
<li><strong>Group name</strong>: <code>javax.servlet</code>. Who develops it.</li>
<li><strong>Artifact name</strong>: <code>javax.servlet-api</code>. What its name is.</li>
<li><strong>Version</strong>: <code>4.0.1</code>. Which version it is.</li>
</ul>
<p>Those three parts (coordinates) can identify a unique package, and then Gradle is able to download this package from remote server. By default, this remote server is <a href="https://search.maven.org/">maven central repository</a>. Alternatively, you can also declare a dependency with map notation:</p>
<pre><code class="language-groovy">compileOnly group: 'javax.servlet', name: 'javax.servlet-api', version: '4.0.1'
</code></pre>
<p>So, what does <code>compileOnly</code> means? Well, <code>compileOnly</code> is one of the dependency <em>scopes</em>. As its name implies, this package is only required during compilation, but not runtime. This is because the container (e.g., Tomcat) will provide necessary dependencies for your web project during runtime. In daily programming, <code>implementation</code> and <code>runtimeOnly</code> are often used[1]. Compared with <code>compileOnly</code>, the main difference can be summarized:</p>
<ul>
<li><code>compileOnly</code>: put the dependency on the <em>compile</em> classpath only</li>
<li><code>runtimeOnly</code>: put the dependency on the <em>runtime</em> classpath only</li>
<li><code>implementation</code>: put the dependency on both classpaths</li>
</ul>
<p>Similarly, both <code>testImplementation</code> and <code>testRuntimeOnly</code> are scopes related with <em>tests</em>.</p>
<h2 id="how-to-find-the-dependency"><a class="header" href="#how-to-find-the-dependency">How to find the dependency</a></h2>
<p>We recommend https://search.maven.org/ and https://mvnrepository.com/. Both websites support searching by group and/or artifact names. For example, if you would like to use <code>Gson</code> in you project to handle JSON, you could get the dependency after a quick searching:</p>
<p><img src="appendix/image/gson.png" alt="Figure A.10 Gson in maven repository." title=":size=50%" /></p>
<p>By the way, in China mainland, there may be some network issues accessing maven central repository. If so, you can use the mirror site of <a href="https://developer.aliyun.com/mvn/guide">AliYun</a> by replacing <code>repositories</code> of <code>build.gradle</code> with the following:</p>
<pre><code class="language-groovy">repositories {
    maven { url 'https://maven.aliyun.com/repository/public/' }
    mavenLocal()
    mavenCentral()
}
</code></pre>
<hr />
<p>[1] <code>provided</code> is deprecated, while <code>api</code> is similar to, but different with <code>implementation</code>. But <code>implementation</code> is the most common in daily programming. See more at <a href="https://stackoverflow.com/questions/44413952/">Gradle Implementation vs API configuration</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sqlite"><a class="header" href="#sqlite">SQLite</a></h1>
<p>SQLite is a relational database management system. In contrast to many other database management systems, SQLite is not a client–server database engine. Rather, it is embedded into the end program.</p>
<p>If you installed <em>Anaconda</em>, a distribution of the Python and R programming languages for scientific computing, then <code>sqlite3</code> is already on your computer. Suppose <code>sqlite3</code> is on the <em>PATH</em>, you can type <code>sqlite3</code> in the terminal to verify:</p>
<pre><code>$ sqlite3
SQLite version 3.36.0 2021-06-18 18:36:39
Enter &quot;.help&quot; for usage hints.
Connected to a transient in-memory database.
Use &quot;.open FILENAME&quot; to reopen on a persistent database.
sqlite&gt; 
</code></pre>
<p>Typing <code>sqlite3</code> without any parameter will launch a transient in-memory database, and you can type either <code>.exit</code> or <code>Ctrl + D</code> to exit the command prompt.</p>
<p>If <code>sqlite3</code> command is not found, then you can download it manually or through a package manager.</p>
<h2 id="install"><a class="header" href="#install">Install</a></h2>
<p>As for Windows, please go to <a href="https://www.sqlite.org/download.html">SQLite Download Page</a>, and download the compressed package under <em>Precompiled Binaries for Windows</em>. As you can see, the binary files for SQLite is very small. Then unpack it to any location you like. That't it! And you can also add it into the <em>PATH</em> environment.</p>
<p><img src="appendix/image/sqlite_download.png" alt="Figure A.11 SQLite download for Windows." title=":size=50%" /></p>
<p>By default, MacOS is bundled with <code>sqlite3</code>. As for Linux, you can download the precompiled binaries (<em>sqlite-tools-linux-x86-xxx.zip</em>) for Linux from <a href="https://www.sqlite.org/download.html">SQLite Download Page</a>. The steps are similar to those we described above.</p>
<h2 id="basic-usages"><a class="header" href="#basic-usages">Basic usages</a></h2>
<p>By default, SQLite will connect to an in-memory database. If you need a persistent one, you can provide a file name.</p>
<pre><code class="language-sh">$ sqlite3 test.db
</code></pre>
<p>If <code>test.db</code> is not found, it will be crated; otherwise, SQLite will connect to it. Note that in SQLite, a database is simply a standalone file. Alternatively, you can type <code>.open test.db</code> if you are already in the SQLite command prompt. <code>.database</code> will display current database, and <code>.table</code> will show tables in this database[1].</p>
<pre><code class="language-sh">sqlite&gt; .database
main: /home/zhongpu/Desktop/test.db r/w
</code></pre>
<p>You can type SQL command directly. For example,</p>
<pre><code class="language-sql">CREATE TABLE foo(
    a TEXT,
    b INTEGER
);
INSERT INTO foo(a, b) VALUES('hello', 42);
SELECT * FROM foo;
</code></pre>
<p><code>.schema</code> command can display the detailed information of a relation:</p>
<pre><code class="language-sh">sqlite&gt; .schema foo
CREATE TABLE foo(
a TEXT,
b INTEGER);
</code></pre>
<p>In general, SQL commands are stored in <code>.sql</code> files, and <code>.read</code> command can read SQL statements or dot-commands from external files.</p>
<pre><code class="language-sh">sqlite&gt; .read test.sql
</code></pre>
<p>More usages can be found at <a href="https://sqlite.org/cli.html">Command Line Shell For SQLite</a>.</p>
<hr />
<p>[1] All commands start with dot (dot-commands) are features of SQLite.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cloud-1"><a class="header" href="#cloud-1">Cloud (1)</a></h1>
<p>We have learned how to make to enable your own computer be a server in <a href="appendix/ch1/1.5.html">Section 1.5</a>. But only the clients within the same inner network can access this website. </p>
<blockquote>
<p>So how can you make your website be accessed by people all over the world? The code remains unchanged, and the only and minimal requirement is a public IP address.</p>
</blockquote>
<p>Nowadays, cloud platforms facilitate the deployment by using a &quot;pay-as-you-go&quot; model, and therefore you do not have to <em>own</em> a physical machine as a server running your website.</p>
<p>Generally speaking, the cloud computing can be Infrastructure as a service (<code>IaaS</code>), Platform as a service (<code>PaaS</code>), or Software as a service (<code>SaaS</code>). The details of them are out of the scope of this book, and we only focus on how to deploy a Java EE project on the cloud. There are many vendors on the market provided by big technology giants, and just to name a few:</p>
<ul>
<li><a href="https://cn.aliyun.com/">Alibaba Cloud</a></li>
<li><a href="https://cloud.tencent.com/">Tencent Cloud</a></li>
<li><a href="https://sae.sinacloud.com/">Sina Cloud</a></li>
<li><a href="https://cloud.google.com/">Google Cloud</a></li>
<li><a href="https://azure.microsoft.com">Microsoft Azure</a></li>
<li><a href="https://aws.amazon.com/">Amazon AWS</a></li>
</ul>
<p>And roughly speaking, you may have two options to use the cloud service:</p>
<ol>
<li>It looks a <em>real</em> machine, and you can nearly do anything on this machine.</li>
<li>It is just an application container, and you can only upload your project onto it.</li>
</ol>
<p>Those two options have their own advantages and pitfalls. For example, the first one provides more flexibility as you have more controls, but it requires that the user must have some extra specialized skills (mainly on <code>Linux</code>). In the contrast, the second one is much simpler, but its functionalities is also limited.</p>
<h2 id="azure"><a class="header" href="#azure">Azure</a></h2>
<p>In this book, we use <a href="https://azure.microsoft.com">Microsoft Azure</a> as the cloud platform to deploy the website, because it provides free access for students. </p>
<blockquote>
<p>[!TIP]
You can go to <a href="https://azure.microsoft.com/zh-cn/free/students/">Azure Students</a> and apply for its free usage via your <code>edu</code> email.</p>
</blockquote>
<p>Azure offers plenty of cloud services, including virtual machines, databases, application services. And here please choose <em>application services</em>, which is like the second option we mentioned above, and one can focus on the project itself even if she does not have much knowledge about command shells.</p>
<blockquote>
<p>[!NOTE]
You shall try out virtual machines if you are curious.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cloud-2"><a class="header" href="#cloud-2">Cloud (2)</a></h1>
<p>In this part, we will talk about how to deploy your website on Azure.</p>
<h2 id="create-a-web-app"><a class="header" href="#create-a-web-app">Create a Web App</a></h2>
<p>To complete the steps in this article, you must have applied for <a href="https://azure.microsoft.com/zh-cn/free/students/">Azure Students</a> successfully.</p>
<ul>
<li><strong>Step 1</strong>: Click the <code>App Services</code> on the <a href="https://portal.azure.com/?quickstart=#home">portal page</a>:</li>
</ul>
<p><img src="appendix/image/azure-app.png" alt="Figure A.12 App Services." title=":size=80%" /></p>
<ul>
<li><strong>Step 2(a)</strong>: Fill in the project details.</li>
</ul>
<p>You have to create a new <code>Resource Group</code>[1] when it is the first time by clicking <code>Create New</code>:</p>
<p><img src="appendix/image/azure-group.png" alt="Figure A.13 Create a new resource group." title=":size=80%" /></p>
<ul>
<li><strong>Step 2(b)</strong>: Fill in the instance details. You can input any name you like as long as there is no conflict[2]. In the writing of this article, we use the name <code>swufe</code>.</li>
</ul>
<p>Other settings: <em>Publish</em> (<code>Code</code>); <em>Runtime stack</em> (<code>Java 11</code>); <em>Java web server stack</em> (<code>Apache Tomcat 9.0</code>); <em>Operating System</em> (<code>Linux</code>). As for <em>Regions</em>, you can select an arbitrary one, but for the sake of Network performance, an East Asia region (e.g., Japan, Korea) would be preferred.</p>
<p>After that, it is fine to always click <code>Next</code> for <em>Deployment</em>, <em>Networking</em>, <em>Monitoring</em>, <em>Tags</em> and use the default values. Finally, click the <code>Create</code> button in the <em>Review + Create</em> tab.</p>
<p>If all goes well, you will see <em>Your deployment is complete</em>:</p>
<p><img src="appendix/image/azure-complete.png" alt="Figure A.13 Your deployment is complete." title=":size=80%" /></p>
<p>And you can also visit the default website through the URL as shown under the <em>Overview</em> tab of this newly created resource.</p>
<h2 id="deployment"><a class="header" href="#deployment">Deployment</a></h2>
<p>In practice, you shall use <code>git</code> to deploy your website, and here we use Azure App Service extension in <a href="https://code.visualstudio.com/">VS Code</a>[3]. So please download and install it if it is on your own computer.</p>
<ul>
<li><strong>Step 1</strong>: Install <em>Azure App Service</em>. Note that <em>Azure Account</em> and <code>Azure Resources</code> will also be installed automatically.</li>
</ul>
<p><img src="appendix/image/azure-vs.png" alt="Figure A.14 Azure App Service." title=":size=40%" /></p>
<ul>
<li><strong>Step 2</strong>: Open a Java EE project in VS Code. Under <code>build | libs</code>, right-click on the WAR file, and then click <code>Deploy to Web App</code>. Then you will be asked to sign in via you account in Azure.</li>
</ul>
<p><img src="appendix/image/azure-deploy.png" alt="Figure A.15 Deploy Azure App." title=":size=40%" /></p>
<p>Repeat the process to click <code>Deploy to Web App</code>, and you will see the created App <code>swufe</code>, and your names should differ from it:</p>
<p><img src="appendix/image/azure-swufe.png" alt="Figure A.16 Select Web App." title=":size=40%" /></p>
<p>After that, you will be asked to configure the port, and you can use <code>80</code>. Cool! Please have a coffee and wait until this deployment process is done:</p>
<p><img src="appendix/image/azure-swufe.png" alt="Figure A.17 Deploying status." title=":size=40%" /></p>
<p>Once the deployment is completed, it will print out the URL for your Web App. Click the link to open it in a browser, you can see the web app running on Azure! </p>
<p><img src="appendix/image/azure-final.png" alt="Figure A.17 Deployment." title=":size=40%" /></p>
<h2 id="custom-domain-name"><a class="header" href="#custom-domain-name">Custom domain name</a></h2>
<p>As we can see, the default URL is <code>http://&lt;appName&gt;.azurewebsites.net/</code>. For example, the URL of this example App is https://swufe.azurewebsites.net/. To flex yourself, you may configure your own custom domain name (e.g., <em>google.com</em>, <em>apple.com.cn</em>, <em>bob.xyz</em>). Curious readers can explore how to set it up.</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-custom-domain">Tutorial: Map an existing custom DNS name to Azure App Service</a></li>
</ul>
<hr />
<p>[1] <code>Resource Group</code> is to help you manage and separate different resources (including apps, networks) in Azure so that you are able to assign then the same permissions.</p>
<p>[2] The name here will be part of the URL (<code>http://&lt;appName&gt;.azurewebsites.net/</code>).</p>
<p>[3] This article is adapted from <a href="https://code.visualstudio.com/docs/java/java-webapp">Java Web Apps with Visual Studio Code</a>. There is also a plugin for IntelliJ IDEA, but it seems that it has some bugs.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>


        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </body>
</html>
